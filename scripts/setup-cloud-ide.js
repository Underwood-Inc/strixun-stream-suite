#!/usr/bin/env node
/**
 * Cloud IDE Setup Script
 * 
 * Creates all required .dev.vars and .env files for cloud IDE environments
 * (CodeSandbox, StackBlitz, etc.) with test mode defaults.
 * 
 * This ensures emails are intercepted (no Resend API calls) and all services
 * work with standard test values.
 */

import { existsSync, writeFileSync, readFileSync, mkdirSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const ROOT_DIR = join(__dirname, '..');

// Standard test values - MUST match across all services
const TEST_VALUES = {
  JWT_SECRET: 'test-jwt-secret-for-local-development-12345678901234567890123456789012',
  NETWORK_INTEGRITY_KEYPHRASE: 'test-integrity-keyphrase-for-integration-tests',
  MODS_ENCRYPTION_KEY: 'strixun_mods_encryption_key_dev_2025_secure_random_64_char_minimum_required_for_pbkdf2_derivation',
  ENVIRONMENT: 'test',
  RESEND_API_KEY: 're_test_key_for_local_development',
  RESEND_FROM_EMAIL: 'test@example.com',
  CUSTOMER_API_URL: 'http://localhost:8790',
  ALLOWED_ORIGINS: '*',
};

/**
 * Create .dev.vars file if it doesn't exist
 */
function createDevVars(filePath, content) {
  if (existsSync(filePath)) {
    console.log(`‚Ñπ  ${filePath} already exists, skipping...`);
    return;
  }
  
  writeFileSync(filePath, content, 'utf-8');
  console.log(`‚úì Created ${filePath}`);
}

/**
 * Create .env file if it doesn't exist
 */
function createEnv(filePath, content) {
  if (existsSync(filePath)) {
    console.log(`‚Ñπ  ${filePath} already exists, skipping...`);
    return;
  }
  
  // Ensure directory exists
  const dir = dirname(filePath);
  if (!existsSync(dir)) {
    mkdirSync(dir, { recursive: true });
  }
  
  writeFileSync(filePath, content, 'utf-8');
  console.log(`‚úì Created ${filePath}`);
}

/**
 * Main setup function
 */
function main() {
  console.log('üöÄ Setting up cloud IDE environment files...\n');

  // 1. OTP Auth Service
  const otpAuthDevVars = join(ROOT_DIR, 'serverless', 'otp-auth-service', '.dev.vars');
  createDevVars(otpAuthDevVars, `# OTP Auth Service - Cloud IDE Test Configuration
# Auto-generated by setup-cloud-ide.js
# Emails are intercepted in test mode (no Resend API calls)

ENVIRONMENT=${TEST_VALUES.ENVIRONMENT}
JWT_SECRET=${TEST_VALUES.JWT_SECRET}
NETWORK_INTEGRITY_KEYPHRASE=${TEST_VALUES.NETWORK_INTEGRITY_KEYPHRASE}
RESEND_API_KEY=${TEST_VALUES.RESEND_API_KEY}
RESEND_FROM_EMAIL=${TEST_VALUES.RESEND_FROM_EMAIL}
ALLOWED_ORIGINS=${TEST_VALUES.ALLOWED_ORIGINS}
SUPER_ADMIN_EMAILS=test@example.com
`);

  // 2. Mods API
  const modsApiDevVars = join(ROOT_DIR, 'serverless', 'mods-api', '.dev.vars');
  createDevVars(modsApiDevVars, `# Mods API - Cloud IDE Test Configuration
# Auto-generated by setup-cloud-ide.js

ENVIRONMENT=${TEST_VALUES.ENVIRONMENT}
JWT_SECRET=${TEST_VALUES.JWT_SECRET}
NETWORK_INTEGRITY_KEYPHRASE=${TEST_VALUES.NETWORK_INTEGRITY_KEYPHRASE}
CUSTOMER_API_URL=${TEST_VALUES.CUSTOMER_API_URL}
ALLOWED_ORIGINS=${TEST_VALUES.ALLOWED_ORIGINS}
MODS_ENCRYPTION_KEY=${TEST_VALUES.MODS_ENCRYPTION_KEY}
`);

  // 3. Customer API
  const customerApiDevVars = join(ROOT_DIR, 'serverless', 'customer-api', '.dev.vars');
  createDevVars(customerApiDevVars, `# Customer API - Cloud IDE Test Configuration
# Auto-generated by setup-cloud-ide.js

ENVIRONMENT=${TEST_VALUES.ENVIRONMENT}
JWT_SECRET=${TEST_VALUES.JWT_SECRET}
NETWORK_INTEGRITY_KEYPHRASE=${TEST_VALUES.NETWORK_INTEGRITY_KEYPHRASE}
`);

  // 4. Mods Hub Frontend
  const modsHubEnv = join(ROOT_DIR, 'mods-hub', '.env');
  createEnv(modsHubEnv, `# Mods Hub - Cloud IDE Test Configuration
# Auto-generated by setup-cloud-ide.js
# Must match MODS_ENCRYPTION_KEY in serverless/mods-api/.dev.vars

VITE_MODS_ENCRYPTION_KEY=${TEST_VALUES.MODS_ENCRYPTION_KEY}
`);

  console.log('\n‚úÖ Cloud IDE setup complete!');
  console.log('\nüìù Created files:');
  console.log('   - serverless/otp-auth-service/.dev.vars');
  console.log('   - serverless/mods-api/.dev.vars');
  console.log('   - serverless/customer-api/.dev.vars');
  console.log('   - mods-hub/.env');
  console.log('\nüöÄ You can now run: pnpm dev:all');
  console.log('\nüí° OTP codes will be intercepted and printed to console (no emails sent)');
}

main();
