# Strixun Stream Suite - Test Manager Workflow
#
# This workflow allows manual testing of multiple services with checkboxes
# Use this for easy manual testing of any combination of services
# Tests are isolated per service to prevent cross-service dependencies
#
# Services with tests:
#   - Root/Client: Svelte component tests
#   - OTP Auth Service: Unit and integration tests
#   - Other services: Placeholder (will skip if no test script)

name: Test Service(s)

on:
  workflow_dispatch:
    inputs:
      test_root:
        description: 'Test Root/Client (Svelte components)'
        type: boolean
        default: true
      test_otp_auth:
        description: 'Test OTP Auth Service'
        type: boolean
        default: true
      test_mods_api:
        description: 'Test Mods API (skip if no tests)'
        type: boolean
        default: false
      test_customer_api:
        description: 'Test Customer API (skip if no tests)'
        type: boolean
        default: false
      test_twitch_api:
        description: 'Test Twitch API (skip if no tests)'
        type: boolean
        default: false
      test_game_api:
        description: 'Test Game API (skip if no tests)'
        type: boolean
        default: false

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read

jobs:
  # Shared setup job for dependency installation
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile

  # Root/Client Tests (Svelte components)
  test_root:
    needs: setup
    if: ${{ inputs.test_root }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Run Root/Client Tests
        working-directory: .
        run: pnpm test
      
      - name: Test Results
        if: always()
        run: |
          echo "## âœ… Root/Client Tests" >> $GITHUB_STEP_SUMMARY
          echo "Svelte component tests completed" >> $GITHUB_STEP_SUMMARY

  # OTP Auth Service Tests
  test_otp_auth:
    needs: setup
    if: ${{ inputs.test_otp_auth }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Run OTP Auth Service Tests
        working-directory: serverless/otp-auth-service
        run: pnpm test
      
      - name: Test Results
        if: always()
        run: |
          echo "## âœ… OTP Auth Service Tests" >> $GITHUB_STEP_SUMMARY
          echo "Unit and integration tests completed" >> $GITHUB_STEP_SUMMARY

  # Mods API Tests (skip if no test script)
  test_mods_api:
    needs: setup
    if: ${{ inputs.test_mods_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/mods-api
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Mods API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/mods-api
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: |
          echo "âš ï¸ No test script found in Mods API - skipping tests"
          echo "## âš ï¸ Mods API Tests" >> $GITHUB_STEP_SUMMARY
          echo "No test script found - skipped" >> $GITHUB_STEP_SUMMARY

  # Customer API Tests (skip if no test script)
  test_customer_api:
    needs: setup
    if: ${{ inputs.test_customer_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/customer-api
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Customer API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/customer-api
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: |
          echo "âš ï¸ No test script found in Customer API - skipping tests"
          echo "## âš ï¸ Customer API Tests" >> $GITHUB_STEP_SUMMARY
          echo "No test script found - skipped" >> $GITHUB_STEP_SUMMARY

  # Twitch API Tests (skip if no test script)
  test_twitch_api:
    needs: setup
    if: ${{ inputs.test_twitch_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/twitch-api
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Twitch API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/twitch-api
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: |
          echo "âš ï¸ No test script found in Twitch API - skipping tests"
          echo "## âš ï¸ Twitch API Tests" >> $GITHUB_STEP_SUMMARY
          echo "No test script found - skipped" >> $GITHUB_STEP_SUMMARY

  # Game API Tests (skip if no test script)
  test_game_api:
    needs: setup
    if: ${{ inputs.test_game_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/game-api
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Game API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/game-api
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: |
          echo "âš ï¸ No test script found in Game API - skipping tests"
          echo "## âš ï¸ Game API Tests" >> $GITHUB_STEP_SUMMARY
          echo "No test script found - skipped" >> $GITHUB_STEP_SUMMARY

  # Test Summary
  summary:
    needs: [test_root, test_otp_auth, test_mods_api, test_customer_api, test_twitch_api, test_game_api]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Test Summary
        run: |
          echo "## ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.test_root }}" == "true" ]; then
            if [ "${{ needs.test_root.result }}" == "success" ]; then
              echo "âœ… **Root/Client** - Tests Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_root.result }}" == "failure" ]; then
              echo "âŒ **Root/Client** - Tests Failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Root/Client** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.test_otp_auth }}" == "true" ]; then
            if [ "${{ needs.test_otp_auth.result }}" == "success" ]; then
              echo "âœ… **OTP Auth Service** - Tests Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_otp_auth.result }}" == "failure" ]; then
              echo "âŒ **OTP Auth Service** - Tests Failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **OTP Auth Service** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.test_mods_api }}" == "true" ]; then
            if [ "${{ needs.test_mods_api.result }}" == "success" ] || [ "${{ needs.test_mods_api.result }}" == "skipped" ]; then
              echo "âœ… **Mods API** - Tests Passed or Skipped (no tests)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_mods_api.result }}" == "failure" ]; then
              echo "âŒ **Mods API** - Tests Failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Mods API** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.test_customer_api }}" == "true" ]; then
            if [ "${{ needs.test_customer_api.result }}" == "success" ] || [ "${{ needs.test_customer_api.result }}" == "skipped" ]; then
              echo "âœ… **Customer API** - Tests Passed or Skipped (no tests)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_customer_api.result }}" == "failure" ]; then
              echo "âŒ **Customer API** - Tests Failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Customer API** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.test_twitch_api }}" == "true" ]; then
            if [ "${{ needs.test_twitch_api.result }}" == "success" ] || [ "${{ needs.test_twitch_api.result }}" == "skipped" ]; then
              echo "âœ… **Twitch API** - Tests Passed or Skipped (no tests)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_twitch_api.result }}" == "failure" ]; then
              echo "âŒ **Twitch API** - Tests Failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Twitch API** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.test_game_api }}" == "true" ]; then
            if [ "${{ needs.test_game_api.result }}" == "success" ] || [ "${{ needs.test_game_api.result }}" == "skipped" ]; then
              echo "âœ… **Game API** - Tests Passed or Skipped (no tests)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_game_api.result }}" == "failure" ]; then
              echo "âŒ **Game API** - Tests Failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Game API** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Services without test scripts are automatically skipped." >> $GITHUB_STEP_SUMMARY

