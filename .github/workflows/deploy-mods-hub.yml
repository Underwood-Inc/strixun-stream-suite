# Strixun Stream Suite - Deploy Mods Hub to Cloudflare Pages
#
# This workflow deploys the Mods Hub React frontend to Cloudflare Pages
# The Mods Hub will be available at the custom domain configured in Cloudflare Dashboard

name: Deploy Mods Hub to Cloudflare Pages

on:
  push:
    branches: [main, master]
    paths:
      - 'mods-hub/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

# Allow only one concurrent deployment
concurrency:
  group: "pages-mods-hub"
  cancel-in-progress: false

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read

jobs:
  # Test job - required before deployment
  test:
    runs-on: ubuntu-latest
    name: Test Root/Client
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Run Root/Client Tests
        working-directory: .
        env:
          NODE_ENV: test
        run: pnpm test
      
      - name: Generate coverage report
        working-directory: .
        env:
          NODE_ENV: test
        run: pnpm test:coverage
        continue-on-error: true
      
      - name: Annotate coverage
        if: always()
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            node scripts/annotate-coverage.js coverage/coverage-summary.json . "Root/Client"
          else
            echo "::warning::Root/Client coverage summary not found - skipping annotations"
          fi
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage/coverage-final.json
          flags: root-client
          name: root-client-coverage
          fail_ci_if_error: false
        continue-on-error: true
      
      - name: Display coverage summary
        if: always()
        continue-on-error: true
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -e "const data = require('./coverage/coverage-summary.json'); const total = data.total.lines.pct; console.log(total);")
            echo "Coverage: $COVERAGE%"
            echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "**Total Coverage:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found (this is informational only)"
          fi

  build:
    needs: test
    if: needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
          
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build workspace dependencies
        working-directory: .
        run: |
          echo "Building workspace dependencies required for mods-hub..."
          # Build shared types first (no dependencies)
          echo "  -> Building @strixun/types..."
          pnpm --filter "@strixun/types" run build || echo "  i  Types has no build script (skipped)"
          # Build service-client (depends on types)
          echo "  -> Building @strixun/service-client..."
          pnpm --filter "@strixun/service-client" run build || echo "  i  Service Client has no build script (skipped)"
          # Build API Framework (depends on types and service-client)
          echo "  -> Building @strixun/api-framework..."
          pnpm --filter "@strixun/api-framework" run build || echo "  i  API Framework has no build script (skipped)"
          # Build Auth Store (depends on api-framework)
          echo "  -> Building @strixun/auth-store..."
          pnpm --filter "@strixun/auth-store" run build || echo "  i  Auth Store has no build script (skipped)"
          # Build OTP Login (required for mods-hub login page)
          echo "  -> Building @strixun/otp-login..."
          pnpm --filter "@strixun/otp-login" run build:react || (echo "!  OTP Login build failed or skipped" && exit 1)
          # Build Dice Board Game (required for mods-hub admin panel)
          echo "  -> Building @strixun/dice-board-game..."
          pnpm --filter "@strixun/dice-board-game" run build || (echo "!  Dice Board Game build failed or skipped" && exit 1)
          echo "* All workspace dependencies built successfully"
      
      - name: Build Mods Hub
        working-directory: mods-hub
        env:
          VITE_MODS_API_URL: ${{ secrets.VITE_MODS_API_URL || 'https://mods-api.idling.app' }}
          VITE_AUTH_API_URL: ${{ secrets.VITE_AUTH_API_URL || 'https://auth.idling.app' }}
          VITE_CUSTOMER_API_URL: ${{ secrets.VITE_CUSTOMER_API_URL || 'https://customer-api.idling.app' }}
          VITE_MODS_ENCRYPTION_KEY: ${{ secrets.MODS_ENCRYPTION_KEY }}
        run: |
          # Validate that MODS_ENCRYPTION_KEY is set (required for file encryption)
          if [ -z "$VITE_MODS_ENCRYPTION_KEY" ]; then
            echo "âœ— ERROR: MODS_ENCRYPTION_KEY secret is not set in GitHub Secrets!"
            echo "Please add MODS_ENCRYPTION_KEY to your GitHub repository secrets."
            echo "This key must match the MODS_ENCRYPTION_KEY in the mods-api worker."
            exit 1
          fi
          
          # Verify key length (should be at least 32 characters)
          if [ ${#VITE_MODS_ENCRYPTION_KEY} -lt 32 ]; then
            echo "âœ— ERROR: MODS_ENCRYPTION_KEY is too short (must be at least 32 characters)"
            exit 1
          fi
          
          echo "âœ“ MODS_ENCRYPTION_KEY is configured (length: ${#VITE_MODS_ENCRYPTION_KEY} characters)"
          pnpm run build
          
          # Verify the key was embedded in the build (check that VITE_MODS_ENCRYPTION_KEY is referenced)
          # Note: We check for the env var name, not the actual value, to avoid exposing secrets
          echo "ðŸ” Verifying encryption key was embedded in build..."
          if grep -r "VITE_MODS_ENCRYPTION_KEY" ../dist/mods-hub/assets/*.js 2>/dev/null | head -1 > /dev/null; then
            echo "âœ“ Encryption key reference found in build output"
          else
            echo "âš   WARNING: Encryption key reference not found in build - key may not be embedded"
            echo "This could indicate the build didn't include the environment variable"
          fi
        
      - name: Deploy to Cloudflare Pages
        id: deploy
        working-directory: mods-hub
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          # Create project if it doesn't exist (with production branch), then deploy
          # Project name matches the directory for consistency
          # Suppress error output if project already exists (this is expected and harmless)
          pnpm exec wrangler pages project create mods-hub --production-branch=main 2>/dev/null || echo "Project already exists, continuing with deployment..."
          
          # Deploy with explicit compatibility flags for Functions
          # Build outputs to ../dist/mods-hub (relative to mods-hub directory)
          echo "Deploying to Cloudflare Pages with Functions..."
          
          # Try deployment with Functions first
          if pnpm exec wrangler pages deploy ../dist/mods-hub \
            --project-name=mods-hub \
            --branch=main \
            --commit-dirty=true; then
            echo "* Deployment with Functions succeeded!"
          else
            echo "! Deployment with Functions failed. Checking for Functions directory..."
            
            # If Functions directory exists, try moving it and deploy without it
            if [ -d "../dist/mods-hub/functions" ]; then
              echo "! Functions directory found. Moving it aside and retrying deployment..."
              mv ../dist/mods-hub/functions ../dist/mods-hub/functions.backup
              
              echo "Retrying deployment without Functions..."
              pnpm exec wrangler pages deploy ../dist/mods-hub \
                --project-name=mods-hub \
                --branch=main \
                --commit-dirty=true
              
              echo "! WARNING: Deployment succeeded WITHOUT Functions!"
              echo "! Social media meta tag injection will NOT work!"
              echo "! Please investigate the Functions compilation issue."
            else
              echo "âœ— No Functions directory found, re-throwing error..."
              exit 1
            fi
          fi
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
        
      - name: Deployment Summary
        run: |
          echo "## ðŸŽ® Mods Hub Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Mods Hub frontend has been deployed to Cloudflare Pages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** \`https://mods.idling.app\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— API Endpoints:" >> $GITHUB_STEP_SUMMARY
          echo "- Mods API: \`https://mods-api.idling.app\`" >> $GITHUB_STEP_SUMMARY
          echo "- Auth API: \`https://auth.idling.app\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Encryption Key Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CRITICAL:** The \`MODS_ENCRYPTION_KEY\` GitHub secret must:" >> $GITHUB_STEP_SUMMARY
          echo "1. Exist in GitHub repository secrets" >> $GITHUB_STEP_SUMMARY
          echo "2. Match the \`MODS_ENCRYPTION_KEY\` secret in the mods-api Cloudflare Worker" >> $GITHUB_STEP_SUMMARY
          echo "3. Be at least 32 characters long" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If mod uploads fail with 'MODS_ENCRYPTION_KEY is required', check:" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Secrets: Settings â†’ Secrets and variables â†’ Actions â†’ \`MODS_ENCRYPTION_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "- Cloudflare Worker: Workers & Pages â†’ mods-api â†’ Settings â†’ Secrets â†’ \`MODS_ENCRYPTION_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify \`MODS_ENCRYPTION_KEY\` exists in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify it matches the mods-api worker secret" >> $GITHUB_STEP_SUMMARY
          echo "3. **Test mod upload** to verify encryption keys are synchronized" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ The Mods Hub is deployed to Cloudflare Pages. Access it via your custom domain." >> $GITHUB_STEP_SUMMARY

