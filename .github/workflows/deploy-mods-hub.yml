# Strixun Stream Suite - Deploy Mods Hub to Cloudflare Pages
#
# This workflow deploys the Mods Hub React frontend to Cloudflare Pages
# The Mods Hub will be available at the custom domain configured in Cloudflare Dashboard

name: Deploy Mods Hub to Cloudflare Pages

on:
  push:
    branches: [main, master]
    paths:
      - 'mods-hub/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

# Allow only one concurrent deployment
concurrency:
  group: "pages-mods-hub"
  cancel-in-progress: false

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read

jobs:
  # Test job - required before deployment
  test:
    runs-on: ubuntu-latest
    name: Test Root/Client
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Run Root/Client Tests
        working-directory: .
        env:
          NODE_ENV: test
        run: pnpm test
      
      - name: Generate coverage report
        working-directory: .
        env:
          NODE_ENV: test
        run: pnpm test:coverage
        continue-on-error: true
      
      - name: Annotate coverage
        if: always()
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            node scripts/annotate-coverage.js coverage/coverage-summary.json . "Root/Client"
          else
            echo "::warning::Root/Client coverage summary not found - skipping annotations"
          fi
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage/coverage-final.json
          flags: root-client
          name: root-client-coverage
          fail_ci_if_error: false
        continue-on-error: true
      
      - name: Display coverage summary
        if: always()
        continue-on-error: true
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -e "const data = require('./coverage/coverage-summary.json'); const total = data.total.lines.pct; console.log(total);")
            echo "Coverage: $COVERAGE%"
            echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "**Total Coverage:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found (this is informational only)"
          fi

  build:
    needs: test
    if: needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
          
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build workspace dependencies
        working-directory: .
        run: |
          echo "ðŸ”¨ Building workspace dependencies required for mods-hub..."
          # Build OTP Login (required for mods-hub login page)
          echo "  â†’ Building @strixun/otp-login..."
          pnpm --filter "@strixun/otp-login" run build:react || (echo "âš ï¸  OTP Login build failed or skipped" && exit 1)
          # Build Dice Board Game (required for mods-hub admin panel)
          echo "  â†’ Building @strixun/dice-board-game..."
          pnpm --filter "@strixun/dice-board-game" run build || (echo "âš ï¸  Dice Board Game build failed or skipped" && exit 1)
          # Build API Framework (if it has a build script)
          echo "  â†’ Building @strixun/api-framework (if needed)..."
          pnpm --filter "@strixun/api-framework" run build || echo "  â„¹ï¸  API Framework has no build script (skipped)"
          echo "âœ… All workspace dependencies built successfully"
      
      - name: Verify OTP Encryption Key
        env:
          OTP_KEY: ${{ secrets.VITE_SERVICE_ENCRYPTION_KEY }}
        run: |
          if [ -z "$OTP_KEY" ]; then
            echo "âŒ ERROR: VITE_SERVICE_ENCRYPTION_KEY secret is not set in GitHub Secrets!"
            echo ""
            echo "To fix this:"
            echo "1. Go to Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: VITE_SERVICE_ENCRYPTION_KEY"
            echo "4. Value: Your SERVICE_ENCRYPTION_KEY (same as Cloudflare Workers secret)"
            echo "5. Click 'Add secret'"
            echo ""
            exit 1
          fi
          KEY_LENGTH=${#OTP_KEY}
          if [ $KEY_LENGTH -lt 32 ]; then
            echo "âŒ ERROR: VITE_SERVICE_ENCRYPTION_KEY is too short (must be at least 32 characters)"
            echo "Current length: $KEY_LENGTH"
            exit 1
          fi
          echo "âœ… VITE_SERVICE_ENCRYPTION_KEY is set (length: $KEY_LENGTH characters)"
          echo ""
          echo "âš ï¸  CRITICAL: This key MUST match the SERVICE_ENCRYPTION_KEY secret in Cloudflare Workers"
          echo "   - Frontend encrypts with: VITE_SERVICE_ENCRYPTION_KEY (GitHub secret)"
          echo "   - Backend decrypts with: SERVICE_ENCRYPTION_KEY (Cloudflare secret)"
          echo "   - If they don't match, mod uploads will fail with 'Decryption Failed' error"
          echo "   - Verify both secrets are synchronized before deployment"
          echo ""
        
      - name: Build Mods Hub
        working-directory: mods-hub
        env:
          VITE_MODS_API_URL: ${{ secrets.VITE_MODS_API_URL || 'https://mods-api.idling.app' }}
          VITE_AUTH_API_URL: ${{ secrets.VITE_AUTH_API_URL || 'https://auth.idling.app' }}
          VITE_SERVICE_ENCRYPTION_KEY: ${{ secrets.VITE_SERVICE_ENCRYPTION_KEY }}
        run: pnpm run build
        
      - name: Deploy to Cloudflare Pages
        id: deploy
        working-directory: mods-hub
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          # Create project if it doesn't exist (with production branch), then deploy
          # Project name matches the directory for consistency
          # Suppress error output if project already exists (this is expected and harmless)
          pnpm exec wrangler pages project create mods-hub --production-branch=main 2>/dev/null || echo "Project already exists, continuing with deployment..."
          pnpm exec wrangler pages deploy dist --project-name=mods-hub --branch=main
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
        
      - name: Deployment Summary
        run: |
          echo "## ðŸŽ® Mods Hub Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Mods Hub frontend has been deployed to Cloudflare Pages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** \`https://mods.idling.app\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— API Endpoints:" >> $GITHUB_STEP_SUMMARY
          echo "- Mods API: \`https://mods-api.idling.app\`" >> $GITHUB_STEP_SUMMARY
          echo "- Auth API: \`https://auth.idling.app\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸  Encryption Key Verification:" >> $GITHUB_STEP_SUMMARY
          echo "**CRITICAL**: Verify that \`VITE_SERVICE_ENCRYPTION_KEY\` (GitHub secret) matches \`SERVICE_ENCRYPTION_KEY\` (Cloudflare secret)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If keys don't match, mod uploads will fail with 'Decryption Failed' error." >> $GITHUB_STEP_SUMMARY
          echo "See \`mods-hub/PRODUCTION_ENCRYPTION_KEY_FIX.md\` for troubleshooting." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure custom domain in Cloudflare Dashboard (if not already done)" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify DNS CNAME record is created" >> $GITHUB_STEP_SUMMARY
          echo "3. Wait for SSL certificate provisioning (usually 1-5 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "4. **Test mod upload** to verify encryption keys are synchronized" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ The Mods Hub is deployed to Cloudflare Pages. Access it via your custom domain." >> $GITHUB_STEP_SUMMARY

