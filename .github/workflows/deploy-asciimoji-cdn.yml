# Strixun Stream Suite - Deploy ASCIImoji CDN
#
# This workflow builds and deploys the ASCIImoji package to GitHub Pages as a CDN.
# The CDN will be available at:
#   https://{username}.github.io/{repo}/packages/asciimoji/dist/js/index.min.js
#   Or via jsDelivr: https://cdn.jsdelivr.net/gh/{owner}/{repo}@main/packages/asciimoji/dist/js/index.min.js
#
# No secrets needed for static hosting, but you'll need to:
# 1. Enable GitHub Pages in repo Settings > Pages
# 2. Set source to "GitHub Actions"

name: Deploy ASCIImoji CDN

on:
  push:
    branches: [main, master]
    paths:
      - 'packages/asciimoji/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

# Allow only one concurrent deployment
concurrency:
  group: "asciimoji-cdn"
  cancel-in-progress: false

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Test job - required before deployment
  test:
    runs-on: ubuntu-latest
    name: Test ASCIImoji Package
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Run Unit Tests
        working-directory: packages/asciimoji
        run: pnpm test
        continue-on-error: false
      
      - name: Generate Unit Test Coverage
        working-directory: packages/asciimoji
        run: pnpm test:coverage
        continue-on-error: true
      
      - name: Upload Unit Test Coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./packages/asciimoji/coverage/coverage-final.json
          flags: asciimoji-unit
          name: asciimoji-unit-coverage
          fail_ci_if_error: false
        continue-on-error: true
      
      - name: Run E2E Tests
        working-directory: .
        run: pnpm test:e2e packages/asciimoji/asciimoji.e2e.spec.ts
        continue-on-error: false
      
      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asciimoji-playwright-report
          path: playwright-report/
          retention-days: 30
        continue-on-error: true
      
      - name: Upload E2E Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asciimoji-playwright-screenshots
          path: test-results/
          retention-days: 7
        continue-on-error: true
      
      - name: Test Results Summary
        if: always()
        run: |
          echo "## ASCIImoji Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ -f "packages/asciimoji/coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -e "const data = require('./packages/asciimoji/coverage/coverage-summary.json'); const total = data.total.lines.pct; console.log(total);")
            echo "- Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### E2E Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test file: \`packages/asciimoji/asciimoji.e2e.spec.ts\`" >> $GITHUB_STEP_SUMMARY
          echo "- Total patterns: 153" >> $GITHUB_STEP_SUMMARY

  build:
    needs: test
    if: needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build ASCIImoji Package
        working-directory: packages/asciimoji
        run: pnpm build
      
      - name: Verify Build Output
        working-directory: packages/asciimoji
        run: |
          echo "[INFO] Verifying build output..."
          
          if [ ! -f "dist/js/index.js" ]; then
            echo "âŒ ERROR: dist/js/index.js not found"
            exit 1
          fi
          
          if [ ! -f "dist/js/index.min.js" ]; then
            echo "âŒ ERROR: dist/js/index.min.js not found"
            exit 1
          fi
          
          if [ ! -f "dist/js/index.esm.js" ]; then
            echo "âŒ ERROR: dist/js/index.esm.js not found"
            exit 1
          fi
          
          # Check file sizes
          DEV_SIZE=$(stat -f%z dist/js/index.js 2>/dev/null || stat -c%s dist/js/index.js 2>/dev/null)
          MIN_SIZE=$(stat -f%z dist/js/index.min.js 2>/dev/null || stat -c%s dist/js/index.min.js 2>/dev/null)
          
          echo "âœ… Build output verified:"
          echo "   - Development bundle: $(numfmt --to=iec-i --suffix=B $DEV_SIZE 2>/dev/null || echo "${DEV_SIZE} bytes")"
          echo "   - Production bundle: $(numfmt --to=iec-i --suffix=B $MIN_SIZE 2>/dev/null || echo "${MIN_SIZE} bytes")"
          
          # Verify bundle contains expected exports
          if ! grep -q "AsciimojiTransformer" dist/js/index.min.js; then
            echo "âš ï¸  WARNING: AsciimojiTransformer not found in minified bundle"
          fi
          
          if ! grep -q "transformAsciimojiText" dist/js/index.min.js; then
            echo "âš ï¸  WARNING: transformAsciimojiText not found in minified bundle"
          fi
      
      - name: Create CDN Directory Structure
        run: |
          # Create a clean CDN directory
          mkdir -p cdn-dist/packages/asciimoji/dist/js
          
          # Copy built files
          cp packages/asciimoji/dist/js/*.js cdn-dist/packages/asciimoji/dist/js/
          cp packages/asciimoji/dist/js/*.js.map cdn-dist/packages/asciimoji/dist/js/ 2>/dev/null || true
          
          # Create version info file
          VERSION=$(node -p "require('./packages/asciimoji/package.json').version")
          echo "{\"version\":\"$VERSION\",\"buildDate\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"patterns\":153}" > cdn-dist/packages/asciimoji/dist/js/version.json
          
          # Create README for CDN
          cat > cdn-dist/packages/asciimoji/dist/js/README.md << 'EOF'
          # ASCIImoji CDN Files
          
          ## Available Files
          
          - `index.js` - Development bundle (IIFE, unminified, with source maps)
          - `index.min.js` - Production bundle (IIFE, minified)
          - `index.esm.js` - ESM bundle (for modern bundlers)
          - `version.json` - Version and build information
          
          ## Usage
          
          ### Via GitHub Pages
          ```html
          <script src="https://{username}.github.io/{repo}/packages/asciimoji/dist/js/index.min.js"></script>
          ```
          
          ### Via jsDelivr
          ```html
          <script src="https://cdn.jsdelivr.net/gh/{owner}/{repo}@main/packages/asciimoji/dist/js/index.min.js"></script>
          ```
          
          See the [CDN Usage Guide](../../../CDN_USAGE.md) for more information.
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        id: upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'cdn-dist'
      
      - name: Build Summary
        run: |
          VERSION=$(node -p "require('./packages/asciimoji/package.json').version")
          echo "## ASCIImoji CDN Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Patterns:** 153" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Development bundle: \`index.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- Production bundle: \`index.min.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- ESM bundle: \`index.esm.js\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Deployment Summary
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          VERSION=$(node -p "require('./packages/asciimoji/package.json').version" 2>/dev/null || echo "unknown")
          
          echo "## ðŸŒ ASCIImoji CDN Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CDN Base URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CDN Routes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### GitHub Pages:" >> $GITHUB_STEP_SUMMARY
          echo "- Production: \`${{ steps.deployment.outputs.page_url }}packages/asciimoji/dist/js/index.min.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- Development: \`${{ steps.deployment.outputs.page_url }}packages/asciimoji/dist/js/index.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- ESM: \`${{ steps.deployment.outputs.page_url }}packages/asciimoji/dist/js/index.esm.js\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### jsDelivr (Alternative):" >> $GITHUB_STEP_SUMMARY
          echo "- Production: \`https://cdn.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@main/packages/asciimoji/dist/js/index.min.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- Development: \`https://cdn.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@main/packages/asciimoji/dist/js/index.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- ESM: \`https://cdn.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@main/packages/asciimoji/dist/js/index.esm.js\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage Example" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`html" >> $GITHUB_STEP_SUMMARY
          echo "<script src=\"${{ steps.deployment.outputs.page_url }}packages/asciimoji/dist/js/index.min.js\"></script>" >> $GITHUB_STEP_SUMMARY
          echo "<script>" >> $GITHUB_STEP_SUMMARY
          echo "  AsciimojiTransformer.init({ selector: 'body' });" >> $GITHUB_STEP_SUMMARY
          echo "</script>" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION | **Patterns:** 153" >> $GITHUB_STEP_SUMMARY
