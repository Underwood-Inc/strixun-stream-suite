name: Deploy Chat Signaling API

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'serverless/chat-signaling/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test Chat Signaling API
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/chat-signaling
        run: |
          if [ -f "vitest.config.ts" ] || [ -f "vitest.config.js" ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          elif grep -q '"test"' package.json && ! grep -q 'Error: no test specified' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Chat Signaling API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/chat-signaling
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: pnpm run build:deps && pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: |
          echo "â­ï¸ No test script found in Chat Signaling API - skipping tests"

  deploy:
    needs: test
    if: needs.test.result == 'success' || needs.test.result == 'skipped'
    runs-on: ubuntu-latest
    name: Build and Deploy Chat Signaling API
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Worker
        working-directory: serverless/chat-signaling
        run: pnpm run build:deps && pnpm run build:worker
      
      - name: Create KV Namespace (if needed)
        working-directory: serverless/chat-signaling
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "Creating KV namespace CHAT_KV (if it doesn't exist)..."
          pnpm exec wrangler kv namespace create "CHAT_KV" || true
          
          echo "Listing KV namespaces..."
          pnpm exec wrangler kv namespace list || echo "Could not list namespaces"
        continue-on-error: true
      
      - name: Deploy to Cloudflare Workers
        id: deploy
        working-directory: serverless/chat-signaling
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: pnpm exec wrangler deploy
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
      
      - name: Set Worker Secrets (if needed)
        working-directory: serverless/chat-signaling
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          # CRITICAL: JWT_SECRET must match OTP auth service for token validation
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET || true
          fi
          # CRITICAL: ALLOWED_ORIGINS for CORS
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "${{ secrets.ALLOWED_ORIGINS }}" | pnpm exec wrangler secret put ALLOWED_ORIGINS || true
          else
            echo "âš  WARNING: ALLOWED_ORIGINS GitHub secret is not set! CORS will fail in production."
          fi
        continue-on-error: true
      
      - name: Deployment Summary
        run: |
          echo "## ðŸ’¬ Chat Signaling API Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Chat Signaling API has been deployed to Cloudflare Workers." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** \`https://chat-api.idling.app\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints:" >> $GITHUB_STEP_SUMMARY
          echo "- Health: \`GET /health\`" >> $GITHUB_STEP_SUMMARY
          echo "- Create Room: \`POST /signaling/create-room\`" >> $GITHUB_STEP_SUMMARY
          echo "- Join Room: \`POST /signaling/join-room\`" >> $GITHUB_STEP_SUMMARY
          echo "- Leave Room: \`POST /signaling/leave-room\`" >> $GITHUB_STEP_SUMMARY
          echo "- List Rooms: \`GET /signaling/rooms\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- \`JWT_SECRET\` - JWT verification (must match OTP Auth)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ALLOWED_ORIGINS\` - CORS origins (optional)" >> $GITHUB_STEP_SUMMARY
