# Strixun Stream Suite - Sync Documentation to Wiki
#
# This workflow automatically syncs documentation from the codebase to the GitHub wiki
# when markdown files are changed on the master branch.
#
# The wiki is a separate git repository that GitHub creates automatically.
# This workflow uses GITHUB_TOKEN which has automatic permissions to push to the wiki.
#
# Prerequisites:
# 1. Enable Wikis in repository Settings ‚Üí Features ‚Üí Wikis
# 2. Ensure workflow permissions allow read/write (Settings ‚Üí Actions ‚Üí General)
# 3. The wiki repository will be created automatically on first sync

name: Sync Documentation to Wiki

on:
  push:
    branches: [master, main]
    paths:
      # Trigger on markdown file changes in documentation directories
      - 'docs/**/*.md'
      - 'product-docs/**/*.md'
      - 'serverless/**/*.md'
      - 'mods-hub/**/*.md'
      - 'shared-components/**/*.md'
      # Also trigger if the migration script itself changes
      - 'scripts/migrate-wiki.ts'
      - 'scripts/migrate-wiki.js'
      # Root level markdown files (like README.md changes that affect Home page)
      - 'README.md'
  workflow_dispatch: # Allow manual triggering

# Allow only one concurrent sync
concurrency:
  group: "wiki-sync"
  cancel-in-progress: false

# Sets permissions for GITHUB_TOKEN
# GITHUB_TOKEN automatically has permissions to push to the wiki
permissions:
  contents: read
  # Wiki write permissions are automatically granted to GITHUB_TOKEN

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git operations
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Check for markdown changes
        id: check-changes
        run: |
          # Check if any markdown files were changed
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - will sync all docs"
            echo "should_sync=true" >> $GITHUB_OUTPUT
          else
            # Check if any .md files were changed
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(md|MD)$' || true)
            if [ -n "$CHANGED_FILES" ]; then
              echo "Markdown files changed:"
              echo "$CHANGED_FILES"
              echo "should_sync=true" >> $GITHUB_OUTPUT
            else
              echo "No markdown files changed, skipping sync"
              echo "should_sync=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Sync documentation to wiki
        if: steps.check-changes.outputs.should_sync == 'true'
        env:
          # Use GITHUB_TOKEN (automatically provided) or fallback to custom token
          # GITHUB_TOKEN should work for wikis, but if it doesn't, use a PAT with 'repo' scope
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || secrets.WIKI_SYNC_TOKEN }}
        run: |
          echo "üöÄ Starting wiki sync..."
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo ""
          
          # Verify token is set
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "‚ùå ERROR: GITHUB_TOKEN is not set!"
            echo ""
            echo "GITHUB_TOKEN should be automatically provided by GitHub Actions."
            echo "If you're seeing this error, you may need to:"
            echo "1. Check repository settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions"
            echo "2. Ensure 'Read and write permissions' is enabled"
            echo "3. Or set a custom WIKI_SYNC_TOKEN secret with 'repo' scope"
            exit 1
          fi
          
          # Run the migration script using tsx
          # Use pnpm dlx to run tsx without installing it
          pnpm dlx tsx scripts/migrate-wiki.ts || {
            echo ""
            echo "‚ùå Wiki sync failed!"
            echo ""
            echo "Common issues:"
            echo "1. Wiki repository may not exist yet - create it by:"
            echo "   - Going to repository Settings ‚Üí Features ‚Üí Wikis"
            echo "   - Enable wikis and save"
            echo "   - Then re-run this workflow"
            echo ""
            echo "2. Token permissions - ensure GITHUB_TOKEN has 'repo' scope"
            echo "   Or set WIKI_SYNC_TOKEN secret with a Personal Access Token"
            exit 1
          }
          
          echo ""
          echo "‚úÖ Wiki sync completed!"
      
      - name: Summary
        if: steps.check-changes.outputs.should_sync == 'true'
        run: |
          echo "## üìö Wiki Sync Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Documentation has been synced to the GitHub wiki." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**View wiki:** [https://github.com/${{ github.repository }}/wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Skip message
        if: steps.check-changes.outputs.should_sync == 'false'
        run: |
          echo "‚è≠Ô∏è No markdown files were changed in this commit, skipping wiki sync."

