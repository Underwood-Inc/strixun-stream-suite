# Strixun Stream Suite - Sync Documentation to Wiki
#
# This workflow automatically syncs documentation from the codebase to the GitHub wiki
# when markdown files are changed on the master branch.
#
# The wiki is a separate git repository that GitHub creates automatically.
# This workflow uses the built-in GITHUB_TOKEN which has automatic permissions to push to the wiki.
# No custom tokens or secrets are required - the built-in token works for wiki access.
#
# Prerequisites:
# 1. Enable Wikis in repository Settings → Features → Wikis
# 2. Ensure workflow permissions allow read/write (Settings → Actions → General → Workflow permissions)
# 3. The wiki repository will be created automatically on first sync

name: Sync Documentation to Wiki

on:
  push:
    branches: [master, main]
    paths:
      # Trigger on markdown file changes in documentation directories
      - 'docs/**/*.md'
      - 'product-docs/**/*.md'
      - 'serverless/**/*.md'
      - 'mods-hub/**/*.md'
      - 'shared-components/**/*.md'
      # Also trigger if the migration script itself changes
      - 'scripts/migrate-wiki.js'
      # Root level markdown files (like README.md changes that affect Home page)
      - 'README.md'
  workflow_dispatch: # Allow manual triggering

# Allow only one concurrent sync
concurrency:
  group: "wiki-sync"
  cancel-in-progress: false

# Sets permissions for GITHUB_TOKEN
# IMPORTANT: For wiki access, the repository must have "Read and write permissions" enabled
# Go to: Settings → Actions → General → Workflow permissions → Read and write permissions
# Wiki access is granted automatically when workflow has write permissions
permissions:
  contents: write  # Write permission required for wiki access
  # Wiki write permissions are automatically granted when contents: write is set

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git operations
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Check for markdown changes
        id: check-changes
        run: |
          # Check if any markdown files were changed
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - will sync all docs"
            echo "should_sync=true" >> $GITHUB_OUTPUT
          else
            # Check if any .md files were changed
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(md|MD)$' || true)
            if [ -n "$CHANGED_FILES" ]; then
              echo "Markdown files changed:"
              echo "$CHANGED_FILES"
              echo "should_sync=true" >> $GITHUB_OUTPUT
            else
              echo "No markdown files changed, skipping sync"
              echo "should_sync=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Sync documentation to wiki
        if: steps.check-changes.outputs.should_sync == 'true'
        env:
          # Use the built-in GITHUB_TOKEN (automatically provided by GitHub Actions)
          # This token has automatic permissions to push to the wiki repository
          # No custom token needed - the built-in token works for wiki access
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ℹ Starting wiki sync..."
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo ""
          
          # Verify token is set (should always be set by GitHub Actions)
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "✗ GITHUB_TOKEN is not set!"
            echo ""
            echo "GITHUB_TOKEN should be automatically provided by GitHub Actions."
            echo "If you're seeing this error, check repository settings:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/actions"
            echo "2. Scroll to 'Workflow permissions' section"
            echo "3. Ensure 'Read and write permissions' is selected (NOT 'Read repository contents')"
            echo "4. Click 'Save' and re-run the workflow"
            exit 1
          fi
          
          echo "ℹ GITHUB_TOKEN is set (length: ${#GITHUB_TOKEN} characters)"
          echo "ℹ Repository: ${{ github.repository }}"
          echo "ℹ Wiki URL: https://github.com/${{ github.repository }}.wiki.git"
          echo ""
          
          # Run the migration script using node
          node scripts/migrate-wiki.js || {
            echo ""
            echo "✗ Wiki sync failed!"
            echo ""
            echo "Common issues and fixes:"
            echo ""
            echo "1. WORKFLOW PERMISSIONS (Most Common Fix):"
            echo "   - Go to: https://github.com/${{ github.repository }}/settings/actions"
            echo "   - Scroll to 'Workflow permissions' section"
            echo "   - Select 'Read and write permissions' (NOT 'Read repository contents')"
            echo "   - Click 'Save'"
            echo "   - Re-run this workflow"
            echo ""
            echo "2. WIKI NOT ENABLED:"
            echo "   - Go to: https://github.com/${{ github.repository }}/settings"
            echo "   - Click 'Features' in the left sidebar"
            echo "   - Find 'Wikis' section"
            echo "   - Check 'Wikis' checkbox and save"
            echo "   - Then re-run this workflow"
            echo ""
            echo "3. VERIFY WIKI EXISTS:"
            echo "   - Visit: https://github.com/${{ github.repository }}/wiki"
            echo "   - If you see 404, the wiki is not enabled (see step 2)"
            echo ""
            echo "4. TOKEN PERMISSIONS:"
            echo "   - The GITHUB_TOKEN should have wiki access automatically"
            echo "   - But only if workflow permissions are set to 'Read and write'"
            echo "   - Check repository settings (step 1) first"
            echo ""
            exit 1
          }
          
          echo ""
          echo "✓ Wiki sync completed!"
      
      - name: Summary
        if: steps.check-changes.outputs.should_sync == 'true'
        run: |
          echo "## ℹ Wiki Sync Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Documentation has been synced to the GitHub wiki." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**View wiki:** [https://github.com/${{ github.repository }}/wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Skip message
        if: steps.check-changes.outputs.should_sync == 'false'
        run: |
          echo "ℹ No markdown files were changed in this commit, skipping wiki sync."

