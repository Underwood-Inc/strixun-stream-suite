# Strixun Stream Suite - Deploy to GitHub Pages
#
# This workflow deploys the static frontend to GitHub Pages.
# The Twitch Clips Player and Control Panel will be available at:
#   https://<username>.github.io/<repo-name>/
#
# No secrets needed for static hosting, but you'll need to:
# 1. Enable GitHub Pages in repo Settings > Pages
# 2. Set source to "GitHub Actions"

name: Deploy to GitHub Pages

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'serverless/**'
      - '.github/workflows/deploy-twitch-api.yml'
  workflow_dispatch:

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Test job - required before deployment
  test:
    runs-on: ubuntu-latest
    name: Test Root/Client
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Run Root/Client Tests
        working-directory: .
        run: pnpm test

  build:
    needs: test
    if: needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build workspace dependencies
        run: |
          echo "Building workspace dependencies required for Svelte app..."
          # Build shared types first (no dependencies)
          echo "  -> Building @strixun/types..."
          pnpm --filter "@strixun/types" run build || echo "  i  Types has no build script (skipped)"
          # Build service-client (depends on types)
          echo "  -> Building @strixun/service-client..."
          pnpm --filter "@strixun/service-client" run build || echo "  i  Service Client has no build script (skipped)"
          # Build API Framework (depends on types and service-client)
          echo "  -> Building @strixun/api-framework..."
          pnpm --filter "@strixun/api-framework" run build || echo "  i  API Framework has no build script (skipped)"
          # Build OTP Login (required for login components)
          echo "  -> Building @strixun/otp-login..."
          pnpm --filter "@strixun/otp-login" run build:react || echo "  i  OTP Login has no build:react script (skipped)"
          echo "* All workspace dependencies built successfully"
      
      - name: Build Svelte app
        env:
          # Use root path (/) for custom domain deployment
          # If you need to support both custom domain and github.io, use:
          # VITE_BASE_PATH: ${{ secrets.CUSTOM_DOMAIN && '/' || format('/{0}/', github.event.repository.name) }}
          VITE_BASE_PATH: /
          VITE_AUTH_API_URL: ${{ secrets.VITE_AUTH_API_URL || 'https://auth.idling.app' }}
          VITE_CUSTOMER_API_URL: ${{ secrets.VITE_CUSTOMER_API_URL || 'https://customer-api.idling.app' }}
        run: pnpm build
        
      - name: Copy build output to dist root
        run: |
          # Build outputs to dist/stream-suite/, but GitHub Pages needs files at dist/ root
          # Copy all files from dist/stream-suite/ to dist/ to fix the 404 issue
          if [ -d "dist/stream-suite" ] && [ "$(ls -A dist/stream-suite 2>/dev/null)" ]; then
            echo "Copying files from dist/stream-suite/ to dist/..."
            cp -r dist/stream-suite/. dist/ || cp -r dist/stream-suite/* dist/
            echo "âœ“ Files copied successfully"
            # Remove the stream-suite subdirectory after copying
            rm -rf dist/stream-suite
            echo "âœ“ Cleaned up dist/stream-suite/"
          else
            echo "âš  Warning: dist/stream-suite/ does not exist or is empty"
            echo "Build may have failed or output directory changed"
          fi
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Create .nojekyll
        run: touch dist/.nojekyll
      
      - name: Create CNAME file for custom domain
        run: echo "streamkit.idling.app" > dist/CNAME
      
      - name: Copy config.js to dist
        run: cp config.js dist/config.js
      
      - name: Copy legacy assets
        run: |
          # Copy installer.js and any other legacy assets needed
          mkdir -p dist/assets/js/modules
          cp assets/js/modules/installer.js dist/assets/js/modules/installer.js || echo "installer.js not found, skipping"
      
      - name: Inject Auto-Configuration
        env:
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          CF_WORKERS_SUBDOMAIN: ${{ secrets.CF_WORKERS_SUBDOMAIN }}
          CUSTOM_DOMAIN: ${{ secrets.CUSTOM_DOMAIN || 'streamkit.idling.app' }}
        run: |
          # Read worker name from wrangler.toml (correct path: serverless/twitch-api/wrangler.toml)
          # CRITICAL: Validate WORKER_NAME to prevent malformed URLs
          WORKER_NAME=$(grep '^name = ' serverless/twitch-api/wrangler.toml | sed 's/name = "\(.*\)"/\1/' || echo "")
          
          # Validate WORKER_NAME - if empty or invalid, use fallback
          if [ -z "$WORKER_NAME" ] || [ "$WORKER_NAME" = "" ]; then
            echo "âš  Warning: Could not read worker name from wrangler.toml, using fallback"
            WORKER_NAME="strixun-twitch-api"
          fi
          
          echo "Worker name: $WORKER_NAME"
          
          # Construct Worker URL using Cloudflare Workers subdomain from secrets
          # If CF_WORKERS_SUBDOMAIN is not set, use hardcoded fallback
          SUBDOMAIN="${CF_WORKERS_SUBDOMAIN:-strixuns-script-suite}"
          
          # CRITICAL: Validate SUBDOMAIN to prevent malformed URLs
          if [ -z "$SUBDOMAIN" ] || [ "$SUBDOMAIN" = "" ]; then
            echo "âš  Warning: CF_WORKERS_SUBDOMAIN is empty, using fallback"
            SUBDOMAIN="strixuns-script-suite"
          fi
          
          # Construct URL with validation
          WORKER_URL="https://${WORKER_NAME}.${SUBDOMAIN}.workers.dev"
          
          # CRITICAL: Validate final URL format before injection
          if [[ "$WORKER_URL" =~ ^https://\..*\.workers\.dev$ ]] || [[ "$WORKER_URL" =~ ^https://.*\.\..*\.workers\.dev$ ]]; then
            echo "âœ— ERROR: Malformed WORKER_URL detected: $WORKER_URL"
            echo "âœ— This would cause browser lockup. Aborting deployment."
            exit 1
          fi
          
          echo "Worker URL: $WORKER_URL"
          
          # Construct OTP Auth Service URL - prefer custom domain, fallback to workers.dev
          OTP_AUTH_CUSTOM_DOMAIN="https://auth.idling.app"
          OTP_AUTH_WORKERS_DEV="https://otp-auth-service.${SUBDOMAIN}.workers.dev"
          # Use custom domain if available, otherwise workers.dev
          OTP_AUTH_URL="${OTP_AUTH_CUSTOM_DOMAIN}"
          echo "OTP Auth Service URL: $OTP_AUTH_URL"
          
          # Get GitHub Pages URL - use custom domain if configured, otherwise github.io
          # For custom domain, use the domain from GitHub Pages settings
          # You can override this with a secret CUSTOM_DOMAIN if needed
          CUSTOM_DOMAIN="${CUSTOM_DOMAIN:-streamkit.idling.app}"
          if [ -n "$CUSTOM_DOMAIN" ] && [ "$CUSTOM_DOMAIN" != "none" ]; then
            PAGES_URL="https://${CUSTOM_DOMAIN}/"
          else
            PAGES_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}/"
          fi
          echo "GitHub Pages URL: $PAGES_URL"
          
          # Get deployment timestamp
          DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Construct Storybook URL
          STORYBOOK_URL="${PAGES_URL}storybook/"
          echo "Storybook URL: $STORYBOOK_URL"
          
          # CRITICAL: Validate all URLs before injection to prevent malformed URLs
          # Check for malformed patterns: starts with dot, double dots, etc.
          if [[ "$WORKER_URL" =~ ^https?://\. ]] || [[ "$WORKER_URL" =~ \.\. ]] || [[ -z "$WORKER_URL" ]]; then
            echo "âœ— ERROR: Invalid WORKER_URL format: $WORKER_URL"
            exit 1
          fi
          
          if [[ "$OTP_AUTH_URL" =~ ^https?://\. ]] || [[ "$OTP_AUTH_URL" =~ \.\. ]] || [[ -z "$OTP_AUTH_URL" ]]; then
            echo "âœ— ERROR: Invalid OTP_AUTH_URL format: $OTP_AUTH_URL"
            exit 1
          fi
          
          if [[ "$PAGES_URL" =~ ^https?://\. ]] || [[ "$PAGES_URL" =~ \.\. ]] || [[ -z "$PAGES_URL" ]]; then
            echo "âœ— ERROR: Invalid PAGES_URL format: $PAGES_URL"
            exit 1
          fi
          
          # Inject values into config.js in dist directory
          # Use | as delimiter to avoid issues with URLs containing /
          sed -i "s|%%WORKER_API_URL%%|${WORKER_URL}|g" dist/config.js
          sed -i "s|%%OTP_AUTH_API_URL%%|${OTP_AUTH_URL}|g" dist/config.js
          sed -i "s|%%GITHUB_PAGES_URL%%|${PAGES_URL}|g" dist/config.js
          sed -i "s|%%STORYBOOK_URL%%|${STORYBOOK_URL}|g" dist/config.js
          sed -i "s|%%TWITCH_CLIENT_ID%%|${TWITCH_CLIENT_ID}|g" dist/config.js
          sed -i "s|%%DEPLOYED_AT%%|${DEPLOYED_AT}|g" dist/config.js
          sed -i "s|%%DEPLOYMENT_ENV%%|github-pages|g" dist/config.js
          
          # Verify injection succeeded by checking for remaining placeholders
          if grep -q "%%WORKER_API_URL%%" dist/config.js; then
            echo "âœ— ERROR: Failed to inject WORKER_API_URL - placeholder still present"
            exit 1
          fi
          
          echo "âœ“ Configuration injected into dist/config.js"
          echo "Worker API URL: $WORKER_URL"
          echo "OTP Auth Service URL: $OTP_AUTH_URL"
          echo "GitHub Pages URL: $PAGES_URL"
          echo "Twitch Client ID: ${TWITCH_CLIENT_ID:0:8}... (hidden)"
        
      - name: Upload artifact
        id: upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'dist'
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Build failed - deployment prevented"
          exit 1

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check GitHub Pages settings and rollback if needed"
          exit 1
        
      - name: Deployment Summary
        run: |
          # Read worker name from wrangler.toml (correct path: serverless/twitch-api/wrangler.toml)
          WORKER_NAME=$(grep '^name = ' serverless/twitch-api/wrangler.toml | sed 's/name = "\(.*\)"/\1/' || echo "strixun-twitch-api")
          
          # Validate WORKER_NAME
          if [ -z "$WORKER_NAME" ] || [ "$WORKER_NAME" = "" ]; then
            WORKER_NAME="strixun-twitch-api"
          fi
          
          # Use CF_WORKERS_SUBDOMAIN if available, otherwise use GITHUB_ACTOR
          SUBDOMAIN="${CF_WORKERS_SUBDOMAIN:-${GITHUB_ACTOR}}"
          if [ -z "$SUBDOMAIN" ] || [ "$SUBDOMAIN" = "" ]; then
            SUBDOMAIN="strixuns-script-suite"
          fi
          
          WORKER_URL="https://${WORKER_NAME}.${SUBDOMAIN}.workers.dev"
          
          # Validate URL format
          if [[ "$WORKER_URL" =~ ^https://\..*\.workers\.dev$ ]] || [[ "$WORKER_URL" =~ ^https://.*\.\..*\.workers\.dev$ ]]; then
            echo "âš  Warning: Malformed WORKER_URL in summary: $WORKER_URL"
            WORKER_URL="https://strixun-twitch-api.strixuns-script-suite.workers.dev"
          fi
          
          echo "## ðŸŒ GitHub Pages Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Pages:" >> $GITHUB_STEP_SUMMARY
          echo "- Control Panel: \`${{ steps.deployment.outputs.page_url }}control_panel.html\`" >> $GITHUB_STEP_SUMMARY
          echo "- Clips Player: \`${{ steps.deployment.outputs.page_url }}twitch_clips_player/player.html\`" >> $GITHUB_STEP_SUMMARY
          echo "- Legacy Player: \`${{ steps.deployment.outputs.page_url }}twitch_clips_player/clips.html\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-configured Worker API: \`${WORKER_URL}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Config file injected: \`config.js\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ The Worker API URL has been auto-configured. If it doesn't work, you can override it in Setup â†’ Twitch API Settings." >> $GITHUB_STEP_SUMMARY

