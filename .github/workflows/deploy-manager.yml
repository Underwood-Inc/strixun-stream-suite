# Strixun Stream Suite - Combined Deployment Workflow
#
# This workflow allows manual deployment of multiple services with checkboxes
# Use this for easy manual deployment of any combination of services
#
# Required GitHub Secrets:
#   - CF_API_TOKEN: Cloudflare API token with Workers and Pages permissions
#   - CF_ACCOUNT_ID: Your Cloudflare account ID
#   - JWT_SECRET: Secure random secret for JWT token signing
#   - RESEND_API_KEY: Resend API key for OTP email functionality
#   - RESEND_FROM_EMAIL: Verified domain email for sending OTP emails
#   - TWITCH_CLIENT_ID: Your Twitch application client ID
#   - TWITCH_CLIENT_SECRET: Your Twitch application client secret
#   - ALLOWED_ORIGINS: Optional - Comma-separated list of allowed CORS origins
#   - SERVICE_API_KEY: Required for Access Service admin endpoints - Service-to-service authentication
#   - NETWORK_INTEGRITY_KEYPHRASE: Optional - Network security keyphrase for all services
#   - MODS_PUBLIC_URL: Optional - Mods public URL
#   - VITE_MODS_API_URL: Optional - Mods API URL for frontend (defaults to https://mods-api.idling.app)
#   - VITE_AUTH_API_URL: Optional - Auth API URL for frontend (defaults to https://auth.idling.app)

name: Deploy Service(s)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        type: choice
        options:
          - production
          - development
        default: 'production'
      deploy_twitch_api:
        description: 'Deploy Twitch API'
        type: boolean
        default: true
      deploy_mods_api:
        description: 'Deploy Mods API'
        type: boolean
        default: true
      deploy_otp_auth:
        description: 'Deploy OTP Auth Service'
        type: boolean
        default: true
      deploy_customer_api:
        description: 'Deploy Customer API'
        type: boolean
        default: true
      deploy_game_api:
        description: 'Deploy Game API'
        type: boolean
        default: true
      deploy_mods_hub:
        description: 'Deploy Mods Hub (Pages) - Production only'
        type: boolean
        default: true
      deploy_access_hub:
        description: 'Deploy Access Hub (Pages) - Production only'
        type: boolean
        default: true
      deploy_storybook:
        description: 'Deploy Storybook (Pages) - Production only'
        type: boolean
        default: true
      deploy_pages:
        description: 'Deploy GitHub Pages - Production only'
        type: boolean
        default: true
      deploy_url_shortener:
        description: 'Deploy URL Shortener'
        type: boolean
        default: true
      deploy_access_service:
        description: 'Deploy Access Service'
        type: boolean
        default: true

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Shared setup job for dependency installation
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile

  # Test jobs - required before deployment
  test_root:
    needs: setup
    if: ${{ inputs.deploy_mods_hub || inputs.deploy_storybook || inputs.deploy_pages }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Run Root/Client Tests
        working-directory: .
        run: pnpm test

  test_otp_auth:
    needs: setup
    if: ${{ inputs.deploy_otp_auth }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Run OTP Auth Service Tests
        working-directory: serverless/otp-auth-service
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NETWORK_INTEGRITY_KEYPHRASE: ${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM_EMAIL: ${{ secrets.RESEND_FROM_EMAIL }}
        run: pnpm test

  # Test jobs for services (skip if no test script)
  test_twitch_api:
    needs: setup
    if: ${{ inputs.deploy_twitch_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/twitch-api
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Twitch API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/twitch-api
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: echo "âš  No test script found in Twitch API - skipping tests"

  test_mods_api:
    needs: setup
    if: ${{ inputs.deploy_mods_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/mods-api
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Mods API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/mods-api
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NETWORK_INTEGRITY_KEYPHRASE: ${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: echo "âš  No test script found in Mods API - skipping tests"

  test_customer_api:
    needs: setup
    if: ${{ inputs.deploy_customer_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/customer-api
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Customer API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/customer-api
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NETWORK_INTEGRITY_KEYPHRASE: ${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: echo "âš  No test script found in Customer API - skipping tests"

  test_game_api:
    needs: setup
    if: ${{ inputs.deploy_game_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/game-api
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Game API Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/game-api
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NETWORK_INTEGRITY_KEYPHRASE: ${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: echo "âš  No test script found in Game API - skipping tests"

  test_url_shortener:
    needs: setup
    if: ${{ inputs.deploy_url_shortener }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/url-shortener
        run: |
          if grep -q '"test"' package.json && ! grep -q '"test".*"Error: no test specified"' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run URL Shortener Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/url-shortener
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NETWORK_INTEGRITY_KEYPHRASE: ${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: echo "âš  No test script found in URL Shortener - skipping tests"

  test_access_service:
    needs: setup
    if: ${{ inputs.deploy_access_service }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Check for test script
        id: check_test
        working-directory: serverless/access-service
        run: |
          # Check for actual test files or vitest/jest config
          if [ -f "vitest.config.ts" ] || [ -f "vitest.config.js" ] || [ -f "jest.config.js" ] || [ -f "jest.config.ts" ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          elif grep -q '"test"' package.json && ! grep -q 'Error: no test specified' package.json; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Access Service Tests
        if: steps.check_test.outputs.has_tests == 'true'
        working-directory: serverless/access-service
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NETWORK_INTEGRITY_KEYPHRASE: ${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}
          SERVICE_API_KEY: ${{ secrets.SERVICE_API_KEY }}
        run: pnpm test
      
      - name: Skip Tests (No test script)
        if: steps.check_test.outputs.has_tests == 'false'
        run: echo "âš  No test script found in Access Service - skipping tests"

  # Twitch API Deployment
  deploy_twitch_api:
    needs: setup
    if: ${{ inputs.deploy_twitch_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Worker
        working-directory: serverless/twitch-api
        run: pnpm run build:worker
      
      - name: Deploy Worker
        id: deploy
        working-directory: serverless/twitch-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ "${{ inputs.environment }}" == "development" ]; then
            pnpm exec wrangler deploy --env development
          else
            pnpm exec wrangler deploy
          fi
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
      
      - name: Set Worker Secrets
        working-directory: serverless/twitch-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          ENV_FLAG=""
          if [ "${{ inputs.environment }}" == "development" ]; then
            ENV_FLAG="--env development"
          fi
          echo "${{ secrets.TWITCH_CLIENT_ID }}" | pnpm exec wrangler secret put TWITCH_CLIENT_ID $ENV_FLAG || true
          echo "${{ secrets.TWITCH_CLIENT_SECRET }}" | pnpm exec wrangler secret put TWITCH_CLIENT_SECRET $ENV_FLAG || true
          echo "${{ secrets.RESEND_API_KEY }}" | pnpm exec wrangler secret put RESEND_API_KEY $ENV_FLAG || true
          echo "${{ secrets.RESEND_FROM_EMAIL }}" | pnpm exec wrangler secret put RESEND_FROM_EMAIL $ENV_FLAG || true
          echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET $ENV_FLAG || true
        continue-on-error: true

  # Mods API Deployment
  deploy_mods_api:
    needs: [setup, test_mods_api]
    if: ${{ inputs.deploy_mods_api && (needs.test_mods_api.result == 'success' || needs.test_mods_api.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Worker
        working-directory: serverless/mods-api
        run: pnpm run build:worker
      
      - name: Deploy to Cloudflare Workers
        id: deploy
        working-directory: serverless/mods-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ "${{ inputs.environment }}" == "development" ]; then
            pnpm exec wrangler deploy --env development
          else
            # CRITICAL: mods-api uses default deployment (NOT --env production)
            # Default deployment IS production for mods-api (unlike url-shortener)
            pnpm exec wrangler deploy --env=""
          fi
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
      
      - name: Set Worker Secrets
        working-directory: serverless/mods-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          ENV_FLAG=""
          if [ "${{ inputs.environment }}" == "development" ]; then
            ENV_FLAG="--env development"
          fi
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET $ENV_FLAG || true
          fi
          # CRITICAL: ALLOWED_ORIGINS is required for CORS - use default if secret not set
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "${{ secrets.ALLOWED_ORIGINS }}" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
          else
            echo "âš   WARNING: ALLOWED_ORIGINS secret is not set! Using default production origins."
            if [ "${{ inputs.environment }}" == "development" ]; then
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app,http://localhost:5173,http://localhost:3000,http://localhost:3001,http://localhost:5174,http://localhost:5175,http://127.0.0.1:5173,http://localhost:8080" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            else
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            fi
          fi
          if [ -n "${{ secrets.MODS_PUBLIC_URL }}" ]; then
            echo "${{ secrets.MODS_PUBLIC_URL }}" | pnpm exec wrangler secret put MODS_PUBLIC_URL $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.SERVICE_API_KEY }}" ]; then
            echo "${{ secrets.SERVICE_API_KEY }}" | pnpm exec wrangler secret put SERVICE_API_KEY $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}" ]; then
            echo "${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}" | pnpm exec wrangler secret put NETWORK_INTEGRITY_KEYPHRASE $ENV_FLAG || true
          fi
          # CRITICAL: FILE_INTEGRITY_KEYPHRASE is required for HMAC-SHA256 file integrity verification
          # This is separate from NETWORK_INTEGRITY_KEYPHRASE and is used to prevent hash spoofing
          if [ -n "${{ secrets.FILE_INTEGRITY_KEYPHRASE }}" ]; then
            echo "${{ secrets.FILE_INTEGRITY_KEYPHRASE }}" | pnpm exec wrangler secret put FILE_INTEGRITY_KEYPHRASE $ENV_FLAG || true
          else
            echo "âš   WARNING: FILE_INTEGRITY_KEYPHRASE secret is not set!"
            echo "File integrity verification will use fallback keyphrase (development only)"
            echo "Please add FILE_INTEGRITY_KEYPHRASE to GitHub Secrets for production security"
          fi
          if [ -n "${{ secrets.MODS_ENCRYPTION_KEY }}" ]; then
            echo "${{ secrets.MODS_ENCRYPTION_KEY }}" | pnpm exec wrangler secret put MODS_ENCRYPTION_KEY $ENV_FLAG || true
          fi
        continue-on-error: true

  # OTP Auth Service Deployment
  deploy_otp_auth:
    needs: [setup, test_otp_auth]
    if: ${{ inputs.deploy_otp_auth && needs.test_otp_auth.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Dashboard
        working-directory: serverless/otp-auth-service
        run: pnpm run build
      
      - name: Build Worker
        working-directory: serverless/otp-auth-service
        run: pnpm run build:worker
      
      - name: Build and Deploy to Cloudflare Workers
        id: deploy
        working-directory: serverless/otp-auth-service
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ "${{ inputs.environment }}" == "development" ]; then
            pnpm exec wrangler deploy --env development
          else
            pnpm exec wrangler deploy --env=""
          fi
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
      
      - name: Set Worker Secrets
        working-directory: serverless/otp-auth-service
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          ENV_FLAG=""
          if [ "${{ inputs.environment }}" == "development" ]; then
            ENV_FLAG="--env development"
          fi
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.RESEND_API_KEY }}" ]; then
            echo "${{ secrets.RESEND_API_KEY }}" | pnpm exec wrangler secret put RESEND_API_KEY $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.RESEND_FROM_EMAIL }}" ]; then
            echo "${{ secrets.RESEND_FROM_EMAIL }}" | pnpm exec wrangler secret put RESEND_FROM_EMAIL $ENV_FLAG || true
          fi
          # CRITICAL: ALLOWED_ORIGINS is required for CORS - use default if secret not set
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "${{ secrets.ALLOWED_ORIGINS }}" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
          else
            echo "âš   WARNING: ALLOWED_ORIGINS secret is not set! Using default production origins."
            if [ "${{ inputs.environment }}" == "development" ]; then
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app,http://localhost:5173,http://localhost:3000,http://localhost:3001,http://localhost:5174,http://localhost:5175,http://127.0.0.1:5173,http://localhost:8080" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            else
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            fi
          fi
          if [ -n "${{ secrets.SERVICE_API_KEY }}" ]; then
            echo "${{ secrets.SERVICE_API_KEY }}" | pnpm exec wrangler secret put SERVICE_API_KEY $ENV_FLAG || true
          fi
          # âš  DEPRECATED: SERVICE_ENCRYPTION_KEY removed - all encryption now uses JWT tokens
          # Service key encryption has been completely removed from the codebase
          # This block can be removed in a future cleanup
          # if [ -n "${{ secrets.VITE_SERVICE_ENCRYPTION_KEY }}" ]; then
          #   echo "${{ secrets.VITE_SERVICE_ENCRYPTION_KEY }}" | pnpm exec wrangler secret put SERVICE_ENCRYPTION_KEY $ENV_FLAG || true
          # fi
          if [ -n "${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}" ]; then
            echo "${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}" | pnpm exec wrangler secret put NETWORK_INTEGRITY_KEYPHRASE $ENV_FLAG || true
          fi
        continue-on-error: true

  # Customer API Deployment
  deploy_customer_api:
    needs: setup
    if: ${{ inputs.deploy_customer_api }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Worker
        working-directory: serverless/customer-api
        run: pnpm run build:worker
      
      - name: Create KV Namespace (if needed)
        working-directory: serverless/customer-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "Creating KV namespace CUSTOMER_API_KV (if it doesn't exist)..."
          pnpm exec wrangler kv namespace create "CUSTOMER_API_KV" || true
        continue-on-error: true
      
      - name: Deploy to Cloudflare Workers
        id: deploy
        working-directory: serverless/customer-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ "${{ inputs.environment }}" == "development" ]; then
            pnpm exec wrangler deploy --env development
          else
            pnpm exec wrangler deploy --env=""
          fi
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
      
      - name: Set Worker Secrets
        working-directory: serverless/customer-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          ENV_FLAG=""
          if [ "${{ inputs.environment }}" == "development" ]; then
            ENV_FLAG="--env development"
          fi
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET $ENV_FLAG || true
          fi
          # CRITICAL: ALLOWED_ORIGINS is required for CORS - use default if secret not set
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "${{ secrets.ALLOWED_ORIGINS }}" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
          else
            echo "âš   WARNING: ALLOWED_ORIGINS secret is not set! Using default production origins."
            if [ "${{ inputs.environment }}" == "development" ]; then
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app,http://localhost:5173,http://localhost:3000,http://localhost:3001,http://localhost:5174,http://localhost:5175,http://127.0.0.1:5173,http://localhost:8080" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            else
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            fi
          fi
          if [ -n "${{ secrets.SERVICE_API_KEY }}" ]; then
            echo "${{ secrets.SERVICE_API_KEY }}" | pnpm exec wrangler secret put SERVICE_API_KEY $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}" ]; then
            echo "${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}" | pnpm exec wrangler secret put NETWORK_INTEGRITY_KEYPHRASE $ENV_FLAG || true
          fi
        continue-on-error: true

  # Game API Deployment
  deploy_game_api:
    needs: [setup, test_game_api]
    if: ${{ inputs.deploy_game_api && (needs.test_game_api.result == 'success' || needs.test_game_api.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Worker
        working-directory: serverless/game-api
        run: pnpm run build:worker
      
      - name: Deploy to Cloudflare Workers
        id: deploy
        working-directory: serverless/game-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ "${{ inputs.environment }}" == "development" ]; then
            pnpm exec wrangler deploy --env development
          else
            pnpm exec wrangler deploy --env=""
          fi
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
      
      - name: Set Worker Secrets
        working-directory: serverless/game-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          ENV_FLAG=""
          if [ "${{ inputs.environment }}" == "development" ]; then
            ENV_FLAG="--env development"
          fi
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "${{ secrets.ALLOWED_ORIGINS }}" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
          fi
        continue-on-error: true

  # URL Shortener Deployment
  deploy_url_shortener:
    needs: setup
    if: ${{ inputs.deploy_url_shortener }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build URL Shortener App
        working-directory: serverless/url-shortener
        env:
          VITE_SERVICE_ENCRYPTION_KEY: ${{ secrets.VITE_SERVICE_ENCRYPTION_KEY }}
        run: pnpm build:all
      
      - name: Deploy to Cloudflare Workers
        id: deploy
        working-directory: serverless/url-shortener
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ "${{ inputs.environment }}" == "development" ]; then
            pnpm exec wrangler deploy --env development
          else
            pnpm exec wrangler deploy --env=""
          fi
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
      
      - name: Set Worker Secrets
        working-directory: serverless/url-shortener
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          ENV_FLAG=""
          if [ "${{ inputs.environment }}" == "development" ]; then
            ENV_FLAG="--env development"
          fi
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET $ENV_FLAG || true
          fi
          # CRITICAL: ALLOWED_ORIGINS is required for CORS - use default if secret not set
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "${{ secrets.ALLOWED_ORIGINS }}" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
          else
            echo "âš   WARNING: ALLOWED_ORIGINS secret is not set! Using default production origins."
            if [ "${{ inputs.environment }}" == "development" ]; then
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app,http://localhost:5173,http://localhost:3000,http://localhost:3001,http://localhost:5174,http://localhost:5175,http://127.0.0.1:5173,http://localhost:8080" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            else
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            fi
          fi
        continue-on-error: true

  # Access Service Deployment
  deploy_access_service:
    needs: [setup, test_access_service]
    if: ${{ inputs.deploy_access_service && (needs.test_access_service.result == 'success' || needs.test_access_service.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Worker
        working-directory: serverless/access-service
        run: pnpm run build:worker
      
      - name: Create KV Namespace (if needed)
        working-directory: serverless/access-service
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          # Create KV namespace if it doesn't exist
          echo "Creating KV namespace ACCESS_KV (if it doesn't exist)..."
          pnpm exec wrangler kv namespace create "ACCESS_KV" || true
          
          # List namespaces to verify creation and show ID
          echo "Listing KV namespaces..."
          pnpm exec wrangler kv namespace list || echo "Could not list namespaces"
        continue-on-error: true
      
      - name: Deploy to Cloudflare Workers
        id: deploy
        working-directory: serverless/access-service
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ "${{ inputs.environment }}" == "development" ]; then
            pnpm exec wrangler deploy --env development
          else
            pnpm exec wrangler deploy --env=""
          fi
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1
      
      - name: Set Worker Secrets
        working-directory: serverless/access-service
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          ENV_FLAG=""
          if [ "${{ inputs.environment }}" == "development" ]; then
            ENV_FLAG="--env development"
          fi
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "${{ secrets.ALLOWED_ORIGINS }}" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
          else
            echo "âš   WARNING: ALLOWED_ORIGINS secret is not set! Using default production origins."
            if [ "${{ inputs.environment }}" == "development" ]; then
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app,http://localhost:5173,http://localhost:3000,http://localhost:3001,http://localhost:5174,http://localhost:5175,http://127.0.0.1:5173,http://localhost:8080" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            else
              echo "https://mods.idling.app,https://auth.idling.app,https://access.idling.app,https://access-api.idling.app,https://api.idling.app,https://customer.idling.app,https://game.idling.app,https://s.idling.app,https://chat.idling.app,https://idling.app,https://www.idling.app" | pnpm exec wrangler secret put ALLOWED_ORIGINS $ENV_FLAG || true
            fi
          fi
          if [ -n "${{ secrets.SERVICE_API_KEY }}" ]; then
            echo "${{ secrets.SERVICE_API_KEY }}" | pnpm exec wrangler secret put SERVICE_API_KEY $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}" ]; then
            echo "${{ secrets.NETWORK_INTEGRITY_KEYPHRASE }}" | pnpm exec wrangler secret put NETWORK_INTEGRITY_KEYPHRASE $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.CUSTOMER_API_URL }}" ]; then
            echo "${{ secrets.CUSTOMER_API_URL }}" | pnpm exec wrangler secret put CUSTOMER_API_URL $ENV_FLAG || true
          fi
          if [ -n "${{ secrets.SUPER_ADMIN_EMAILS }}" ]; then
            echo "${{ secrets.SUPER_ADMIN_EMAILS }}" | pnpm exec wrangler secret put SUPER_ADMIN_EMAILS $ENV_FLAG || true
          fi
        continue-on-error: true
      
      - name: Seed Default Roles & Permissions
        working-directory: serverless/access-service
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          SERVICE_API_KEY: ${{ secrets.SERVICE_API_KEY }}
        run: |
          echo "Seeding default roles and permissions..."
          # Get the worker URL from deployment
          WORKER_URL="https://access-api.idling.app"
          
          # Seed defaults with service key authentication
          curl -X POST "$WORKER_URL/access/seed" \
            -H "X-Service-Key: $SERVICE_API_KEY" || echo "âš  Seed endpoint not responding - may need manual seeding"
        continue-on-error: true

  # Mods Hub Deployment (Cloudflare Pages) - Production only
  deploy_mods_hub:
    needs: [setup, test_root]
    if: ${{ inputs.deploy_mods_hub && inputs.environment == 'production' && needs.test_root.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Mods Hub
        working-directory: mods-hub
        env:
          VITE_MODS_API_URL: ${{ secrets.VITE_MODS_API_URL || 'https://mods-api.idling.app' }}
          VITE_AUTH_API_URL: ${{ secrets.VITE_AUTH_API_URL || 'https://auth.idling.app' }}
          VITE_CUSTOMER_API_URL: ${{ secrets.VITE_CUSTOMER_API_URL || 'https://customer-api.idling.app' }}
          VITE_MODS_ENCRYPTION_KEY: ${{ secrets.MODS_ENCRYPTION_KEY }}
        run: |
          # Validate that MODS_ENCRYPTION_KEY is set (required for file encryption)
          if [ -z "$VITE_MODS_ENCRYPTION_KEY" ]; then
            echo "âœ— ERROR: MODS_ENCRYPTION_KEY secret is not set in GitHub Secrets!"
            echo "Please add MODS_ENCRYPTION_KEY to your GitHub repository secrets."
            echo "This key must match the MODS_ENCRYPTION_KEY in the mods-api worker."
            exit 1
          fi
          
          # Verify key length (should be at least 32 characters)
          if [ ${#VITE_MODS_ENCRYPTION_KEY} -lt 32 ]; then
            echo "âœ— ERROR: MODS_ENCRYPTION_KEY is too short (must be at least 32 characters)"
            exit 1
          fi
          
          echo "âœ“ MODS_ENCRYPTION_KEY is configured (length: ${#VITE_MODS_ENCRYPTION_KEY} characters)"
          pnpm run build
          
          # Verify the key was embedded in the build (check that VITE_MODS_ENCRYPTION_KEY is referenced)
          # Note: We check for the env var name, not the actual value, to avoid exposing secrets
          echo "ðŸ” Verifying encryption key was embedded in build..."
          if grep -r "VITE_MODS_ENCRYPTION_KEY" ../dist/mods-hub/assets/*.js 2>/dev/null | head -1 > /dev/null; then
            echo "âœ“ Encryption key reference found in build output"
          else
            echo "âš   WARNING: Encryption key reference not found in build - key may not be embedded"
            echo "This could indicate the build didn't include the environment variable"
          fi
      
      - name: Deploy to Cloudflare Pages
        id: deploy
        working-directory: mods-hub
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          # Create project if it doesn't exist (suppress error if already exists)
          pnpm exec wrangler pages project create mods-hub --production-branch=main 2>/dev/null || echo "Project already exists, continuing with deployment..."
          # Build outputs to ../dist/mods-hub (relative to mods-hub directory)
          pnpm exec wrangler pages deploy ../dist/mods-hub --project-name=mods-hub --branch=main
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1

  # Access Hub Deployment (Cloudflare Pages) - Production only
  deploy_access_hub:
    needs: [setup, test_root]
    if: ${{ inputs.deploy_access_hub && inputs.environment == 'production' && needs.test_root.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Access Hub
        working-directory: access-hub
        env:
          VITE_ACCESS_API_URL: https://access-api.idling.app
          VITE_AUTH_API_URL: ${{ secrets.VITE_AUTH_API_URL || 'https://auth.idling.app' }}
          VITE_CUSTOMER_API_URL: ${{ secrets.VITE_CUSTOMER_API_URL || 'https://customer-api.idling.app' }}
        run: pnpm run build
      
      - name: Deploy to Cloudflare Pages
        id: deploy
        working-directory: access-hub
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          # Create project if it doesn't exist (suppress error if already exists)
          pnpm exec wrangler pages project create access-hub --production-branch=main 2>/dev/null || echo "Project already exists, continuing with deployment..."
          # Build outputs to ../dist/access-hub (relative to access-hub directory)
          pnpm exec wrangler pages deploy ../dist/access-hub --project-name=access-hub --branch=main
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1

  # Storybook Deployment (Cloudflare Pages) - Production only
  deploy_storybook:
    needs: [setup, test_root]
    if: ${{ inputs.deploy_storybook && inputs.environment == 'production' && needs.test_root.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Storybook
        working-directory: shared-components
        run: pnpm build-storybook
      
      - name: Deploy to Cloudflare Pages
        id: deploy
        working-directory: shared-components
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          pnpm exec wrangler pages project create storybook --production-branch=main || true
          pnpm exec wrangler pages deploy storybook-static --project-name=storybook --branch=main
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check Cloudflare dashboard and rollback if needed"
          exit 1

  # GitHub Pages Deployment - Build (Production only)
  deploy_pages_build:
    needs: [setup, test_root]
    if: ${{ inputs.deploy_pages && inputs.environment == 'production' && needs.test_root.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Build Svelte app
        env:
          VITE_BASE_PATH: /
        run: pnpm build
      
      - name: Copy build output to dist root
        run: |
          # Build outputs to dist/stream-suite/, but GitHub Pages needs files at dist/ root
          # Copy all files from dist/stream-suite/ to dist/ to fix the 404 issue
          if [ -d "dist/stream-suite" ] && [ "$(ls -A dist/stream-suite 2>/dev/null)" ]; then
            echo "Copying files from dist/stream-suite/ to dist/..."
            cp -r dist/stream-suite/. dist/ || cp -r dist/stream-suite/* dist/
            echo "âœ“ Files copied successfully"
            # Remove the stream-suite subdirectory after copying
            rm -rf dist/stream-suite
            echo "âœ“ Cleaned up dist/stream-suite/"
          else
            echo "âš  Warning: dist/stream-suite/ does not exist or is empty"
            echo "Build may have failed or output directory changed"
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Create .nojekyll
        run: touch dist/.nojekyll
      
      - name: Create CNAME file for custom domain
        run: echo "streamkit.idling.app" > dist/CNAME
      
      - name: Copy config.js to dist
        run: cp config.js dist/config.js
      
      - name: Copy legacy assets
        run: |
          mkdir -p dist/assets/js/modules
          cp assets/js/modules/installer.js dist/assets/js/modules/installer.js || echo "installer.js not found, skipping"
      
      - name: Inject Auto-Configuration
        env:
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          CF_WORKERS_SUBDOMAIN: ${{ secrets.CF_WORKERS_SUBDOMAIN }}
          CUSTOM_DOMAIN: ${{ secrets.CUSTOM_DOMAIN || 'streamkit.idling.app' }}
        run: |
          # Read worker name from wrangler.toml (correct path: serverless/twitch-api/wrangler.toml)
          # CRITICAL: Validate WORKER_NAME to prevent malformed URLs
          WORKER_NAME=$(grep '^name = ' serverless/twitch-api/wrangler.toml | sed 's/name = "\(.*\)"/\1/' || echo "")
          
          # Validate WORKER_NAME - if empty or invalid, use fallback
          if [ -z "$WORKER_NAME" ] || [ "$WORKER_NAME" = "" ]; then
            echo "âš  Warning: Could not read worker name from wrangler.toml, using fallback"
            WORKER_NAME="strixun-twitch-api"
          fi
          
          SUBDOMAIN="${CF_WORKERS_SUBDOMAIN:-strixuns-script-suite}"
          
          # CRITICAL: Validate SUBDOMAIN to prevent malformed URLs
          if [ -z "$SUBDOMAIN" ] || [ "$SUBDOMAIN" = "" ]; then
            echo "âš  Warning: CF_WORKERS_SUBDOMAIN is empty, using fallback"
            SUBDOMAIN="strixuns-script-suite"
          fi
          
          # Construct URL with validation
          WORKER_URL="https://${WORKER_NAME}.${SUBDOMAIN}.workers.dev"
          
          # CRITICAL: Validate final URL format before injection
          if [[ "$WORKER_URL" =~ ^https://\..*\.workers\.dev$ ]] || [[ "$WORKER_URL" =~ ^https://.*\.\..*\.workers\.dev$ ]]; then
            echo "âœ— ERROR: Malformed WORKER_URL detected: $WORKER_URL"
            echo "âœ— This would cause browser lockup. Aborting deployment."
            exit 1
          fi
          
          echo "âœ“ Validated Worker URL: $WORKER_URL"
          
          OTP_AUTH_URL="https://auth.idling.app"
          CUSTOM_DOMAIN="${CUSTOM_DOMAIN:-streamkit.idling.app}"
          PAGES_URL="https://${CUSTOM_DOMAIN}/"
          STORYBOOK_URL="${PAGES_URL}storybook/"
          DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # CRITICAL: Validate all URLs before injection to prevent malformed URLs
          if [[ "$WORKER_URL" =~ ^https?://\. ]] || [[ "$WORKER_URL" =~ \.\. ]] || [[ -z "$WORKER_URL" ]]; then
            echo "âœ— ERROR: Invalid WORKER_URL format: $WORKER_URL"
            exit 1
          fi
          
          if [[ "$OTP_AUTH_URL" =~ ^https?://\. ]] || [[ "$OTP_AUTH_URL" =~ \.\. ]] || [[ -z "$OTP_AUTH_URL" ]]; then
            echo "âœ— ERROR: Invalid OTP_AUTH_URL format: $OTP_AUTH_URL"
            exit 1
          fi
          
          if [[ "$PAGES_URL" =~ ^https?://\. ]] || [[ "$PAGES_URL" =~ \.\. ]] || [[ -z "$PAGES_URL" ]]; then
            echo "âœ— ERROR: Invalid PAGES_URL format: $PAGES_URL"
            exit 1
          fi
          
          # Inject values into config.js in dist directory
          sed -i "s|%%WORKER_API_URL%%|${WORKER_URL}|g" dist/config.js
          sed -i "s|%%OTP_AUTH_API_URL%%|${OTP_AUTH_URL}|g" dist/config.js
          sed -i "s|%%GITHUB_PAGES_URL%%|${PAGES_URL}|g" dist/config.js
          sed -i "s|%%STORYBOOK_URL%%|${STORYBOOK_URL}|g" dist/config.js
          sed -i "s|%%TWITCH_CLIENT_ID%%|${TWITCH_CLIENT_ID}|g" dist/config.js
          sed -i "s|%%DEPLOYED_AT%%|${DEPLOYED_AT}|g" dist/config.js
          sed -i "s|%%DEPLOYMENT_ENV%%|github-pages|g" dist/config.js
          
          # Verify injection succeeded
          if grep -q "%%WORKER_API_URL%%" dist/config.js; then
            echo "âœ— ERROR: Failed to inject WORKER_API_URL - placeholder still present"
            exit 1
          fi
          
          echo "âœ“ Configuration validated and injected successfully"
      
      - name: Upload artifact
        id: upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'dist'
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Build failed - deployment prevented"
          exit 1

  # GitHub Pages Deployment - Deploy
  deploy_pages:
    needs: deploy_pages_build
    if: ${{ inputs.deploy_pages }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âœ— Deployment failed - manual rollback required"
          echo "Please check GitHub Pages settings and rollback if needed"
          exit 1

  # Deployment Summary
  summary:
    needs: [test_root, test_otp_auth, test_twitch_api, test_mods_api, test_customer_api, test_game_api, test_url_shortener, test_access_service, deploy_twitch_api, deploy_mods_api, deploy_otp_auth, deploy_customer_api, deploy_game_api, deploy_url_shortener, deploy_access_service, deploy_mods_hub, deploy_access_hub, deploy_storybook, deploy_pages]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.deploy_mods_hub }}" == "true" ] || [ "${{ inputs.deploy_storybook }}" == "true" ] || [ "${{ inputs.deploy_pages }}" == "true" ]; then
            if [ "${{ needs.test_root.result }}" == "success" ]; then
              echo "âœ“ **Root/Client Tests** - Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_root.result }}" == "failure" ]; then
              echo "âœ— **Root/Client Tests** - Failed (deployment blocked)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Root/Client Tests** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_otp_auth }}" == "true" ]; then
            if [ "${{ needs.test_otp_auth.result }}" == "success" ]; then
              echo "âœ“ **OTP Auth Service Tests** - Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_otp_auth.result }}" == "failure" ]; then
              echo "âœ— **OTP Auth Service Tests** - Failed (deployment blocked)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **OTP Auth Service Tests** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_twitch_api }}" == "true" ]; then
            if [ "${{ needs.test_twitch_api.result }}" == "success" ]; then
              echo "âœ“ **Twitch API Tests** - Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_twitch_api.result }}" == "failure" ]; then
              echo "âœ— **Twitch API Tests** - Failed (deployment blocked)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_twitch_api.result }}" == "skipped" ]; then
              echo "â­ï¸ **Twitch API Tests** - Skipped (no test script)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Twitch API Tests** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_mods_api }}" == "true" ]; then
            if [ "${{ needs.test_mods_api.result }}" == "success" ]; then
              echo "âœ“ **Mods API Tests** - Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_mods_api.result }}" == "failure" ]; then
              echo "âœ— **Mods API Tests** - Failed (deployment blocked)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_mods_api.result }}" == "skipped" ]; then
              echo "â­ï¸ **Mods API Tests** - Skipped (no test script)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Mods API Tests** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_customer_api }}" == "true" ]; then
            if [ "${{ needs.test_customer_api.result }}" == "success" ]; then
              echo "âœ“ **Customer API Tests** - Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_customer_api.result }}" == "failure" ]; then
              echo "âœ— **Customer API Tests** - Failed (deployment blocked)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_customer_api.result }}" == "skipped" ]; then
              echo "â­ï¸ **Customer API Tests** - Skipped (no test script)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Customer API Tests** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_game_api }}" == "true" ]; then
            if [ "${{ needs.test_game_api.result }}" == "success" ]; then
              echo "âœ“ **Game API Tests** - Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_game_api.result }}" == "failure" ]; then
              echo "âœ— **Game API Tests** - Failed (deployment blocked)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_game_api.result }}" == "skipped" ]; then
              echo "â­ï¸ **Game API Tests** - Skipped (no test script)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Game API Tests** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_url_shortener }}" == "true" ]; then
            if [ "${{ needs.test_url_shortener.result }}" == "success" ]; then
              echo "âœ“ **URL Shortener Tests** - Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_url_shortener.result }}" == "failure" ]; then
              echo "âœ— **URL Shortener Tests** - Failed (deployment blocked)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_url_shortener.result }}" == "skipped" ]; then
              echo "â­ï¸ **URL Shortener Tests** - Skipped (no test script)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **URL Shortener Tests** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_access_service }}" == "true" ]; then
            if [ "${{ needs.test_access_service.result }}" == "success" ]; then
              echo "âœ“ **Access Service Tests** - Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_access_service.result }}" == "failure" ]; then
              echo "âœ— **Access Service Tests** - Failed (deployment blocked)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.test_access_service.result }}" == "skipped" ]; then
              echo "â­ï¸ **Access Service Tests** - Skipped (no test script)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ **Access Service Tests** - Skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.deploy_twitch_api }}" == "true" ]; then
            if [ "${{ needs.deploy_twitch_api.result }}" == "success" ]; then
              echo "âœ“ **Twitch API** - Deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **Twitch API** - Deployment Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_mods_api }}" == "true" ]; then
            if [ "${{ needs.deploy_mods_api.result }}" == "success" ]; then
              echo "âœ“ **Mods API** - Deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **Mods API** - Deployment Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_otp_auth }}" == "true" ]; then
            if [ "${{ needs.deploy_otp_auth.result }}" == "success" ]; then
              echo "âœ“ **OTP Auth Service** - Deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **OTP Auth Service** - Deployment Failed or Blocked by Tests" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_customer_api }}" == "true" ]; then
            if [ "${{ needs.deploy_customer_api.result }}" == "success" ]; then
              echo "âœ“ **Customer API** - Deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **Customer API** - Deployment Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_game_api }}" == "true" ]; then
            if [ "${{ needs.deploy_game_api.result }}" == "success" ]; then
              echo "âœ“ **Game API** - Deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **Game API** - Deployment Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_url_shortener }}" == "true" ]; then
            if [ "${{ needs.deploy_url_shortener.result }}" == "success" ]; then
              echo "âœ“ **URL Shortener** - Deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **URL Shortener** - Deployment Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_access_service }}" == "true" ]; then
            if [ "${{ needs.deploy_access_service.result }}" == "success" ]; then
              echo "âœ“ **Access Service** - Deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **Access Service** - Deployment Failed or Blocked by Tests" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_mods_hub }}" == "true" ]; then
            if [ "${{ needs.deploy_mods_hub.result }}" == "success" ]; then
              echo "âœ“ **Mods Hub** - Deployed to Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **Mods Hub** - Deployment Failed or Blocked by Tests" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_access_hub }}" == "true" ]; then
            if [ "${{ needs.deploy_access_hub.result }}" == "success" ]; then
              echo "âœ“ **Access Hub** - Deployed to Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **Access Hub** - Deployment Failed or Blocked by Tests" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_storybook }}" == "true" ]; then
            if [ "${{ needs.deploy_storybook.result }}" == "success" ]; then
              echo "âœ“ **Storybook** - Deployed to Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **Storybook** - Deployment Failed or Blocked by Tests" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "${{ inputs.deploy_pages }}" == "true" ]; then
            if [ "${{ needs.deploy_pages.result }}" == "success" ]; then
              echo "âœ“ **GitHub Pages** - Deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ— **GitHub Pages** - Deployment Failed or Blocked by Tests" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ All selected services have been processed. Tests are required before deployment." >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ”’ Rollback protection: Failed deployments require manual rollback via Cloudflare/GitHub dashboard." >> $GITHUB_STEP_SUMMARY

