# Strixun Stream Suite - E2E Tests Workflow
#
# This workflow runs end-to-end tests against LOCAL Cloudflare Workers (wrangler dev).
# All workers run locally on the CI runner - no deployment required.
#
# Requirements:
#   - Wrangler CLI must be available (installed via pnpm)
#   - Test secrets are automatically generated via setup:test-secrets scripts
#   - Local workers start automatically via playwright.config.ts webServer config
#
# Required GitHub Secrets (Settings > Secrets and variables > Actions):
#   - E2E_TEST_JWT_TOKEN: A valid JWT token for OTP auth service (ask maintainer)
#   - E2E_TEST_OTP_CODE: A 9-digit OTP code for testing (e.g., 123456789)

name: E2E Tests

on:
  workflow_dispatch:
  pull_request:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'apps/mods-hub/**'
      - 'serverless/**'
      - 'playwright.config.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/e2e-tests.yml'

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read

jobs:
  e2e:
    runs-on: ubuntu-latest
    name: Run E2E Tests
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps
      
      - name: Run E2E Tests (Local Workers)
        working-directory: .
        env:
          E2E_TEST_JWT_TOKEN: ${{ secrets.E2E_TEST_JWT_TOKEN }}
          E2E_TEST_OTP_CODE: ${{ secrets.E2E_TEST_OTP_CODE }}
        run: |
          echo "ℹ Running E2E tests against local workers..."
          echo "ℹ Using GitHub secrets for E2E_TEST_JWT_TOKEN and E2E_TEST_OTP_CODE"
          echo "ℹ Local workers will start automatically via playwright.config.ts"
          if [ -z "$E2E_TEST_JWT_TOKEN" ]; then
            echo "✗ E2E_TEST_JWT_TOKEN secret is not set in GitHub repository secrets"
            exit 1
          fi
          if [ -z "$E2E_TEST_OTP_CODE" ]; then
            echo "✗ E2E_TEST_OTP_CODE secret is not set in GitHub repository secrets"
            echo "✗ Please set E2E_TEST_OTP_CODE in GitHub repository secrets (Settings > Secrets and variables > Actions)"
            echo "✗ Example value: 123456789 (9-digit OTP code for testing)"
            exit 1
          fi
          pnpm test:e2e
      
      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
        continue-on-error: true
      
      - name: Upload E2E Screenshots and Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: test-results/
          retention-days: 7
        continue-on-error: true
      
      - name: E2E Test Summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✓ All E2E tests passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests ran against local workers (wrangler dev):" >> $GITHUB_STEP_SUMMARY
            echo "- OTP Auth Service (localhost:8787)" >> $GITHUB_STEP_SUMMARY
            echo "- Mods API (localhost:8788)" >> $GITHUB_STEP_SUMMARY
            echo "- Twitch API (localhost:8789)" >> $GITHUB_STEP_SUMMARY
            echo "- Customer API (localhost:8790)" >> $GITHUB_STEP_SUMMARY
            echo "- Game API (localhost:8791)" >> $GITHUB_STEP_SUMMARY
            echo "- Chat Signaling (localhost:8792)" >> $GITHUB_STEP_SUMMARY
            echo "- URL Shortener (localhost:8793)" >> $GITHUB_STEP_SUMMARY
          else
            echo "✗ E2E tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the uploaded artifacts for:" >> $GITHUB_STEP_SUMMARY
            echo "- Test report: playwright-report/" >> $GITHUB_STEP_SUMMARY
            echo "- Screenshots/videos: test-results/" >> $GITHUB_STEP_SUMMARY
          fi

