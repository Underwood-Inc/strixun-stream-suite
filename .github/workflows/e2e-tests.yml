# Strixun Stream Suite - E2E Tests Workflow
#
# This workflow runs end-to-end tests against development Cloudflare Workers.
# It automatically deploys workers to development environment before running tests.
#
# Requirements:
#   - All workers must have [env.development] configured in wrangler.toml
#   - Development secrets must be set (JWT_SECRET, etc.)
#   - Workers are deployed to development environment before tests run

name: E2E Tests

on:
  workflow_dispatch:
  pull_request:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'mods-hub/**'
      - 'serverless/**'
      - 'playwright.config.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/e2e-tests.yml'

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read

jobs:
  e2e:
    runs-on: ubuntu-latest
    name: Run E2E Tests
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'
      
      - name: Install all dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile
      
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps
      
      - name: Validate Development Worker Configurations (Dry Run)
        working-directory: .
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "[INFO] Validating development worker configurations (dry run)..."
          pnpm deploy:dev:all:dry-run
          if [ $? -ne 0 ]; then
            echo "[ERROR] Development worker configuration validation failed - aborting"
            exit 1
          fi
          echo "[SUCCESS] All worker configurations validated"
      
      - name: Deploy Workers to Development Environment
        working-directory: .
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "[INFO] Deploying all workers to development environment..."
          pnpm deploy:dev:all
          if [ $? -ne 0 ]; then
            echo "[ERROR] Development worker deployment failed - aborting E2E tests"
            exit 1
          fi
          echo "[SUCCESS] All workers deployed to development environment"
      
      - name: Set Development Secrets
        working-directory: .
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "[INFO] Setting development secrets..."
          
          # OTP Auth Service
          cd serverless/otp-auth-service
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET --env development || true
          fi
          if [ -n "${{ secrets.RESEND_API_KEY }}" ]; then
            echo "${{ secrets.RESEND_API_KEY }}" | pnpm exec wrangler secret put RESEND_API_KEY --env development || true
          fi
          if [ -n "${{ secrets.RESEND_FROM_EMAIL }}" ]; then
            echo "${{ secrets.RESEND_FROM_EMAIL }}" | pnpm exec wrangler secret put RESEND_FROM_EMAIL --env development || true
          fi
          
          # Mods API
          cd ../mods-api
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET --env development || true
          fi
          if [ -n "${{ secrets.ALLOWED_EMAILS }}" ]; then
            echo "${{ secrets.ALLOWED_EMAILS }}" | pnpm exec wrangler secret put ALLOWED_EMAILS --env development || true
          fi
          
          # Twitch API
          cd ../twitch-api
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET --env development || true
          fi
          if [ -n "${{ secrets.TWITCH_CLIENT_ID }}" ]; then
            echo "${{ secrets.TWITCH_CLIENT_ID }}" | pnpm exec wrangler secret put TWITCH_CLIENT_ID --env development || true
          fi
          if [ -n "${{ secrets.TWITCH_CLIENT_SECRET }}" ]; then
            echo "${{ secrets.TWITCH_CLIENT_SECRET }}" | pnpm exec wrangler secret put TWITCH_CLIENT_SECRET --env development || true
          fi
          
          # Customer API
          cd ../customer-api
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET --env development || true
          fi
          
          # Game API
          cd ../game-api
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET --env development || true
          fi
          
          # Chat Signaling
          cd ../chat-signaling
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET --env development || true
          fi
          
          # URL Shortener
          cd ../url-shortener
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | pnpm exec wrangler secret put JWT_SECRET --env development || true
          fi
          
          echo "[SUCCESS] Development secrets set"
        continue-on-error: true
      
      - name: Verify Workers Health
        run: |
          echo "[INFO] Verifying development workers are healthy..."
          # Wait a moment for deployments to propagate
          sleep 15
          
          # Check each worker health endpoint
          WORKERS=(
            "OTP Auth:https://otp-auth-service-dev.strixuns-script-suite.workers.dev"
            "Mods API:https://strixun-mods-api-dev.strixuns-script-suite.workers.dev"
            "Twitch API:https://strixun-twitch-api-dev.strixuns-script-suite.workers.dev"
            "Customer API:https://strixun-customer-api-dev.strixuns-script-suite.workers.dev"
            "Game API:https://strixun-game-api-dev.strixuns-script-suite.workers.dev"
            "Chat Signaling:https://strixun-chat-signaling-dev.strixuns-script-suite.workers.dev"
            "URL Shortener:https://strixun-url-shortener-dev.strixuns-script-suite.workers.dev"
          )
          
          FAILED=0
          for WORKER_INFO in "${WORKERS[@]}"; do
            NAME="${WORKER_INFO%%:*}"
            URL="${WORKER_INFO##*:}"
            if curl -f -s --max-time 10 "${URL}/health" > /dev/null 2>&1; then
              echo "[SUCCESS] ${NAME} (${URL}) is healthy"
            else
              echo "[ERROR] ${NAME} (${URL}) is not responding"
              FAILED=$((FAILED + 1))
            fi
          done
          
          if [ $FAILED -gt 0 ]; then
            echo "[ERROR] $FAILED worker(s) failed health checks - aborting E2E tests"
            exit 1
          fi
          echo "[SUCCESS] All workers are healthy"
      
      - name: Run E2E Tests
        working-directory: .
        env:
          E2E_OTP_AUTH_URL: https://otp-auth-service-dev.strixuns-script-suite.workers.dev
          E2E_MODS_API_URL: https://strixun-mods-api-dev.strixuns-script-suite.workers.dev
          E2E_TWITCH_API_URL: https://strixun-twitch-api-dev.strixuns-script-suite.workers.dev
          E2E_CUSTOMER_API_URL: https://strixun-customer-api-dev.strixuns-script-suite.workers.dev
          E2E_GAME_API_URL: https://strixun-game-api-dev.strixuns-script-suite.workers.dev
          E2E_CHAT_SIGNALING_URL: https://strixun-chat-signaling-dev.strixuns-script-suite.workers.dev
          E2E_URL_SHORTENER_URL: https://strixun-url-shortener-dev.strixuns-script-suite.workers.dev
          E2E_FRONTEND_URL: http://localhost:5173
          E2E_MODS_HUB_URL: http://localhost:3001
        run: pnpm test:e2e
      
      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
        continue-on-error: true
      
      - name: Upload E2E Screenshots and Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: test-results/
          retention-days: 7
        continue-on-error: true
      
      - name: E2E Test Summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "[SUCCESS] All E2E tests passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests ran against development worker deployments:" >> $GITHUB_STEP_SUMMARY
            echo "- OTP Auth Service (dev)" >> $GITHUB_STEP_SUMMARY
            echo "- Mods API (dev)" >> $GITHUB_STEP_SUMMARY
            echo "- Twitch API (dev)" >> $GITHUB_STEP_SUMMARY
            echo "- Customer API (dev)" >> $GITHUB_STEP_SUMMARY
            echo "- Game API (dev)" >> $GITHUB_STEP_SUMMARY
            echo "- Chat Signaling (dev)" >> $GITHUB_STEP_SUMMARY
            echo "- URL Shortener (dev)" >> $GITHUB_STEP_SUMMARY
          else
            echo "[ERROR] E2E tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the uploaded artifacts for:" >> $GITHUB_STEP_SUMMARY
            echo "- Test report: playwright-report/" >> $GITHUB_STEP_SUMMARY
            echo "- Screenshots/videos: test-results/" >> $GITHUB_STEP_SUMMARY
          fi

