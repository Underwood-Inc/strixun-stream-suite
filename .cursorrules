# Cursor AI Rules - Strixun Stream Suite

## CSS/SCSS Rules - CRITICAL

### NEVER Use Nested BEM Selectors in Svelte Components
- **ABSOLUTE PROHIBITION**: Never use nested BEM selectors with `&__` or `&--` in Svelte `<style>` blocks
- **Why**: Svelte's scoped styles don't compile nested BEM selectors correctly, causing styles to not apply
- **Solution**: Always use explicit descendant selectors
- **CRITICAL**: This is a compile-time error - the code will not build if you use nested BEM in Svelte components

### [WRONG] - Nested BEM (DO NOT USE - WILL NOT COMPILE):
```scss
.component {
  &__child {
    color: red;
  }
  &--modifier {
    background: blue;
  }
}

.info-item {
  &__label {
    font-weight: bold;
  }
  &__value {
    &--active {
      color: green;
    }
  }
}
```

### [CORRECT] - Explicit Selectors (ALWAYS USE):
```scss
.component {
  // Base styles only
}

.component .component__child {
  color: red;
}

.component .component--modifier {
  background: blue;
}

.info-item {
  // Base styles only
}

.info-item .info-item__label {
  font-weight: bold;
}

.info-item .info-item__value {
  // Value styles
}

.info-item .info-item__value--active {
  color: green;
}
```

### Import Requirements for SCSS Mixins
- **ALWAYS** import mixins/animations at the top of `<style lang="scss">` block
- Use: `@use '../styles/animations' as *;` or `@use '@styles/animations' as *;`
- Required before using mixins like `@include gpu-accelerated;`, `@include fade-in;`, etc.
- Example:
```scss
<style lang="scss">
  @use '../styles/animations' as *;
  
  .my-component {
    @include gpu-accelerated;
  }
</style>
```

### CSS Specificity Rules
- Always use proper selector specificity
- Prefer class selectors over ID selectors
- Use BEM naming conventions for class names: `.block__element--modifier`
- Write explicit descendant selectors: `.parent .parent__child` not `.parent { &__child {} }`
- Use CSS custom properties (variables) for theming: `var(--color-name)`

### CSS Variable Usage
- **ALWAYS** use CSS variables from `_variables.scss` for colors, spacing, etc.
- **NEVER** hardcode color values like `#ff0000` or `rgb(255, 0, 0)`
- Use: `color: var(--text);` not `color: #f9f9f9;`
- Use: `background: var(--card);` not `background: #252017;`

### Positioning and Layout
- Use `position: fixed` for tooltips, modals, and overlays that need to escape parent containers
- Use `position: absolute` for positioned elements within a relative parent
- Use `position: relative` for creating positioning context
- Use `position: sticky` for scroll-sticking elements
- **NEVER** use `position: fixed` inside a `position: relative` container without portal rendering

### Z-Index Management
- Tooltips and overlays: `z-index: 99999` (highest)
- Modals and dialogs: `z-index: 10000`
- Dropdowns and popovers: `z-index: 1000`
- Sticky headers: `z-index: 100`
- Regular content: `z-index: 1` or auto
- **NEVER** use arbitrary z-index values without documentation

### Transitions and Animations
- Always use CSS custom properties for transition durations: `transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);`
- Use `requestAnimationFrame` for JavaScript-driven animations
- Disable transitions during drag/resize operations: `.resizing { transition: none; }`
- Use GPU-accelerated properties: `transform`, `opacity` (not `width`, `height`, `top`, `left`)

### Responsive Design
- Use CSS custom properties for breakpoints
- Mobile-first approach: start with mobile styles, add desktop with `@media (min-width: ...)`
- Use `clamp()` for fluid typography: `font-size: clamp(14px, 2vw, 18px);`
- Use `min()`, `max()`, and `clamp()` for responsive spacing

### Performance
- Use `will-change` sparingly and only for elements that will animate
- Use `transform: translateZ(0)` or `transform: translate3d(0,0,0)` for GPU acceleration
- Avoid animating `width`, `height`, `top`, `left` - use `transform` instead
- Use `contain` property for isolated components: `contain: layout style paint;`

### Portal Rendering
- Tooltips, modals, and overlays MUST be rendered at body level using portals
- Use Svelte actions or manual DOM manipulation to append to `document.body`
- Set portal container: `position: fixed; z-index: 99999; pointer-events: none;`
- Clean up portal containers in `onDestroy`

### Scrollbar Styling
- Use `::-webkit-scrollbar` for WebKit browsers
- Use `scrollbar-width` and `scrollbar-color` for Firefox
- Always provide both WebKit and Firefox fallbacks
- Use CSS variables for scrollbar colors

### Content Adjustment (Layout Shift Prevention)
- When scrollbars appear/disappear, use negative margin + padding to prevent layout shift
- Apply adjustment only when scrollbar is present
- Use CSS variables for dynamic width: `margin-right: var(--scrollbar-width, 0px);`
- Remove adjustment when scrollbar disappears

### Smooth Width Transitions for Side Panels/Overlays
- **CRITICAL**: Transitions must be applied to the element that changes, not parent selectors
- **NEVER** use `:has()` selector for width transitions - CSS transitions don't work on selector matching changes
- **Problem**: When using `:has()` on a parent, the transition is scoped incorrectly and won't animate
  ```scss
  // ‚ùå WRONG - transition won't work because selector matching doesn't trigger transitions
  .parent:has(.child.expanded) .content {
    transition: margin-right 0.3s ease;
    margin-right: 280px;
  }
  ```
- **Solution**: Use CSS variables on the element that needs to transition
  ```scss
  // ‚úÖ CORRECT - transition is on the element that changes
  .content {
    transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-right: var(--filter-aside-width, 0px);
  }
  ```
  ```typescript
  // Set CSS variable on document root, not on parent element
  $: document.documentElement.style.setProperty('--filter-aside-width', expanded ? `${width}px` : '0px');
  ```
- **Why**: CSS transitions only work on property value changes, not selector matching changes
- **Scoping**: The transition must be on the same element that has the property being animated
- This ensures smooth transitions when side panels expand/collapse
- Works for any dynamic width adjustment that needs to animate

## Component Architecture Rules

### Component Composition
- Components MUST be reusable, composable, and unopinionated
- NO business logic in UI components
- Use slots for composition
- Props should be generic and UI-focused
- Use CSS variables for theming, not hardcoded values

### File Organization
- Keep component files under 300 lines
- Split large files into smaller, composable modules
- One component per file
- Co-locate styles with components (Svelte `<style>` blocks)

## TypeScript Rules - CRITICAL

### ABSOLUTE PROHIBITION: JavaScript Files
- **NEVER** create new `.js` files in the codebase
- **NEVER** use JavaScript - ALWAYS use TypeScript (`.ts` extension)
- **ALL** worker files, handlers, routers, services, and utilities MUST be TypeScript
- **Exception**: Only build scripts, config files (svelte.config.js, etc.), and auto-generated files may be `.js`
- **Action Required**: Convert ALL existing `.js` files to `.ts` with proper types

### Type Safety - STRICT REQUIREMENTS
- **NEVER** use `any` type - always use specific types or `unknown` with type guards
- **ALWAYS** define interfaces for object shapes - no inline object types
- **ALWAYS** use type unions for limited value sets: `'top' | 'bottom' | 'left' | 'right'`
- **ALWAYS** export types from files - never use implicit types
- **ALWAYS** type function parameters and return values explicitly
- **ALWAYS** use proper Cloudflare Workers types: `Request`, `Response`, `ExecutionContext`, `KVNamespace`, etc.

### Type Definitions Required
- **ALL** handler functions must have typed parameters: `(request: Request, env: Env, ctx?: ExecutionContext): Promise<Response>`
- **ALL** environment variables must be typed in an `Env` interface
- **ALL** service functions must have typed inputs and outputs
- **ALL** utility functions must have typed parameters and return types
- **ALL** router functions must have proper request/response types

### Example - Correct TypeScript Usage:
```typescript
// ‚úÖ CORRECT - Properly typed handler
interface Env {
  OTP_AUTH_KV: KVNamespace;
  RESEND_API_KEY?: string;
  ENVIRONMENT?: string;
  [key: string]: any;
}

export async function handleRequest(
  request: Request,
  env: Env,
  ctx?: ExecutionContext
): Promise<Response> {
  // Implementation
}
```

### ‚ùå WRONG - JavaScript or Weak Types:
```javascript
// ‚ùå WRONG - JavaScript file
export async function handleRequest(request, env) {
  // No types!
}
```

```typescript
// ‚ùå WRONG - Using 'any'
export async function handleRequest(request: any, env: any): Promise<any> {
  // Weak types!
}
```

### Import Organization
- Group imports: Svelte ‚Üí stores ‚Üí modules ‚Üí types ‚Üí utils
- Use absolute imports with path aliases: `@/components`, `@/stores`
- Never import business logic into UI components
- **ALWAYS** use `.js` extension in TypeScript imports (required for ES modules): `import { x } from './file.js'`

## Text and Symbol Rules - CRITICAL

### NEVER Use Emojis or Unicode Symbols
- **ABSOLUTE PROHIBITION**: Never use emojis (‚úÖ, ‚ö†Ô∏è, ‚ùå, üîí, etc.) or Unicode symbols in code, scripts, or console output
- **Why**: Emojis cause character encoding issues in terminals, PowerShell, older systems, and many development environments
- **Solution**: Always use ASCII-compatible text symbols or plain text
- **Exception**: None. This rule applies to all code, scripts, documentation, and console output

### ‚úÖ CORRECT - ASCII-Compatible Symbols (ALWAYS USE):
```powershell
# PowerShell scripts
Write-Host "‚úì Operation completed" -ForegroundColor Green
Write-Host "‚ö† This is a warning" -ForegroundColor Yellow
Write-Host "‚úó Operation failed" -ForegroundColor Red
Write-Host "‚Ñπ Processing..." -ForegroundColor Cyan
```

```typescript
// TypeScript/JavaScript
console.log('‚úì All services configured successfully!');
console.warn('‚ö† Some services failed');
console.error('‚úó Invalid input');
```

```markdown
# Documentation
- ‚úì Feature implemented
- ‚ö† Deprecated feature
- ‚úó Known issue
- ‚Ñπ Additional information
```

### ‚ùå WRONG - Emojis/Unicode (DO NOT USE):
```powershell
# WRONG - Emojis cause encoding issues
Write-Host "‚úÖ All services configured successfully!"
Write-Host "‚ö†Ô∏è Some services failed"
```

```typescript
// WRONG - Emojis may not display correctly
console.log('‚úÖ All services configured successfully!');
console.warn('‚ö†Ô∏è Some services failed');
```

### ASCII Symbol Alternatives
- Success: `‚úì`, `‚úî`, `+`
- Warning: `‚ö†`, `!`
- Error: `‚úó`, `‚úò`, `X`
- Info: `‚Ñπ`, `i`, `>`
- Checkmark: `‚úì`, `‚úî`
- Cross/X: `‚úó`, `‚úò`, `X`
- Star/Highlight: `‚òÖ`, `‚òÜ`, `*`
- Arrow: `‚Üí`, `‚Üí`, `>`
- Heart: `‚ô•`
- Other: `‚â°`, `~`, `‚Üª`, `‚Ü∫`, `‚áÑ`, `‚äï`

### Preferred Format
Always use ASCII special characters for status indicators:
- `‚úì` instead of ‚úÖ or [SUCCESS]
- `‚ö†` instead of ‚ö†Ô∏è or [WARNING]
- `‚úó` instead of ‚ùå or [ERROR]
- `‚Ñπ` instead of ‚ÑπÔ∏è or [INFO]
- `‚òÖ` instead of [*] or other placeholders

## General Code Quality

### Naming Conventions
- Use descriptive, semantic names
- Use camelCase for variables and functions
- Use PascalCase for components and classes
- Use kebab-case for CSS classes and file names
- Use SCREAMING_SNAKE_CASE for constants

### Documentation
- Document complex logic with inline comments
- Use JSDoc for function documentation
- Include usage examples in component documentation
- Document CSS custom properties and their purpose

### Error Handling
- Always handle edge cases
- Provide fallbacks for missing data
- Use optional chaining: `obj?.prop?.nested`
- Validate inputs in components

## Git Commit Rules

- Use conventional commit syntax: `type(scope): description`
- Types: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`
- Examples:
  - `feat(ui): add tooltip component with portal rendering`
  - `fix(css): remove !important from button styles`
  - `refactor(components): split ActivityLog into smaller modules`

## Testing Considerations

- Components should be testable in isolation
- Avoid side effects in component initialization
- Use dependency injection for services
- Mock external dependencies in tests

## Testing and Build Verification Rules - CRITICAL

### MANDATORY: Verify Tests and Builds Before Completion
- **ABSOLUTE REQUIREMENT**: ALWAYS run tests and verify builds are error-free before marking work as complete or ready for testing
- **NEVER** say work is complete, done, or ready for testing without first:
  1. Running relevant test suites (unit, integration, E2E)
  2. Verifying builds compile without errors
  3. Checking for linting errors
  4. Confirming no TypeScript errors
  5. Verifying affected functionality works

### Before Marking Work Complete:
1. **Run TypeScript Build Check**:
   ```bash
   pnpm build
   # OR for specific packages:
   cd <package-dir> && pnpm build
   ```
   - Must complete with zero errors
   - Fix any TypeScript compilation errors before proceeding

2. **Run Linting**:
   ```bash
   pnpm lint
   # OR check specific files:
   # Use read_lints tool to check edited files
   ```
   - Must have zero linting errors
   - Fix all linting issues before proceeding

3. **Run Relevant Tests**:
   - **For E2E tests**: `pnpm test:e2e <test-file>` or `pnpm test:e2e --grep "<test-name>"`
   - **For unit tests**: `pnpm test <test-file>`
   - **For integration tests**: `pnpm test:integration`
   - Tests must pass or be appropriately skipped
   - If tests fail, fix issues before marking complete

4. **Verify Functionality**:
   - If adding/changing features, verify they work as expected
   - If fixing bugs, verify the fix works
   - Test edge cases and error scenarios

### Completion Checklist:
Before saying "work is complete", "ready for testing", or similar:
- [ ] TypeScript builds successfully (no compilation errors)
- [ ] Linting passes (no linting errors)
- [ ] Relevant tests pass (or are appropriately skipped)
- [ ] Functionality verified (manual or automated)
- [ ] No console errors or warnings in test output

### Exception Cases:
- **Documentation-only changes**: Still verify markdown renders correctly
- **Config-only changes**: Still verify config is valid
- **Test-only changes**: Still verify tests run and pass
- **If tests/builds fail due to unrelated issues**: Document the issue and note it, but still attempt to verify your changes work

### Error Handling:
- If tests fail, DO NOT mark work as complete
- If builds fail, DO NOT mark work as complete
- If linting fails, DO NOT mark work as complete
- Fix issues or document why they cannot be fixed immediately
- Always report test/build status in your completion message

## HTML/Anchor Tag Rules - CRITICAL

### NEVER Add href to Non-Anchor Elements
- **ABSOLUTE PROHIBITION**: Never add `href` attribute to any element other than `<a>` (anchor tag)
- **Why**: `href` is only valid on anchor tags. Using it on other elements (div, button, span, etc.) is invalid HTML and breaks accessibility
- **Solution**: Use proper semantic HTML - if you need a link, use an `<a>` tag
- **Exception**: None. This rule has no exceptions.

### [WRONG] - href on non-anchor elements (DO NOT USE):
```svelte
<!-- WRONG: href on a div -->
<div href="https://example.com">Link</div>

<!-- WRONG: href on a button -->
<button href="https://example.com">Link</button>

<!-- WRONG: href on a span -->
<span href="https://example.com">Link</span>

<!-- WRONG: href on a Card component -->
<Card href="https://example.com">Link</Card>
```

### [CORRECT] - Use anchor tags for links (ALWAYS USE):
```svelte
<!-- CORRECT: href on an anchor tag -->
<a href="https://example.com" target="_blank" rel="noopener noreferrer">Link</a>

<!-- CORRECT: Anchor tag styled as a card -->
<a href="https://example.com" class="card-link" target="_blank" rel="noopener noreferrer">
  <div class="card-content">Link Content</div>
</a>

<!-- CORRECT: Anchor tag with proper styling -->
<a href="https://example.com" class="button-link" target="_blank" rel="noopener noreferrer">
  Click Me
</a>
```

### External Link Best Practices
- Always use `target="_blank"` for external links
- Always include `rel="noopener noreferrer"` for security when using `target="_blank"`
- Use semantic HTML: `<a>` for links, `<button>` for actions, `<div>` for containers
- Style anchor tags with CSS to look like buttons/cards if needed, but keep the semantic HTML