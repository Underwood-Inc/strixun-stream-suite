# Mods API Service - Cloudflare Worker Configuration
# Dedicated worker for mod hosting and version control

name = "strixun-mods-api"
main = "worker.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# KV Namespace for mod metadata
# Created via: wrangler kv namespace create "MODS_KV"
[[kv_namespaces]]
binding = "MODS_KV"
id = "0d3dafe0994046c6a47146c6bd082ad3"

# R2 Bucket for mod files
# Created via: wrangler r2 bucket create "mods-storage"
[[r2_buckets]]
binding = "MODS_R2"
bucket_name = "mods-storage"
# To create: cd serverless/mods-api && wrangler r2 bucket create "mods-storage"

# Environment variables (secrets should be set via wrangler secret put)
# DO NOT put actual secrets here - use wrangler CLI:
#   wrangler secret put JWT_SECRET          # REQUIRED: JWT signing secret (must match OTP auth service)
#   wrangler secret put ALLOWED_EMAILS      # REQUIRED: Comma-separated list of allowed email addresses for upload/management
#   wrangler secret put ALLOWED_ORIGINS     # OPTIONAL: Comma-separated CORS origins (recommended for production)
#   wrangler secret put MODS_PUBLIC_URL     # OPTIONAL: Public URL for R2 bucket (if using custom domain)
#
# IMPORTANT: 
#   - JWT_SECRET must match the OTP auth service secret for authentication to work
#   - ALLOWED_EMAILS restricts who can upload/manage mods (leave unset to allow all authenticated users)

[vars]
ENVIRONMENT = "production"
ROUTES = '[{"pattern":"mods-api.idling.app/mods/*","zone_name":"idling.app"},{"pattern":"mods-api.idling.app/health","zone_name":"idling.app"},{"pattern":"mods-api.idling.app/api/*","zone_name":"idling.app"}]'

# Custom domain configuration
# Matches remote configuration to avoid deployment warnings
# Remote has custom domain route + specific routes in vars.routes (dashboard-only)
# For custom domains, pattern should be just the domain (Cloudflare handles /* automatically)
routes = [
  { pattern = "mods-api.idling.app", zone_name = "idling.app", custom_domain = true },
]

# Note: The remote also has specific routes in vars.routes (dashboard-managed):
# - mods-api.idling.app/mods/*
# - mods-api.idling.app/health
# - mods-api.idling.app/api/*
# These are managed in Cloudflare Dashboard and cannot be set in wrangler.toml
# The frontend (Pages) is on mods.idling.app and handles all frontend paths

# Observability Configuration
# Enables logging and tracing for the worker
[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

