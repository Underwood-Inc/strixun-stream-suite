# Mods API Service - Cloudflare Worker Configuration
# Dedicated worker for mod hosting and version control

name = "strixun-mods-api"
main = "dist/worker.js"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# KV Namespaces and R2 buckets are defined in default [vars] section (production)
# Development environment uses [env.development] section

# Environment variables (secrets should be set via wrangler secret put)
# DO NOT put actual secrets here - use wrangler CLI:
#   wrangler secret put JWT_SECRET          # REQUIRED: JWT signing secret (must match OTP auth service)
#   wrangler secret put MODS_ENCRYPTION_KEY # REQUIRED: Shared encryption key for mod files (minimum 32 characters)
#   wrangler secret put SERVICE_API_KEY     # REQUIRED: Service API key for Access Service authentication
#   wrangler secret put ALLOWED_ORIGINS     # OPTIONAL: Comma-separated CORS origins (recommended for production)
#   wrangler secret put MODS_PUBLIC_URL     # OPTIONAL: Public URL for R2 bucket (if using custom domain)
#
# IMPORTANT: 
#   - JWT_SECRET must match the OTP auth service secret for authentication to work
#   - Upload permissions are managed via Access Service (access-api.idling.app) - NOT environment variables

# Development environment (only used with --env development)
[env.development]
vars = { ENVIRONMENT = "development", JWT_ISSUER = "http://localhost:8787", ACCESS_SERVICE_URL = "http://localhost:8795", NETWORK_INTEGRITY_KEYPHRASE = "test-integrity-keyphrase-for-local-development", JWT_SECRET = "dev-jwt-secret-do-not-use-in-production-abc123", SERVICE_API_KEY = "dev-service-api-key-for-local-testing", MODS_ENCRYPTION_KEY = "dev-mods-encryption-key-32chars-min!", ALLOWED_ORIGINS = "http://localhost:3001,http://localhost:5173,http://localhost:5174,http://localhost:5175,http://localhost:5176,http://localhost:5178,http://localhost:5180,http://localhost:8787,http://localhost:3000" }

# Development Durable Objects
[env.development.durable_objects]
bindings = [
    { name = "DOWNLOAD_COUNTER", class_name = "DownloadCounter" }
]

# Development KV Namespaces (using same namespaces for testing)
[[env.development.kv_namespaces]]
binding = "MODS_KV"
id = "0d3dafe0994046c6a47146c6bd082ad3"

[[env.development.kv_namespaces]]
binding = "OTP_AUTH_KV"
id = "680c9dbe86854c369dd23e278abb41f9"

# Development R2 Bucket (can use same bucket or separate test bucket)
[[env.development.r2_buckets]]
binding = "MODS_R2"
bucket_name = "mods-storage"

# Default configuration (production) - this is the ONLY production config for mods-api
# We use default deployment (wrangler deploy) NOT --env production
[vars]
ENVIRONMENT = "production"
JWT_ISSUER = "https://auth.idling.app"
ACCESS_SERVICE_URL = "https://access-api.idling.app"
# CRITICAL: Required for credentials (cookie) from mods.idling.app - cannot use * with credentials
ALLOWED_ORIGINS = "https://mods.idling.app,https://www.idling.app,https://idling.app,https://auth.idling.app"
ROUTES = '[{"pattern":"mods-api.idling.app/mods/*","zone_name":"idling.app"},{"pattern":"mods-api.idling.app/health","zone_name":"idling.app"},{"pattern":"mods-api.idling.app/api/*","zone_name":"idling.app"}]'

# Durable Objects
[durable_objects]
bindings = [
    { name = "DOWNLOAD_COUNTER", class_name = "DownloadCounter" }
]

[[migrations]]
tag = "v1"
new_classes = ["DownloadCounter"]

# Default KV Namespaces
[[kv_namespaces]]
binding = "MODS_KV"
id = "0d3dafe0994046c6a47146c6bd082ad3"

[[kv_namespaces]]
binding = "OTP_AUTH_KV"
id = "680c9dbe86854c369dd23e278abb41f9"

# Default R2 Bucket
[[r2_buckets]]
binding = "MODS_R2"
bucket_name = "mods-storage"

# Service binding to auth Worker so JWKS fetch uses internal routing (avoids same-zone 522).
# If you deploy otp-auth-service with --env production, set service = "otp-auth-service-production".
[[services]]
binding = "AUTH_SERVICE"
service = "otp-auth-service"

# Default routes (production) - this is the ONLY route configuration
[[routes]]
pattern = "mods-api.idling.app/*"
zone_name = "idling.app"

# Note: The remote also has specific routes in vars.routes (dashboard-managed):
# - mods-api.idling.app/mods/*
# - mods-api.idling.app/health
# - mods-api.idling.app/api/*
# These are managed in Cloudflare Dashboard and cannot be set in wrangler.toml
# The frontend (Pages) is on mods.idling.app and handles all frontend paths

# Observability Configuration
# Enables logging and tracing for the worker
[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

# Scheduled triggers (cron jobs)
# R2 cleanup job - runs daily at 2 AM UTC to permanently delete files marked for deletion 5+ days ago
[triggers]
crons = ["0 2 * * *"]

