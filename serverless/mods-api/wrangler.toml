# Mods API Service - Cloudflare Worker Configuration
# Dedicated worker for mod hosting and version control

name = "strixun-mods-api"
main = "worker.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# KV Namespaces and R2 buckets are now defined per environment below
# Default bindings (for backward compatibility) are in [env.production] section

# Environment variables (secrets should be set via wrangler secret put)
# DO NOT put actual secrets here - use wrangler CLI:
#   wrangler secret put JWT_SECRET          # REQUIRED: JWT signing secret (must match OTP auth service)
#   wrangler secret put MODS_ENCRYPTION_KEY # REQUIRED: Shared encryption key for mod files (minimum 32 characters)
#   wrangler secret put ALLOWED_EMAILS      # REQUIRED: Comma-separated list of allowed email addresses for upload/management
#   wrangler secret put ALLOWED_ORIGINS     # OPTIONAL: Comma-separated CORS origins (recommended for production)
#   wrangler secret put MODS_PUBLIC_URL     # OPTIONAL: Public URL for R2 bucket (if using custom domain)
#
# IMPORTANT: 
#   - JWT_SECRET must match the OTP auth service secret for authentication to work
#   - ALLOWED_EMAILS restricts who can upload/manage mods (leave unset to allow all authenticated users)

# Production environment
[env.production]
vars = { ENVIRONMENT = "production" }
ROUTES = '[{"pattern":"mods-api.idling.app/mods/*","zone_name":"idling.app"},{"pattern":"mods-api.idling.app/health","zone_name":"idling.app"},{"pattern":"mods-api.idling.app/api/*","zone_name":"idling.app"}]'

# Production KV Namespaces
[[env.production.kv_namespaces]]
binding = "MODS_KV"
id = "0d3dafe0994046c6a47146c6bd082ad3"

[[env.production.kv_namespaces]]
binding = "OTP_AUTH_KV"
id = "680c9dbe86854c369dd23e278abb41f9"

# Production R2 Bucket
[[env.production.r2_buckets]]
binding = "MODS_R2"
bucket_name = "mods-storage"

# Production routes (for --env production flag, but we use default deployment instead)
# NOTE: We don't actually use --env production for mods-api, default deployment IS production
# [[env.production.routes]]
# pattern = "mods-api.idling.app"
# zone_name = "idling.app"
# custom_domain = true

# Development environment
[env.development]
vars = { ENVIRONMENT = "development" }

# Development KV Namespaces (using same namespaces for testing)
[[env.development.kv_namespaces]]
binding = "MODS_KV"
id = "0d3dafe0994046c6a47146c6bd082ad3"

[[env.development.kv_namespaces]]
binding = "OTP_AUTH_KV"
id = "680c9dbe86854c369dd23e278abb41f9"

# Development R2 Bucket (can use same bucket or separate test bucket)
[[env.development.r2_buckets]]
binding = "MODS_R2"
bucket_name = "mods-storage"

# Default to production for backward compatibility
# NOTE: Routes should ONLY be defined in [env.production] to avoid duplicate worker deployments
# The default section is kept for backward compatibility but routes are environment-specific
[vars]
ENVIRONMENT = "production"
ROUTES = '[{"pattern":"mods-api.idling.app/mods/*","zone_name":"idling.app"},{"pattern":"mods-api.idling.app/health","zone_name":"idling.app"},{"pattern":"mods-api.idling.app/api/*","zone_name":"idling.app"}]'

# Default KV Namespaces (required for routes configured in dashboard or when no environment is specified)
[[kv_namespaces]]
binding = "MODS_KV"
id = "0d3dafe0994046c6a47146c6bd082ad3"

[[kv_namespaces]]
binding = "OTP_AUTH_KV"
id = "680c9dbe86854c369dd23e278abb41f9"

# Default R2 Bucket (required for routes configured in dashboard or when no environment is specified)
[[r2_buckets]]
binding = "MODS_R2"
bucket_name = "mods-storage"

# CRITICAL: Default routes are REMOVED to prevent duplicate worker deployments
# Routes are ONLY defined in [env.production] section above
# This ensures only ONE worker is deployed for production
# routes = []  # REMOVED - use [env.production.routes] instead

# Note: The remote also has specific routes in vars.routes (dashboard-managed):
# - mods-api.idling.app/mods/*
# - mods-api.idling.app/health
# - mods-api.idling.app/api/*
# These are managed in Cloudflare Dashboard and cannot be set in wrangler.toml
# The frontend (Pages) is on mods.idling.app and handles all frontend paths

# Observability Configuration
# Enables logging and tracing for the worker
[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

# Scheduled triggers (cron jobs)
# R2 cleanup job - runs daily at 2 AM UTC to permanently delete files marked for deletion 5+ days ago
[triggers]
crons = ["0 2 * * *"]

