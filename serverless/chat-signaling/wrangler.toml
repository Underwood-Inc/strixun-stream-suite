name = "strixun-chat-signaling"
main = "dist/worker.js"
compatibility_date = "2024-01-01"

# Production environment
[env.production]
vars = { ENVIRONMENT = "production", JWT_ISSUER = "https://auth.idling.app" }

# Production KV Namespace
[[env.production.kv_namespaces]]
binding = "CHAT_KV"
id = "78a1bd4cd5dc468780de442aacc9d1ee"
preview_id = "78a1bd4cd5dc468780de442aacc9d1ee"

# Development environment
[env.development]
vars = { ENVIRONMENT = "development", JWT_ISSUER = "http://localhost:8787", NETWORK_INTEGRITY_KEYPHRASE = "test-integrity-keyphrase-for-local-development", JWT_SECRET = "dev-jwt-secret-do-not-use-in-production-abc123", ALLOWED_ORIGINS = "http://localhost:3001,http://localhost:5173,http://localhost:5174,http://localhost:5175,http://localhost:5176,http://localhost:5178,http://localhost:5180,http://localhost:8787,http://localhost:3000" }

# Development KV Namespace (using same namespace for testing)
[[env.development.kv_namespaces]]
binding = "CHAT_KV"
id = "78a1bd4cd5dc468780de442aacc9d1ee"
preview_id = "78a1bd4cd5dc468780de442aacc9d1ee"

# Default to production for backward compatibility
[vars]
ENVIRONMENT = "production"
JWT_ISSUER = "https://auth.idling.app"

# Default KV Namespace (required for routes configured in dashboard or when no environment is specified)
[[kv_namespaces]]
binding = "CHAT_KV"
id = "78a1bd4cd5dc468780de442aacc9d1ee"

# Service binding to auth Worker so JWKS fetch uses internal routing (avoids same-zone 522).
[[services]]
binding = "AUTH_SERVICE"
service = "otp-auth-service"

# Note: Create KV namespace with:
# wrangler kv namespace create "CHAT_KV"
# Then update the IDs above

# Environment variables (secrets should be set via wrangler secret put)
# DO NOT put actual secrets here - use wrangler CLI:
#   wrangler secret put JWT_SECRET
#   IMPORTANT: Use the SAME JWT_SECRET as your OTP auth service for compatibility
#   This service validates JWT tokens created by the OTP auth service
#   wrangler secret put ALLOWED_ORIGINS (optional, comma-separated CORS origins)

# Custom domain configuration
# API served at chat-api.idling.app
# Frontend served separately at chat.idling.app
[[routes]]
pattern = "chat-api.idling.app/*"
zone_name = "idling.app"

# Alternative: Configure in Cloudflare Dashboard (recommended for production):
# 1. Go to Cloudflare Dashboard -> Workers & Pages -> strixun-chat-signaling
# 2. Go to Settings -> Triggers -> Custom Domains
# 3. Add custom domain: chat-api.idling.app
# 4. DNS records are automatically managed by Cloudflare
#
# Note: Routes configured in the dashboard take precedence over wrangler.toml

