<!-- API Key Status Card -->
<div class="card">
    <h2>üîë API Key Status</h2>
    <div style="display: flex; align-items: center; margin-bottom: 1rem;">
        <span class="status-indicator" id="keyStatus"></span>
        <span id="keyStatusText">Checking...</span>
    </div>
    <div class="api-key-display">{{API_KEY}}</div>
    <div id="keyDetails" style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-muted);"></div>
</div>

<!-- Step 1: Request OTP -->
<div class="card">
    <div class="step" id="step1">
        <div class="step-number">1</div>
        <div><strong>Request OTP</strong> - Send a one-time password to your email</div>
    </div>
    <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="you@example.com" />
    </div>
    <button id="requestOtpBtn" onclick="requestOTP()">Send OTP</button>
    <div id="requestResult" class="result" style="margin-top: 1rem; display: none;"></div>
</div>

<!-- Step 2: Verify OTP -->
<div class="card">
    <div class="step" id="step2">
        <div class="step-number">2</div>
        <div><strong>Verify OTP</strong> - Enter the 9-digit code from your email</div>
    </div>
    <div class="form-group">
        <label for="otp">OTP Code (9 digits)</label>
        <input type="text" id="otp" placeholder="123456789" maxlength="9" pattern="[0-9]{9}" />
    </div>
    <button id="verifyOtpBtn" onclick="verifyOTP()" disabled>Verify OTP</button>
    <div id="verifyResult" class="result" style="margin-top: 1rem; display: none;"></div>
</div>

<!-- OIDC Token Details (populated after verify-otp) -->
<div class="card" id="oidcTokenCard" style="display: none;">
    <h2>üé´ OIDC Token Details</h2>
    <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
        Tokens returned by <code>/auth/verify-otp</code>. The <code>access_token</code> is RS256-signed
        when <code>OIDC_SIGNING_KEY</code> is configured. The <code>id_token</code> contains identity claims.
    </p>
    <div style="margin-bottom: 0.75rem;">
        <strong>token_type:</strong> <span id="oidcTokenType">‚Äî</span>&nbsp;&nbsp;
        <strong>expires_in:</strong> <span id="oidcExpiresIn">‚Äî</span>s&nbsp;&nbsp;
        <strong>scope:</strong> <code id="oidcScope">‚Äî</code>
    </div>
    <div class="form-group">
        <label>access_token</label>
        <textarea id="oidcAccessToken" rows="2" readonly style="width:100%;font-family:monospace;font-size:0.75rem;resize:vertical;"></textarea>
    </div>
    <div class="form-group">
        <label>id_token <span id="idTokenStatus" style="font-size:0.75rem;color:var(--text-muted);">(not issued ‚Äî OIDC_SIGNING_KEY may not be configured)</span></label>
        <textarea id="oidcIdToken" rows="2" readonly style="width:100%;font-family:monospace;font-size:0.75rem;resize:vertical;"></textarea>
    </div>
    <button onclick="decodeIdToken()">Decode ID Token Claims</button>
    <div id="idTokenDecoded" class="result" style="margin-top: 1rem; display: none;"></div>
</div>

<!-- Step 3: Refresh Tokens -->
<div class="card">
    <div class="step" id="step3">
        <div class="step-number">3</div>
        <div><strong>Refresh Tokens</strong> - Exchange the refresh token for a new access token (simulates silent refresh)</div>
    </div>
    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem;">
        Sends <code>POST /auth/refresh</code> with the <code>refresh_token</code> HttpOnly cookie.
        The old refresh token is invalidated (rotation) and a new access + refresh token pair is returned.
        This works silently until the 7-day absolute max lifetime is reached.
    </p>
    <button id="refreshBtn" onclick="refreshTokens()" disabled>Refresh Tokens</button>
    <div id="refreshResult" class="result" style="margin-top: 1rem; display: none;"></div>
</div>

<!-- Step 4: Get User Info -->
<div class="card">
    <div class="step" id="step4">
        <div class="step-number">4</div>
        <div><strong>Get User Info</strong> - Verify the JWT works</div>
    </div>
    <button id="getMeBtn" onclick="getMe()" disabled>Get User Info</button>
    <div id="meResult" class="result" style="margin-top: 1rem; display: none;"></div>
</div>

<!-- Step 5: Logout -->
<div class="card">
    <div class="step" id="step5">
        <div class="step-number">5</div>
        <div><strong>Logout</strong> - End the session (clears both auth_token and refresh_token cookies, revokes tokens server-side)</div>
    </div>
    <button id="logoutBtn" onclick="logout()" disabled>Logout</button>
    <div id="logoutResult" class="result" style="margin-top: 1rem; display: none;"></div>
</div>

<!-- OIDC-Compliant Infrastructure -->
<div class="card">
    <h2>üåê OIDC Infrastructure</h2>
    <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
        Tokens issued by /auth/verify-otp are RS256-signed and OIDC-compliant.
        Services verify tokens via the JWKS endpoint instead of shared secrets.
    </p>

    <div class="step">
        <div class="step-number">&#x2139;</div>
        <div><strong>Discovery</strong> - OpenID Provider metadata</div>
    </div>
    <button onclick="testDiscovery()">Fetch Discovery Document</button>
    <div id="discoveryResult" class="result" style="margin-top: 1rem; display: none;"></div>

    <div class="step" style="margin-top: 1.5rem;">
        <div class="step-number">&#x1F511;</div>
        <div><strong>JWKS</strong> - Public signing keys for token verification</div>
    </div>
    <button onclick="testJWKS()">Fetch JWKS</button>
    <div id="jwksResult" class="result" style="margin-top: 1rem; display: none;"></div>

    <div class="step" style="margin-top: 1.5rem;">
        <div class="step-number">&#x1F50D;</div>
        <div><strong>Token Introspection</strong> - Validate an access token (API key required)</div>
    </div>
    <div class="form-group">
        <label for="introspectToken">Access Token</label>
        <input type="text" id="introspectToken" placeholder="Paste an access token" />
    </div>
    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem;">
        The embedded API key is sent automatically via <code>X-OTP-API-Key</code> header for caller authentication (RFC 7662 ¬ß2.1).
    </p>
    <button onclick="testIntrospect()">Introspect Token</button>
    <div id="introspectResult" class="result" style="margin-top: 1rem; display: none;"></div>
</div>
