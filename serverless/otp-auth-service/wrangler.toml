# OTP Authentication Service - Cloudflare Worker Configuration
# Standalone multi-tenant OTP authentication service

name = "otp-auth-service"
main = "worker.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# KV Namespace is defined per environment and also at root level for default binding
# Root level binding ensures KV is available when routes are configured in dashboard

# Environment variables (secrets should be set via wrangler secret put)
# DO NOT put actual secrets here - use wrangler CLI:
#   wrangler secret put JWT_SECRET          # REQUIRED: JWT signing secret (use: openssl rand -hex 32)
#   wrangler secret put RESEND_API_KEY       # REQUIRED: Resend API key from https://resend.com/api-keys
#   wrangler secret put RESEND_FROM_EMAIL    # REQUIRED: Verified email address (e.g., noreply@yourdomain.com)
#   wrangler secret put ALLOWED_ORIGINS      # OPTIONAL: Comma-separated CORS origins (recommended for production)
#
# IMPORTANT: The service will fail health checks if required secrets are missing.
# Check secrets: wrangler secret list
# Verify health: curl https://otp-auth-service.strixuns-script-suite.workers.dev/health/ready

# Production environment
[env.production]

[env.production.vars]
ENVIRONMENT = "production"
CUSTOMER_API_URL = "https://customer-api.idling.app"

# Production KV Namespace
[[env.production.kv_namespaces]]
binding = "OTP_AUTH_KV"
id = "680c9dbe86854c369dd23e278abb41f9"

# Routes are configured in Cloudflare Dashboard, not here
# This prevents creating environment-specific workers

# Development environment
[env.development]

[env.development.vars]
ENVIRONMENT = "development"
CUSTOMER_API_URL = "https://strixun-customer-api-dev.strixuns-script-suite.workers.dev"

# Development KV Namespace (using same namespace for testing)
[[env.development.kv_namespaces]]
binding = "OTP_AUTH_KV"
id = "680c9dbe86854c369dd23e278abb41f9"

# Routes are configured in Cloudflare Dashboard, not here
# This prevents creating environment-specific workers

# Default to production for backward compatibility
[vars]
ENVIRONMENT = "production"
CUSTOMER_API_URL = "https://customer-api.idling.app"

# Default KV Namespace (required for routes configured in dashboard or when no environment is specified)
[[kv_namespaces]]
binding = "OTP_AUTH_KV"
id = "680c9dbe86854c369dd23e278abb41f9"

# Routes are configured in Cloudflare Dashboard, not in wrangler.toml
# This ensures we deploy to the base worker name (otp-auth-service) without environment suffixes

# Alternative: Configure in Cloudflare Dashboard (recommended for production):
# 1. Go to Cloudflare Dashboard → Workers & Pages → otp-auth-service
# 2. Go to Settings → Triggers → Routes
# 3. Add custom domain route: auth.idling.app/*
# 4. DNS records are automatically managed by Cloudflare
#
# Note: Routes configured in the dashboard take precedence over wrangler.toml

# Observability Configuration
# Enables logging and tracing for the worker
[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

