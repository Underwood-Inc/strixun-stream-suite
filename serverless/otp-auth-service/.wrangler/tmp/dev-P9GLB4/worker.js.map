{
  "version": 3,
  "sources": ["../bundle-zPZknG/checked-fetch.js", "../../../landing-html.js", "../../../openapi-json.js", "../../../utils/cache.js", "../../../utils/crypto.js", "../../../utils/email.js", "../../../services/customer.js", "../../../services/api-key.js", "../../../services/rate-limit.js", "../../../services/analytics.js", "../../../services/webhooks.js", "../../../services/security.js", "../../../worker.js", "../../../../../node_modules/.pnpm/wrangler@4.56.0/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../../node_modules/.pnpm/wrangler@4.56.0/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-zPZknG/middleware-insertion-facade.js", "../../../../../node_modules/.pnpm/wrangler@4.56.0/node_modules/wrangler/templates/middleware/common.ts", "../bundle-zPZknG/middleware-loader.entry.ts"],
  "sourceRoot": "C:\\Users\\mamop\\Documents\\source fade script plugin\\serverless\\otp-auth-service\\.wrangler\\tmp\\dev-P9GLB4",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "// Landing page HTML embedded as a module\r\n// This file is generated from landing.html\r\n// To regenerate: node -e \"const fs=require('fs'); const h=fs.readFileSync('landing.html','utf8'); console.log('export default `' + h.replace(/\\\\/g,'\\\\\\\\').replace(/`/g,'\\\\`').replace(/\\${/g,'\\\\${') + '`;');\" > landing-html.js\r\n\r\n// For now, we'll use a simple approach - the HTML will be embedded during deployment\r\n// This is a placeholder that will be replaced with the actual HTML content\r\nexport default `<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>OTP Authentication API - Passwordless Auth for Modern Apps</title>\r\n    <meta name=\"description\" content=\"Secure, passwordless OTP authentication API. Easy integration with React, Svelte, and vanilla JavaScript. Enterprise-grade security with multi-tenancy support.\">\r\n    <style>\r\n        * { margin: 0; padding: 0; box-sizing: border-box; }\r\n        :root {\r\n            --bg: #1a1611; --bg-dark: #0f0e0b; --card: #252017; --border: #3d3627; --border-light: #4a4336;\r\n            --accent: #edae49; --accent-light: #f9df74; --accent-dark: #c68214; --accent2: #6495ed;\r\n            --success: #28a745; --warning: #ffc107; --danger: #ea2b1f; --info: #6495ed;\r\n            --text: #f9f9f9; --text-secondary: #b8b8b8; --muted: #888;\r\n            --spacing-xs: 8px; --spacing-sm: 12px; --spacing-md: 16px; --spacing-lg: 24px;\r\n            --spacing-xl: 32px; --spacing-2xl: 48px; --spacing-3xl: 64px;\r\n            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px;\r\n            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);\r\n            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);\r\n            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);\r\n        }\r\n        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }\r\n        ::-webkit-scrollbar { width: 6px; height: 6px; }\r\n        ::-webkit-scrollbar-track { background: transparent; }\r\n        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }\r\n        ::-webkit-scrollbar-thumb:hover { background: var(--muted); }\r\n        * { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }\r\n        .header { background: rgba(37, 32, 23, 0.95); border-bottom: 1px solid var(--border); padding: var(--spacing-md) var(--spacing-xl); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }\r\n        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }\r\n        .logo { font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-decoration: none; }\r\n        .header-actions { display: flex; gap: var(--spacing-md); align-items: center; }\r\n        .btn { padding: var(--spacing-sm) var(--spacing-lg); border: 3px solid; border-radius: 0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1); text-decoration: none; display: inline-block; background: transparent; color: var(--text); }\r\n        .btn-primary { background: var(--accent); border-color: var(--accent-dark); color: #000; box-shadow: 0 4px 0 var(--accent-dark); }\r\n        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 0 var(--accent-dark); }\r\n        .btn-primary:active:not(:disabled) { transform: translateY(2px); box-shadow: 0 2px 0 var(--accent-dark); }\r\n        .btn-secondary { border-color: var(--border-light); color: var(--text); }\r\n        .btn-secondary:hover { background: var(--border); border-color: var(--border-light); }\r\n        .hero { padding: var(--spacing-3xl) var(--spacing-xl); text-align: center; max-width: 1200px; margin: 0 auto; }\r\n        .hero h1 { font-size: clamp(2.5rem, 5vw, 4rem); margin-bottom: var(--spacing-lg); background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1.2; }\r\n        .hero p { font-size: clamp(1.1rem, 2vw, 1.5rem); color: var(--text-secondary); margin-bottom: var(--spacing-2xl); max-width: 800px; margin-left: auto; margin-right: auto; }\r\n        .hero-cta { display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap; }\r\n        .features { padding: var(--spacing-3xl) var(--spacing-xl); max-width: 1200px; margin: 0 auto; }\r\n        .features h2 { text-align: center; font-size: clamp(2rem, 4vw, 3rem); margin-bottom: var(--spacing-2xl); color: var(--accent); }\r\n        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-3xl); }\r\n        .feature-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--spacing-xl); transition: transform 0.2s, box-shadow 0.2s; }\r\n        .feature-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--border-light); }\r\n        .feature-icon { font-size: 2.5rem; margin-bottom: var(--spacing-md); }\r\n        .feature-card h3 { font-size: 1.25rem; margin-bottom: var(--spacing-sm); color: var(--accent); }\r\n        .feature-card p { color: var(--text-secondary); }\r\n        .security { background: var(--bg-dark); padding: var(--spacing-3xl) var(--spacing-xl); margin: var(--spacing-3xl) 0; }\r\n        .security-content { max-width: 1200px; margin: 0 auto; }\r\n        .security h2 { text-align: center; font-size: clamp(2rem, 4vw, 3rem); margin-bottom: var(--spacing-2xl); color: var(--accent); }\r\n        .security-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg); }\r\n        .security-item { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--spacing-lg); border-left: 4px solid var(--success); }\r\n        .security-item h3 { color: var(--success); margin-bottom: var(--spacing-sm); }\r\n        .code-examples { padding: var(--spacing-3xl) var(--spacing-xl); max-width: 1200px; margin: 0 auto; }\r\n        .code-examples h2 { text-align: center; font-size: clamp(2rem, 4vw, 3rem); margin-bottom: var(--spacing-2xl); color: var(--accent); }\r\n        .code-tabs { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); flex-wrap: wrap; border-bottom: 2px solid var(--border); }\r\n        .code-tab { padding: var(--spacing-sm) var(--spacing-lg); background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); cursor: pointer; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; margin-bottom: -2px; }\r\n        .code-tab:hover { color: var(--text); border-bottom-color: var(--border-light); }\r\n        .code-tab.active { color: var(--accent); border-bottom-color: var(--accent); }\r\n        .code-block { background: var(--bg-dark); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--spacing-lg); overflow-x: auto; display: none; }\r\n        .code-block.active { display: block; }\r\n        .code-block pre { margin: 0; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; font-size: 0.875rem; line-height: 1.6; color: var(--text); }\r\n        .code-block code { color: var(--text); }\r\n        .accordion { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: var(--spacing-md); overflow: hidden; }\r\n        .accordion-header { padding: var(--spacing-lg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-dark); transition: background 0.2s; }\r\n        .accordion-header:hover { background: var(--card); }\r\n        .accordion-header h3 { font-size: 1.1rem; color: var(--text); margin: 0; }\r\n        .accordion-icon { transition: transform 0.3s; color: var(--accent); font-size: 1.25rem; }\r\n        .accordion.active .accordion-icon { transform: rotate(180deg); }\r\n        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }\r\n        .accordion.active .accordion-content { max-height: 5000px; }\r\n        .accordion-body { padding: var(--spacing-lg); color: var(--text-secondary); }\r\n        .accordion-body h4 { color: var(--accent); margin-top: var(--spacing-lg); margin-bottom: var(--spacing-sm); }\r\n        .accordion-body ul { margin-left: var(--spacing-lg); margin-bottom: var(--spacing-md); }\r\n        .accordion-body li { margin-bottom: var(--spacing-xs); }\r\n        .limitations { padding: var(--spacing-3xl) var(--spacing-xl); max-width: 1200px; margin: 0 auto; }\r\n        .limitations h2 { text-align: center; font-size: clamp(2rem, 4vw, 3rem); margin-bottom: var(--spacing-2xl); color: var(--accent); }\r\n        .limitations-list { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--spacing-xl); }\r\n        .limitations-list ul { list-style: none; margin: 0; }\r\n        .limitations-list li { padding: var(--spacing-md); border-bottom: 1px solid var(--border); color: var(--text-secondary); }\r\n        .limitations-list li:last-child { border-bottom: none; }\r\n        .limitations-list li strong { color: var(--accent); display: block; margin-bottom: var(--spacing-xs); }\r\n        .footer { background: var(--bg-dark); border-top: 1px solid var(--border); padding: var(--spacing-xl); text-align: center; color: var(--text-secondary); margin-top: var(--spacing-3xl); }\r\n        @media (max-width: 768px) {\r\n            .hero { padding: var(--spacing-2xl) var(--spacing-md); }\r\n            .features, .code-examples, .limitations { padding: var(--spacing-2xl) var(--spacing-md); }\r\n            .header-content { flex-direction: column; gap: var(--spacing-md); }\r\n            .code-tabs { overflow-x: auto; }\r\n        }\r\n        .mermaid-container { background: var(--bg-dark); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--spacing-lg); margin: var(--spacing-lg) 0; overflow-x: auto; }\r\n    </style>\r\n</head>\r\n<body>\r\n    <header class=\"header\">\r\n        <div class=\"header-content\">\r\n            <a href=\"/\" class=\"logo\">\uD83D\uDD10 OTP Auth API</a>\r\n            <div class=\"header-actions\">\r\n                <a href=\"#code-examples\" class=\"btn btn-secondary\">Get Started</a>\r\n                <a href=\"#docs\" class=\"btn btn-primary\">Documentation</a>\r\n            </div>\r\n        </div>\r\n    </header>\r\n    <section class=\"hero\">\r\n        <h1>Passwordless Authentication Made Simple</h1>\r\n        <p>Secure, scalable OTP authentication API built for modern applications. No passwords, no complexity\u2014just email verification that works.</p>\r\n        <div class=\"hero-cta\">\r\n            <a href=\"#code-examples\" class=\"btn btn-primary\">Start Integrating</a>\r\n            <a href=\"#security\" class=\"btn btn-secondary\">Learn About Security</a>\r\n        </div>\r\n    </section>\r\n    <section class=\"features\">\r\n        <h2>Why Choose OTP Auth?</h2>\r\n        <div class=\"features-grid\">\r\n            <div class=\"feature-card\"><div class=\"feature-icon\">\u26A1</div><h3>Lightning Fast</h3><p>Built on Cloudflare Workers for global edge deployment. Sub-100ms response times worldwide.</p></div>\r\n            <div class=\"feature-card\"><div class=\"feature-icon\">\uD83D\uDD12</div><h3>Enterprise Security</h3><p>Cryptographically secure OTP codes, JWT tokens, rate limiting, and comprehensive audit logging.</p></div>\r\n            <div class=\"feature-card\"><div class=\"feature-icon\">\uD83D\uDE80</div><h3>Easy Integration</h3><p>Simple REST API that works with any framework. React, Svelte, Vue, or vanilla JavaScript\u2014we've got you covered.</p></div>\r\n            <div class=\"feature-card\"><div class=\"feature-icon\">\uD83D\uDCCA</div><h3>Multi-Tenant Ready</h3><p>Built for SaaS applications. Complete customer isolation, per-tenant rate limiting, and usage analytics.</p></div>\r\n            <div class=\"feature-card\"><div class=\"feature-icon\">\uD83D\uDCB0</div><h3>Cost Effective</h3><p>Pay only for what you use. No infrastructure to manage, no servers to maintain.</p></div>\r\n            <div class=\"feature-card\"><div class=\"feature-icon\">\uD83C\uDF0D</div><h3>Global Scale</h3><p>Deployed on Cloudflare's edge network. Your users get the same fast experience anywhere in the world.</p></div>\r\n        </div>\r\n    </section>\r\n    <section class=\"security\" id=\"security\">\r\n        <div class=\"security-content\">\r\n            <h2>Security You Can Trust</h2>\r\n            <div class=\"security-grid\">\r\n                <div class=\"security-item\"><h3>\uD83D\uDD10 Cryptographically Secure</h3><p>6-digit OTP codes generated using cryptographically secure random number generators. 1 million possible combinations.</p></div>\r\n                <div class=\"security-item\"><h3>\u23F1\uFE0F Time-Limited</h3><p>OTP codes expire after 10 minutes. Single-use only\u2014once verified, the code is immediately invalidated.</p></div>\r\n                <div class=\"security-item\"><h3>\uD83D\uDEE1\uFE0F Brute Force Protection</h3><p>Maximum 5 verification attempts per OTP code. After that, a new code must be requested.</p></div>\r\n                <div class=\"security-item\"><h3>\uD83D\uDEA6 Rate Limiting</h3><p>3 OTP requests per email per hour. Prevents abuse and email spam while maintaining usability.</p></div>\r\n                <div class=\"security-item\"><h3>\uD83C\uDFAB JWT Tokens</h3><p>HMAC-SHA256 signed tokens with 7-hour expiration. Token blacklisting for secure logout.</p></div>\r\n                <div class=\"security-item\"><h3>\uD83D\uDCDD Audit Logging</h3><p>Comprehensive security event logging with 90-day retention. Track all authentication attempts and failures.</p></div>\r\n                <div class=\"security-item\"><h3>\uD83C\uDF10 CORS Protection</h3><p>Configurable CORS policies per customer. IP allowlisting for additional security layers.</p></div>\r\n                <div class=\"security-item\"><h3>\u2705 GDPR Compliant</h3><p>Data export and deletion endpoints. Complete user data portability and right to be forgotten.</p></div>\r\n            </div>\r\n        </div>\r\n    </section>\r\n    <section class=\"code-examples\" id=\"code-examples\">\r\n        <h2>Get Started in Minutes</h2>\r\n        <p style=\"text-align: center; color: var(--text-secondary); margin-bottom: var(--spacing-xl);\">Choose your framework and start integrating. All examples use the same simple API.</p>\r\n        <div class=\"code-tabs\">\r\n            <button class=\"code-tab active\" onclick=\"switchTab('vanilla')\">Vanilla JS/TS</button>\r\n            <button class=\"code-tab\" onclick=\"switchTab('react')\">React</button>\r\n            <button class=\"code-tab\" onclick=\"switchTab('svelte')\">Svelte</button>\r\n        </div>\r\n        <div id=\"vanilla\" class=\"code-block active\"><pre><code>// Vanilla JavaScript/TypeScript Example\r\nconst API_URL = 'https://auth.idling.app';\r\nasync function requestOTP(email) {\r\n  const response = await fetch(\\`\\${API_URL}/auth/request-otp\\`, {\r\n    method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ email })\r\n  });\r\n  if (!response.ok) throw new Error('Failed to request OTP');\r\n  return await response.json();\r\n}\r\nasync function verifyOTP(email, otp) {\r\n  const response = await fetch(\\`\\${API_URL}/auth/verify-otp\\`, {\r\n    method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ email, otp })\r\n  });\r\n  if (!response.ok) throw new Error('Invalid OTP');\r\n  const data = await response.json();\r\n  localStorage.setItem('auth_token', data.token);\r\n  return data;\r\n}</code></pre></div>\r\n        <div id=\"react\" class=\"code-block\"><pre><code>// React Example\r\nimport React, { useState } from 'react';\r\nconst API_URL = 'https://auth.idling.app';\r\nfunction LoginForm() {\r\n  const [email, setEmail] = useState('');\r\n  const [otp, setOtp] = useState('');\r\n  const [step, setStep] = useState('email');\r\n  const requestOTP = async () => {\r\n    const response = await fetch(\\`\\${API_URL}/auth/request-otp\\`, {\r\n      method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ email })\r\n    });\r\n    if (response.ok) setStep('otp');\r\n  };\r\n  // ... rest of component\r\n}</code></pre></div>\r\n        <div id=\"svelte\" class=\"code-block\"><pre><code>&lt;!-- Svelte Example --&gt;\r\n&lt;script&gt;\r\n  let email = ''; let otp = ''; let step = 'email';\r\n  const API_URL = 'https://auth.idling.app';\r\n  async function requestOTP() {\r\n    const response = await fetch(\\`\\${API_URL}/auth/request-otp\\`, {\r\n      method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ email })\r\n    });\r\n    if (response.ok) step = 'otp';\r\n  }\r\n&lt;/script&gt;</code></pre></div>\r\n    </section>\r\n    <section class=\"limitations\">\r\n        <h2>Limitations & Considerations</h2>\r\n        <div class=\"limitations-list\">\r\n            <ul>\r\n                <li><strong>Rate Limits</strong><p>3 OTP requests per email address per hour to prevent abuse and email spam.</p></li>\r\n                <li><strong>OTP Expiration</strong><p>OTP codes expire after 10 minutes. Users must request a new code if expired.</p></li>\r\n                <li><strong>Verification Attempts</strong><p>Maximum 5 verification attempts per OTP code. After that, a new code must be requested.</p></li>\r\n                <li><strong>Token Expiration</strong><p>JWT tokens expire after 7 hours. Use the refresh endpoint to extend sessions.</p></li>\r\n                <li><strong>Email Delivery</strong><p>OTP delivery depends on email provider reliability. Check spam folders if code doesn't arrive.</p></li>\r\n                <li><strong>Multi-Tenancy</strong><p>API key authentication required for multi-tenant features. Contact us for enterprise setup.</p></li>\r\n            </ul>\r\n        </div>\r\n    </section>\r\n    <section class=\"code-examples\" id=\"docs\">\r\n        <h2>Technical Documentation</h2>\r\n        <p style=\"text-align: center; color: var(--text-secondary); margin-bottom: var(--spacing-xl);\">Expand sections below for detailed technical information</p>\r\n        <div class=\"accordion\">\r\n            <div class=\"accordion-header\" onclick=\"toggleAccordion(this)\"><h3>API Endpoints</h3><span class=\"accordion-icon\">\u25BC</span></div>\r\n            <div class=\"accordion-content\"><div class=\"accordion-body\">\r\n                <h4>Authentication Endpoints</h4>\r\n                <ul>\r\n                    <li><strong>POST /auth/request-otp</strong> - Request OTP code via email</li>\r\n                    <li><strong>POST /auth/verify-otp</strong> - Verify OTP and receive JWT token</li>\r\n                    <li><strong>GET /auth/me</strong> - Get current user info (requires Bearer token)</li>\r\n                    <li><strong>POST /auth/logout</strong> - Logout and revoke token</li>\r\n                    <li><strong>POST /auth/refresh</strong> - Refresh expiring JWT token</li>\r\n                </ul>\r\n            </div></div>\r\n        </div>\r\n        <div class=\"accordion\">\r\n            <div class=\"accordion-header\" onclick=\"toggleAccordion(this)\"><h3>Architecture</h3><span class=\"accordion-icon\">\u25BC</span></div>\r\n            <div class=\"accordion-content\"><div class=\"accordion-body\">\r\n                <h4>System Architecture</h4>\r\n                <div class=\"mermaid-container\"><pre class=\"mermaid\">graph TB\r\n    Client[Client Application] -->|1. Request OTP| API[Cloudflare Worker]\r\n    API -->|2. Generate OTP| KV[Cloudflare KV]\r\n    API -->|3. Send Email| Email[Resend/SendGrid]\r\n    Email -->|4. Deliver OTP| User[User Email]\r\n    User -->|5. Enter OTP| Client\r\n    Client -->|6. Verify OTP| API\r\n    API -->|7. Validate| KV\r\n    API -->|8. Issue JWT| Client\r\n    Client -->|9. Authenticated Requests| API</pre></div>\r\n            </div></div>\r\n        </div>\r\n    </section>\r\n    <footer class=\"footer\">\r\n        <p>OTP Authentication API - Powered by Cloudflare Workers</p>\r\n        <p style=\"margin-top: var(--spacing-sm); font-size: 0.875rem;\">Part of the Strixun Stream Suite</p>\r\n    </footer>\r\n    <script>\r\n        function switchTab(tabName) {\r\n            document.querySelectorAll('.code-block').forEach(b => b.classList.remove('active'));\r\n            document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));\r\n            document.getElementById(tabName).classList.add('active');\r\n            event.target.classList.add('active');\r\n        }\r\n        function toggleAccordion(header) {\r\n            const accordion = header.parentElement;\r\n            const isActive = accordion.classList.contains('active');\r\n            document.querySelectorAll('.accordion').forEach(a => a.classList.remove('active'));\r\n            if (!isActive) accordion.classList.add('active');\r\n        }\r\n        document.querySelectorAll('a[href^=\"#\"]').forEach(a => {\r\n            a.addEventListener('click', function(e) {\r\n                e.preventDefault();\r\n                const target = document.querySelector(this.getAttribute('href'));\r\n                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n            });\r\n        });\r\n    </script>\r\n</body>\r\n</html>`;\r\n\r\n", "// OpenAPI 3.1.0 Specification embedded as a module\r\n// This file is generated from openapi.json\r\n// To regenerate: node generate-openapi-embed.js\r\n\r\nexport default JSON.parse(`{\r\n  \"openapi\": \"3.1.0\",\r\n  \"info\": {\r\n    \"title\": \"OTP Auth API\",\r\n    \"description\": \"Secure, passwordless OTP authentication API built for modern applications. Enterprise-grade security with multi-tenancy support.\",\r\n    \"version\": \"2.0.0\",\r\n    \"contact\": {\r\n      \"name\": \"OTP Auth API Support\",\r\n      \"url\": \"https://auth.idling.app\"\r\n    },\r\n    \"license\": {\r\n      \"name\": \"Proprietary\"\r\n    }\r\n  },\r\n  \"servers\": [\r\n    {\r\n      \"url\": \"https://auth.idling.app\",\r\n      \"description\": \"Production server\"\r\n    }\r\n  ],\r\n  \"tags\": [\r\n    {\r\n      \"name\": \"Authentication\",\r\n      \"description\": \"OTP-based authentication endpoints\"\r\n    },\r\n    {\r\n      \"name\": \"User\",\r\n      \"description\": \"User information and session management\"\r\n    },\r\n    {\r\n      \"name\": \"Admin\",\r\n      \"description\": \"Administrative endpoints (requires authentication)\"\r\n    },\r\n    {\r\n      \"name\": \"Health\",\r\n      \"description\": \"Health check endpoints\"\r\n    }\r\n  ],\r\n  \"paths\": {\r\n    \"/auth/request-otp\": {\r\n      \"post\": {\r\n        \"tags\": [\"Authentication\"],\r\n        \"summary\": \"Request OTP code\",\r\n        \"description\": \"Request a 6-digit OTP code to be sent to the specified email address\",\r\n        \"operationId\": \"requestOTP\",\r\n        \"requestBody\": {\r\n          \"required\": true,\r\n          \"content\": {\r\n            \"application/json\": {\r\n              \"schema\": {\r\n                \"$ref\": \"#/components/schemas/RequestOTPRequest\"\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"OTP sent successfully\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/RequestOTPResponse\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"400\": {\r\n            \"description\": \"Bad request\",\r\n            \"content\": {\r\n              \"application/problem+json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ProblemDetails\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"429\": {\r\n            \"description\": \"Rate limit exceeded\",\r\n            \"content\": {\r\n              \"application/problem+json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ProblemDetails\"\r\n                }\r\n              }\r\n            },\r\n            \"headers\": {\r\n              \"Retry-After\": {\r\n                \"schema\": {\r\n                  \"type\": \"integer\"\r\n                },\r\n                \"description\": \"Seconds to wait before retrying\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/auth/verify-otp\": {\r\n      \"post\": {\r\n        \"tags\": [\"Authentication\"],\r\n        \"summary\": \"Verify OTP code\",\r\n        \"description\": \"Verify the OTP code and receive a JWT access token\",\r\n        \"operationId\": \"verifyOTP\",\r\n        \"requestBody\": {\r\n          \"required\": true,\r\n          \"content\": {\r\n            \"application/json\": {\r\n              \"schema\": {\r\n                \"$ref\": \"#/components/schemas/VerifyOTPRequest\"\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"OTP verified successfully\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/TokenResponse\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"401\": {\r\n            \"description\": \"Invalid OTP code\",\r\n            \"content\": {\r\n              \"application/problem+json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ProblemDetails\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"404\": {\r\n            \"description\": \"OTP not found or expired\",\r\n            \"content\": {\r\n              \"application/problem+json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ProblemDetails\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"429\": {\r\n            \"description\": \"Too many attempts\",\r\n            \"content\": {\r\n              \"application/problem+json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ProblemDetails\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/auth/me\": {\r\n      \"get\": {\r\n        \"tags\": [\"User\"],\r\n        \"summary\": \"Get current user\",\r\n        \"description\": \"Get information about the currently authenticated user\",\r\n        \"operationId\": \"getMe\",\r\n        \"security\": [\r\n          {\r\n            \"BearerAuth\": []\r\n          }\r\n        ],\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"User information\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/User\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"401\": {\r\n            \"description\": \"Unauthorized\",\r\n            \"content\": {\r\n              \"application/problem+json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ProblemDetails\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/auth/logout\": {\r\n      \"post\": {\r\n        \"tags\": [\"User\"],\r\n        \"summary\": \"Logout\",\r\n        \"description\": \"Logout and revoke the current access token\",\r\n        \"operationId\": \"logout\",\r\n        \"security\": [\r\n          {\r\n            \"BearerAuth\": []\r\n          }\r\n        ],\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"Logged out successfully\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/LogoutResponse\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"401\": {\r\n            \"description\": \"Unauthorized\",\r\n            \"content\": {\r\n              \"application/problem+json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ProblemDetails\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/auth/refresh\": {\r\n      \"post\": {\r\n        \"tags\": [\"User\"],\r\n        \"summary\": \"Refresh token\",\r\n        \"description\": \"Refresh an expiring access token\",\r\n        \"operationId\": \"refreshToken\",\r\n        \"requestBody\": {\r\n          \"required\": true,\r\n          \"content\": {\r\n            \"application/json\": {\r\n              \"schema\": {\r\n                \"$ref\": \"#/components/schemas/RefreshTokenRequest\"\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"Token refreshed successfully\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/TokenResponse\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"401\": {\r\n            \"description\": \"Invalid or expired token\",\r\n            \"content\": {\r\n              \"application/problem+json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ProblemDetails\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/admin/customers/me\": {\r\n      \"get\": {\r\n        \"tags\": [\"Admin\"],\r\n        \"summary\": \"Get customer information\",\r\n        \"description\": \"Get information about the current customer (requires API key or JWT)\",\r\n        \"operationId\": \"getCustomer\",\r\n        \"security\": [\r\n          {\r\n            \"BearerAuth\": []\r\n          },\r\n          {\r\n            \"ApiKeyAuth\": []\r\n          }\r\n        ],\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"Customer information\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/Customer\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"401\": {\r\n            \"description\": \"Unauthorized\"\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/admin/customers/{customerId}/api-keys\": {\r\n      \"get\": {\r\n        \"tags\": [\"Admin\"],\r\n        \"summary\": \"List API keys\",\r\n        \"description\": \"Get all API keys for a customer\",\r\n        \"operationId\": \"listApiKeys\",\r\n        \"security\": [\r\n          {\r\n            \"BearerAuth\": []\r\n          },\r\n          {\r\n            \"ApiKeyAuth\": []\r\n          }\r\n        ],\r\n        \"parameters\": [\r\n          {\r\n            \"name\": \"customerId\",\r\n            \"in\": \"path\",\r\n            \"required\": true,\r\n            \"schema\": {\r\n              \"type\": \"string\"\r\n            }\r\n          }\r\n        ],\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"List of API keys\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ApiKeysResponse\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"post\": {\r\n        \"tags\": [\"Admin\"],\r\n        \"summary\": \"Create API key\",\r\n        \"description\": \"Create a new API key for the customer\",\r\n        \"operationId\": \"createApiKey\",\r\n        \"security\": [\r\n          {\r\n            \"BearerAuth\": []\r\n          },\r\n          {\r\n            \"ApiKeyAuth\": []\r\n          }\r\n        ],\r\n        \"parameters\": [\r\n          {\r\n            \"name\": \"customerId\",\r\n            \"in\": \"path\",\r\n            \"required\": true,\r\n            \"schema\": {\r\n              \"type\": \"string\"\r\n            }\r\n          }\r\n        ],\r\n        \"requestBody\": {\r\n          \"required\": true,\r\n          \"content\": {\r\n            \"application/json\": {\r\n              \"schema\": {\r\n                \"$ref\": \"#/components/schemas/CreateApiKeyRequest\"\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"API key created\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/ApiKeyResponse\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/admin/audit-logs\": {\r\n      \"get\": {\r\n        \"tags\": [\"Admin\"],\r\n        \"summary\": \"Get audit logs\",\r\n        \"description\": \"Get audit logs for the customer with optional filtering\",\r\n        \"operationId\": \"getAuditLogs\",\r\n        \"security\": [\r\n          {\r\n            \"BearerAuth\": []\r\n          },\r\n          {\r\n            \"ApiKeyAuth\": []\r\n          }\r\n        ],\r\n        \"parameters\": [\r\n          {\r\n            \"name\": \"startDate\",\r\n            \"in\": \"query\",\r\n            \"schema\": {\r\n              \"type\": \"string\",\r\n              \"format\": \"date\"\r\n            }\r\n          },\r\n          {\r\n            \"name\": \"endDate\",\r\n            \"in\": \"query\",\r\n            \"schema\": {\r\n              \"type\": \"string\",\r\n              \"format\": \"date\"\r\n            }\r\n          },\r\n          {\r\n            \"name\": \"eventType\",\r\n            \"in\": \"query\",\r\n            \"schema\": {\r\n              \"type\": \"string\"\r\n            }\r\n          }\r\n        ],\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"Audit logs\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/AuditLogsResponse\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/admin/analytics\": {\r\n      \"get\": {\r\n        \"tags\": [\"Admin\"],\r\n        \"summary\": \"Get analytics\",\r\n        \"description\": \"Get analytics data for the customer\",\r\n        \"operationId\": \"getAnalytics\",\r\n        \"security\": [\r\n          {\r\n            \"BearerAuth\": []\r\n          },\r\n          {\r\n            \"ApiKeyAuth\": []\r\n          }\r\n        ],\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"Analytics data\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/Analytics\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"/health\": {\r\n      \"get\": {\r\n        \"tags\": [\"Health\"],\r\n        \"summary\": \"Health check\",\r\n        \"description\": \"Check the health status of the service\",\r\n        \"operationId\": \"healthCheck\",\r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"Service is healthy\",\r\n            \"content\": {\r\n              \"application/json\": {\r\n                \"schema\": {\r\n                  \"$ref\": \"#/components/schemas/HealthResponse\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"503\": {\r\n            \"description\": \"Service is degraded or unhealthy\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"components\": {\r\n    \"securitySchemes\": {\r\n      \"BearerAuth\": {\r\n        \"type\": \"http\",\r\n        \"scheme\": \"bearer\",\r\n        \"bearerFormat\": \"JWT\",\r\n        \"description\": \"JWT token obtained from /auth/verify-otp\"\r\n      },\r\n      \"ApiKeyAuth\": {\r\n        \"type\": \"apiKey\",\r\n        \"in\": \"header\",\r\n        \"name\": \"X-OTP-API-Key\",\r\n        \"description\": \"API key for multi-tenant authentication\"\r\n      }\r\n    },\r\n    \"schemas\": {\r\n      \"RequestOTPRequest\": {\r\n        \"type\": \"object\",\r\n        \"required\": [\"email\"],\r\n        \"properties\": {\r\n          \"email\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"email\",\r\n            \"example\": \"user@example.com\"\r\n          }\r\n        }\r\n      },\r\n      \"RequestOTPResponse\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"success\": {\r\n            \"type\": \"boolean\",\r\n            \"example\": true\r\n          },\r\n          \"message\": {\r\n            \"type\": \"string\",\r\n            \"example\": \"OTP sent to email\"\r\n          },\r\n          \"expiresIn\": {\r\n            \"type\": \"integer\",\r\n            \"description\": \"OTP expiration time in seconds\",\r\n            \"example\": 600\r\n          },\r\n          \"remaining\": {\r\n            \"type\": \"integer\",\r\n            \"description\": \"Remaining OTP requests for this email\",\r\n            \"example\": 2\r\n          }\r\n        }\r\n      },\r\n      \"VerifyOTPRequest\": {\r\n        \"type\": \"object\",\r\n        \"required\": [\"email\", \"otp\"],\r\n        \"properties\": {\r\n          \"email\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"email\",\r\n            \"example\": \"user@example.com\"\r\n          },\r\n          \"otp\": {\r\n            \"type\": \"string\",\r\n            \"pattern\": \"^[0-9]{6}$\",\r\n            \"example\": \"123456\"\r\n          }\r\n        }\r\n      },\r\n      \"TokenResponse\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"access_token\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"JWT access token\",\r\n            \"example\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\r\n          },\r\n          \"token_type\": {\r\n            \"type\": \"string\",\r\n            \"example\": \"Bearer\"\r\n          },\r\n          \"expires_in\": {\r\n            \"type\": \"integer\",\r\n            \"description\": \"Token expiration in seconds\",\r\n            \"example\": 25200\r\n          },\r\n          \"scope\": {\r\n            \"type\": \"string\",\r\n            \"example\": \"openid email profile\"\r\n          },\r\n          \"sub\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Subject (user ID)\",\r\n            \"example\": \"user_abc123\"\r\n          },\r\n          \"email\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"email\",\r\n            \"example\": \"user@example.com\"\r\n          },\r\n          \"email_verified\": {\r\n            \"type\": \"boolean\",\r\n            \"example\": true\r\n          }\r\n        }\r\n      },\r\n      \"User\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"sub\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Subject (user ID)\"\r\n          },\r\n          \"email\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"email\"\r\n          },\r\n          \"email_verified\": {\r\n            \"type\": \"boolean\"\r\n          },\r\n          \"iss\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Issuer\"\r\n          },\r\n          \"aud\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Audience (customer ID)\"\r\n          }\r\n        }\r\n      },\r\n      \"LogoutResponse\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"success\": {\r\n            \"type\": \"boolean\",\r\n            \"example\": true\r\n          },\r\n          \"message\": {\r\n            \"type\": \"string\",\r\n            \"example\": \"Logged out successfully\"\r\n          }\r\n        }\r\n      },\r\n      \"RefreshTokenRequest\": {\r\n        \"type\": \"object\",\r\n        \"required\": [\"token\"],\r\n        \"properties\": {\r\n          \"token\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Current access token to refresh\"\r\n          }\r\n        }\r\n      },\r\n      \"Customer\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"customerId\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"email\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"email\"\r\n          },\r\n          \"name\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"status\": {\r\n            \"type\": \"string\",\r\n            \"enum\": [\"active\", \"suspended\", \"pending\"]\r\n          },\r\n          \"plan\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"createdAt\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"date-time\"\r\n          }\r\n        }\r\n      },\r\n      \"CreateApiKeyRequest\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"name\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Name for the API key\",\r\n            \"example\": \"Production API Key\"\r\n          }\r\n        }\r\n      },\r\n      \"ApiKeyResponse\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"apiKey\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"The API key (only shown once)\",\r\n            \"example\": \"otp_live_sk_...\"\r\n          },\r\n          \"keyId\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Unique identifier for the key\"\r\n          }\r\n        }\r\n      },\r\n      \"ApiKeysResponse\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"apiKeys\": {\r\n            \"type\": \"array\",\r\n            \"items\": {\r\n              \"$ref\": \"#/components/schemas/ApiKey\"\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"ApiKey\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"keyId\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"name\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"createdAt\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"date-time\"\r\n          },\r\n          \"lastUsed\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"date-time\",\r\n            \"nullable\": true\r\n          },\r\n          \"status\": {\r\n            \"type\": \"string\",\r\n            \"enum\": [\"active\", \"revoked\"]\r\n          }\r\n        }\r\n      },\r\n      \"AuditLogsResponse\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"success\": {\r\n            \"type\": \"boolean\"\r\n          },\r\n          \"period\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n              \"start\": {\r\n                \"type\": \"string\",\r\n                \"format\": \"date\"\r\n              },\r\n              \"end\": {\r\n                \"type\": \"string\",\r\n                \"format\": \"date\"\r\n              }\r\n            }\r\n          },\r\n          \"total\": {\r\n            \"type\": \"integer\"\r\n          },\r\n          \"events\": {\r\n            \"type\": \"array\",\r\n            \"items\": {\r\n              \"$ref\": \"#/components/schemas/AuditLog\"\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"AuditLog\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"eventType\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"timestamp\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"date-time\"\r\n          }\r\n        },\r\n        \"additionalProperties\": true\r\n      },\r\n      \"Analytics\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"today\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n              \"otpRequests\": {\r\n                \"type\": \"integer\"\r\n              },\r\n              \"otpVerifications\": {\r\n                \"type\": \"integer\"\r\n              },\r\n              \"successfulLogins\": {\r\n                \"type\": \"integer\"\r\n              },\r\n              \"failedAttempts\": {\r\n                \"type\": \"integer\"\r\n              },\r\n              \"emailsSent\": {\r\n                \"type\": \"integer\"\r\n              },\r\n              \"successRate\": {\r\n                \"type\": \"number\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"HealthResponse\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"status\": {\r\n            \"type\": \"string\",\r\n            \"enum\": [\"healthy\", \"degraded\", \"unhealthy\"]\r\n          },\r\n          \"service\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"version\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"timestamp\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"date-time\"\r\n          }\r\n        }\r\n      },\r\n      \"ProblemDetails\": {\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"type\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"uri\"\r\n          },\r\n          \"title\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"status\": {\r\n            \"type\": \"integer\"\r\n          },\r\n          \"detail\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"instance\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"uri\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}`);\r\n\r\n", "/**\r\n * Cache utilities for customer data\r\n * In-memory cache with TTL for performance optimization\r\n */\r\n\r\n// In-memory cache for customer data (5-minute TTL)\r\nconst customerCache = new Map();\r\nconst cacheTTL = 5 * 60 * 1000; // 5 minutes\r\n\r\n/**\r\n * Get customer from cache or KV\r\n * @param {string} customerId - Customer ID\r\n * @param {Function} getCustomerFn - Function to fetch customer from KV\r\n * @returns {Promise<object|null>} Customer data\r\n */\r\nexport async function getCustomerCached(customerId, getCustomerFn) {\r\n    if (!customerId) return null;\r\n    \r\n    const cacheKey = `customer_${customerId}`;\r\n    const cached = customerCache.get(cacheKey);\r\n    \r\n    if (cached && Date.now() - cached.timestamp < cacheTTL) {\r\n        return cached.data;\r\n    }\r\n    \r\n    const customer = await getCustomerFn(customerId);\r\n    if (customer) {\r\n        customerCache.set(cacheKey, {\r\n            data: customer,\r\n            timestamp: Date.now()\r\n        });\r\n    }\r\n    \r\n    return customer;\r\n}\r\n\r\n/**\r\n * Invalidate customer cache\r\n * @param {string} customerId - Customer ID\r\n */\r\nexport function invalidateCustomerCache(customerId) {\r\n    if (customerId) {\r\n        customerCache.delete(`customer_${customerId}`);\r\n    }\r\n}\r\n\r\n", "/**\r\n * Cryptographic utilities\r\n * OTP generation, hashing, JWT creation and verification\r\n */\r\n\r\n/**\r\n * Generate 6-digit OTP code\r\n * Uses cryptographically secure random number generation\r\n * @returns {string} 6-digit OTP code\r\n */\r\nexport function generateOTP() {\r\n    // Use 2 Uint32 values to get 64 bits, eliminating modulo bias\r\n    const array = new Uint32Array(2);\r\n    crypto.getRandomValues(array);\r\n    // Combine two 32-bit values for 64-bit range (0 to 2^64-1)\r\n    // Then modulo 1,000,000 for 6-digit code\r\n    // This eliminates modulo bias since 2^64 is much larger than 1,000,000\r\n    const value = (Number(array[0]) * 0x100000000 + Number(array[1])) % 1000000;\r\n    return value.toString().padStart(6, '0');\r\n}\r\n\r\n/**\r\n * Hash email for storage key (SHA-256)\r\n * @param {string} email - Email address\r\n * @returns {Promise<string>} Hex-encoded hash\r\n */\r\nexport async function hashEmail(email) {\r\n    const encoder = new TextEncoder();\r\n    const data = encoder.encode(email.toLowerCase().trim());\r\n    const hashBuffer = await crypto.subtle.digest('SHA-256', data);\r\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\r\n}\r\n\r\n/**\r\n * Generate user ID from email\r\n * @param {string} email - Email address\r\n * @returns {Promise<string>} User ID\r\n */\r\nexport async function generateUserId(email) {\r\n    const hash = await hashEmail(email);\r\n    return `user_${hash.substring(0, 12)}`;\r\n}\r\n\r\n/**\r\n * Create JWT token\r\n * @param {object} payload - Token payload\r\n * @param {string} secret - Secret key for signing\r\n * @returns {Promise<string>} JWT token\r\n */\r\nexport async function createJWT(payload, secret) {\r\n    const header = {\r\n        alg: 'HS256',\r\n        typ: 'JWT'\r\n    };\r\n    \r\n    const encoder = new TextEncoder();\r\n    const headerB64 = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\r\n    const payloadB64 = btoa(JSON.stringify(payload)).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\r\n    \r\n    const signatureInput = `${headerB64}.${payloadB64}`;\r\n    const keyData = encoder.encode(secret);\r\n    const key = await crypto.subtle.importKey(\r\n        'raw',\r\n        keyData,\r\n        { name: 'HMAC', hash: 'SHA-256' },\r\n        false,\r\n        ['sign']\r\n    );\r\n    \r\n    const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(signatureInput));\r\n    const signatureB64 = btoa(String.fromCharCode(...new Uint8Array(signature)))\r\n        .replace(/=/g, '').replace(/\\+/g, '-').replace(/_/g, '/');\r\n    \r\n    return `${signatureInput}.${signatureB64}`;\r\n}\r\n\r\n/**\r\n * Verify JWT token\r\n * @param {string} token - JWT token\r\n * @param {string} secret - Secret key for verification\r\n * @returns {Promise<object|null>} Decoded payload or null if invalid\r\n */\r\nexport async function verifyJWT(token, secret) {\r\n    try {\r\n        const parts = token.split('.');\r\n        if (parts.length !== 3) return null;\r\n        \r\n        const [headerB64, payloadB64, signatureB64] = parts;\r\n        \r\n        // Verify signature\r\n        const encoder = new TextEncoder();\r\n        const signatureInput = `${headerB64}.${payloadB64}`;\r\n        const keyData = encoder.encode(secret);\r\n        const key = await crypto.subtle.importKey(\r\n            'raw',\r\n            keyData,\r\n            { name: 'HMAC', hash: 'SHA-256' },\r\n            false,\r\n            ['verify']\r\n        );\r\n        \r\n        // Decode signature\r\n        const signature = Uint8Array.from(\r\n            atob(signatureB64.replace(/-/g, '+').replace(/_/g, '/')),\r\n            c => c.charCodeAt(0)\r\n        );\r\n        \r\n        const isValid = await crypto.subtle.verify(\r\n            'HMAC',\r\n            key,\r\n            signature,\r\n            encoder.encode(signatureInput)\r\n        );\r\n        \r\n        if (!isValid) return null;\r\n        \r\n        // Decode payload\r\n        const payload = JSON.parse(\r\n            atob(payloadB64.replace(/-/g, '+').replace(/_/g, '/'))\r\n        );\r\n        \r\n        // Check expiration\r\n        if (payload.exp && payload.exp < Math.floor(Date.now() / 1000)) {\r\n            return null;\r\n        }\r\n        \r\n        return payload;\r\n    } catch (error) {\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Get JWT secret from environment\r\n * @param {*} env - Worker environment\r\n * @returns {string} JWT secret\r\n * @throws {Error} If JWT_SECRET is not set\r\n */\r\nexport function getJWTSecret(env) {\r\n    if (!env.JWT_SECRET) {\r\n        throw new Error('JWT_SECRET environment variable is required. Set it via: wrangler secret put JWT_SECRET');\r\n    }\r\n    return env.JWT_SECRET;\r\n}\r\n\r\n/**\r\n * Hash password using PBKDF2\r\n * @param {string} password - Plain text password\r\n * @returns {Promise<string>} Hashed password (hex-encoded)\r\n */\r\nexport async function hashPassword(password) {\r\n    const encoder = new TextEncoder();\r\n    const data = encoder.encode(password);\r\n    const hashBuffer = await crypto.subtle.digest('SHA-256', data);\r\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\r\n}\r\n\r\n/**\r\n * Generate cryptographically secure API key\r\n * @param {string} prefix - Key prefix (e.g., 'otp_live_sk_')\r\n * @returns {Promise<string>} API key\r\n */\r\nexport async function generateApiKey(prefix = 'otp_live_sk_') {\r\n    // Generate 32 random bytes (256 bits)\r\n    const array = new Uint8Array(32);\r\n    crypto.getRandomValues(array);\r\n    \r\n    // Convert to base64url (URL-safe base64)\r\n    const base64 = btoa(String.fromCharCode(...array))\r\n        .replace(/\\+/g, '-')\r\n        .replace(/\\//g, '_')\r\n        .replace(/=/g, '');\r\n    \r\n    return `${prefix}${base64}`;\r\n}\r\n\r\n/**\r\n * Hash API key for storage (SHA-256)\r\n * @param {string} apiKey - API key\r\n * @returns {Promise<string>} Hex-encoded hash\r\n */\r\nexport async function hashApiKey(apiKey) {\r\n    const encoder = new TextEncoder();\r\n    const data = encoder.encode(apiKey);\r\n    const hashBuffer = await crypto.subtle.digest('SHA-256', data);\r\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\r\n}\r\n\r\n/**\r\n * Constant-time string comparison to prevent timing attacks\r\n * @param {string} a - First string\r\n * @param {string} b - Second string\r\n * @returns {boolean} True if strings are equal\r\n */\r\nexport function constantTimeEquals(a, b) {\r\n    if (a.length !== b.length) {\r\n        return false;\r\n    }\r\n    \r\n    let result = 0;\r\n    for (let i = 0; i < a.length; i++) {\r\n        result |= a.charCodeAt(i) ^ b.charCodeAt(i);\r\n    }\r\n    \r\n    return result === 0;\r\n}\r\n\r\n", "/**\r\n * Email utilities\r\n * Template rendering, email providers, and sending logic\r\n */\r\n\r\n/**\r\n * Escape HTML entities\r\n * @param {string} str - String to escape\r\n * @returns {string} Escaped string\r\n */\r\nexport function escapeHtml(str) {\r\n    if (!str) return '';\r\n    const map = {\r\n        '&': '&amp;',\r\n        '<': '&lt;',\r\n        '>': '&gt;',\r\n        '\"': '&quot;',\r\n        \"'\": '&#039;'\r\n    };\r\n    return String(str).replace(/[&<>\"']/g, m => map[m]);\r\n}\r\n\r\n/**\r\n * Render email template with variables\r\n * @param {string} template - Template string\r\n * @param {object} variables - Variables to substitute\r\n * @param {boolean} isHtml - Whether this is an HTML template (escape variables)\r\n * @returns {string} Rendered template\r\n */\r\nexport function renderEmailTemplate(template, variables, isHtml = false) {\r\n    if (!template) return '';\r\n    \r\n    let rendered = template;\r\n    \r\n    // Replace all variables (case-insensitive)\r\n    for (const [key, value] of Object.entries(variables)) {\r\n        const regex = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'gi');\r\n        // For HTML templates, escape variables to prevent XSS (except for otp which is safe)\r\n        // For text templates, use as-is\r\n        const replacement = isHtml && key !== 'otp' ? escapeHtml(value || '') : (value || '');\r\n        rendered = rendered.replace(regex, replacement);\r\n    }\r\n    \r\n    return rendered;\r\n}\r\n\r\n/**\r\n * Get default email template\r\n * @returns {string} Default HTML template\r\n */\r\nexport function getDefaultEmailTemplate() {\r\n    return `\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n            <meta charset=\"utf-8\">\r\n            <style>\r\n                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n                .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n                .otp-code { \r\n                    font-size: 32px; \r\n                    font-weight: bold; \r\n                    letter-spacing: 8px; \r\n                    text-align: center;\r\n                    background: #f4f4f4;\r\n                    padding: 20px;\r\n                    border-radius: 8px;\r\n                    margin: 20px 0;\r\n                    font-family: monospace;\r\n                }\r\n                .footer { \r\n                    margin-top: 30px; \r\n                    font-size: 12px; \r\n                    color: #666; \r\n                }\r\n            </style>\r\n        </head>\r\n        <body>\r\n            <div class=\"container\">\r\n                <h1>Your Verification Code</h1>\r\n                <p>Use this code to verify your email address:</p>\r\n                <div class=\"otp-code\">{{otp}}</div>\r\n                <p>This code will expire in <strong>{{expiresIn}} minutes</strong>.</p>\r\n                <p>If you didn't request this code, please ignore this email.</p>\r\n                <div class=\"footer\">\r\n                    <p>{{appName}}</p>\r\n                    <p>This is an automated message, please do not reply.</p>\r\n                </div>\r\n            </div>\r\n        </body>\r\n        </html>\r\n    `;\r\n}\r\n\r\n/**\r\n * Get default text email template\r\n * @returns {string} Default text template\r\n */\r\nexport function getDefaultTextTemplate() {\r\n    return `Your Verification Code\r\n\r\nUse this code to verify your email address: {{otp}}\r\n\r\nThis code will expire in {{expiresIn}} minutes.\r\n\r\nIf you didn't request this code, please ignore this email.\r\n\r\n{{appName}}\r\nThis is an automated message, please do not reply.`;\r\n}\r\n\r\n/**\r\n * Resend email provider\r\n */\r\nexport class ResendProvider {\r\n    constructor(apiKey) {\r\n        this.apiKey = apiKey;\r\n        this.baseUrl = 'https://api.resend.com';\r\n    }\r\n    \r\n    async sendEmail({ from, to, subject, html, text }) {\r\n        const response = await fetch(`${this.baseUrl}/emails`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${this.apiKey}`,\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({\r\n                from,\r\n                to,\r\n                subject,\r\n                html,\r\n                text,\r\n            }),\r\n        });\r\n        \r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            let errorData;\r\n            try {\r\n                errorData = JSON.parse(errorText);\r\n            } catch (e) {\r\n                errorData = { message: errorText };\r\n            }\r\n            \r\n            throw new Error(`Resend API error: ${response.status} - ${errorData.message || errorText}`);\r\n        }\r\n        \r\n        return await response.json();\r\n    }\r\n}\r\n\r\n/**\r\n * SendGrid email provider\r\n */\r\nexport class SendGridProvider {\r\n    constructor(apiKey) {\r\n        this.apiKey = apiKey;\r\n        this.baseUrl = 'https://api.sendgrid.com/v3';\r\n    }\r\n    \r\n    async sendEmail({ from, to, subject, html, text }) {\r\n        const response = await fetch(`${this.baseUrl}/mail/send`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${this.apiKey}`,\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({\r\n                personalizations: [{\r\n                    to: [{ email: to }]\r\n                }],\r\n                from: { email: from },\r\n                subject: subject,\r\n                content: [\r\n                    { type: 'text/plain', value: text },\r\n                    { type: 'text/html', value: html }\r\n                ]\r\n            }),\r\n        });\r\n        \r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            throw new Error(`SendGrid API error: ${response.status} - ${errorText}`);\r\n        }\r\n        \r\n        return { success: true };\r\n    }\r\n}\r\n\r\n/**\r\n * Get email provider based on customer config or environment\r\n * @param {object|null} customer - Customer object\r\n * @param {*} env - Worker environment\r\n * @returns {ResendProvider|SendGridProvider} Email provider instance\r\n */\r\nexport function getEmailProvider(customer, env) {\r\n    // Check customer-specific email provider config\r\n    if (customer && customer.config && customer.config.emailProvider) {\r\n        const providerConfig = customer.config.emailProvider;\r\n        \r\n        if (providerConfig.type === 'sendgrid' && providerConfig.apiKey) {\r\n            return new SendGridProvider(providerConfig.apiKey);\r\n        }\r\n        \r\n        if (providerConfig.type === 'resend' && providerConfig.apiKey) {\r\n            return new ResendProvider(providerConfig.apiKey);\r\n        }\r\n    }\r\n    \r\n    // Default to Resend using environment variable\r\n    if (!env.RESEND_API_KEY) {\r\n        throw new Error('RESEND_API_KEY not configured. Set it via: wrangler secret put RESEND_API_KEY');\r\n    }\r\n    \r\n    return new ResendProvider(env.RESEND_API_KEY);\r\n}\r\n\r\n", "/**\r\n * Customer service\r\n * Customer management, storage, and retrieval\r\n */\r\n\r\nimport { generateApiKey, hashApiKey } from '../utils/crypto.js';\r\n\r\n/**\r\n * Get customer key with prefix for isolation\r\n * @param {string} customerId - Customer ID (optional for backward compatibility)\r\n * @param {string} key - Base key\r\n * @returns {string} Prefixed key\r\n */\r\nexport function getCustomerKey(customerId, key) {\r\n    return customerId ? `cust_${customerId}_${key}` : key;\r\n}\r\n\r\n/**\r\n * Generate customer ID\r\n * @returns {string} Customer ID\r\n */\r\nexport function generateCustomerId() {\r\n    // Generate 12 random hex characters\r\n    const array = new Uint8Array(6);\r\n    crypto.getRandomValues(array);\r\n    const hex = Array.from(array)\r\n        .map(b => b.toString(16).padStart(2, '0'))\r\n        .join('');\r\n    return `cust_${hex}`;\r\n}\r\n\r\n/**\r\n * Get customer by ID\r\n * @param {string} customerId - Customer ID\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<object|null>} Customer data or null\r\n */\r\nexport async function getCustomer(customerId, env) {\r\n    const customerKey = `customer_${customerId}`;\r\n    const customer = await env.OTP_AUTH_KV.get(customerKey, { type: 'json' });\r\n    return customer;\r\n}\r\n\r\n/**\r\n * Store customer\r\n * @param {string} customerId - Customer ID\r\n * @param {object} customerData - Customer data\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nexport async function storeCustomer(customerId, customerData, env) {\r\n    const customerKey = `customer_${customerId}`;\r\n    await env.OTP_AUTH_KV.put(customerKey, JSON.stringify(customerData));\r\n}\r\n\r\n", "/**\r\n * API Key service\r\n * API key generation, hashing, verification, and management\r\n */\r\n\r\nimport { generateApiKey as generateKey, hashApiKey as hashApiKeyUtil } from '../utils/crypto.js';\r\nimport { getCustomer } from './customer.js';\r\n\r\n/**\r\n * Generate cryptographically secure API key\r\n * @param {string} prefix - Key prefix (e.g., 'otp_live_sk_')\r\n * @returns {Promise<string>} API key\r\n */\r\nexport async function generateApiKey(prefix = 'otp_live_sk_') {\r\n    return await generateKey(prefix);\r\n}\r\n\r\n/**\r\n * Hash API key for storage (SHA-256)\r\n * @param {string} apiKey - API key\r\n * @returns {Promise<string>} Hex-encoded hash\r\n */\r\nexport async function hashApiKeyForStorage(apiKey) {\r\n    return await hashApiKeyUtil(apiKey);\r\n}\r\n\r\n/**\r\n * Hash API key (re-exported for convenience)\r\n * @param {string} apiKey - API key\r\n * @returns {Promise<string>} Hex-encoded hash\r\n */\r\nexport async function hashApiKey(apiKey) {\r\n    return await hashApiKeyUtil(apiKey);\r\n}\r\n\r\n/**\r\n * Create API key for customer\r\n * @param {string} customerId - Customer ID\r\n * @param {string} name - API key name\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<{apiKey: string, keyId: string}>} API key and key ID\r\n */\r\nexport async function createApiKeyForCustomer(customerId, name, env) {\r\n    // Generate API key\r\n    const apiKey = await generateApiKey('otp_live_sk_');\r\n    const apiKeyHash = await hashApiKeyUtil(apiKey);\r\n    \r\n    // Generate key ID\r\n    const keyId = `key_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\r\n    \r\n    // Store API key hash\r\n    const apiKeyData = {\r\n        customerId,\r\n        keyId,\r\n        name: name || 'Default API Key',\r\n        createdAt: new Date().toISOString(),\r\n        lastUsed: null,\r\n        status: 'active'\r\n    };\r\n    \r\n    const apiKeyKey = `apikey_${apiKeyHash}`;\r\n    await env.OTP_AUTH_KV.put(apiKeyKey, JSON.stringify(apiKeyData));\r\n    \r\n    // Also store key ID to hash mapping for customer\r\n    const customerApiKeysKey = `customer_${customerId}_apikeys`;\r\n    const existingKeys = await env.OTP_AUTH_KV.get(customerApiKeysKey, { type: 'json' }) || [];\r\n    existingKeys.push({\r\n        keyId,\r\n        name: apiKeyData.name,\r\n        createdAt: apiKeyData.createdAt,\r\n        lastUsed: null,\r\n        status: 'active'\r\n    });\r\n    await env.OTP_AUTH_KV.put(customerApiKeysKey, JSON.stringify(existingKeys));\r\n    \r\n    return { apiKey, keyId };\r\n}\r\n\r\n/**\r\n * Verify API key and get customer ID\r\n * @param {string} apiKey - API key\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<{customerId: string, keyId: string}|null>} Customer ID and key ID or null\r\n */\r\nexport async function verifyApiKey(apiKey, env) {\r\n    const apiKeyHash = await hashApiKeyUtil(apiKey);\r\n    const apiKeyKey = `apikey_${apiKeyHash}`;\r\n    const keyData = await env.OTP_AUTH_KV.get(apiKeyKey, { type: 'json' });\r\n    \r\n    if (!keyData || keyData.status !== 'active') {\r\n        return null;\r\n    }\r\n    \r\n    // Update last used timestamp\r\n    keyData.lastUsed = new Date().toISOString();\r\n    await env.OTP_AUTH_KV.put(apiKeyKey, JSON.stringify(keyData));\r\n    \r\n    // Also update in customer's key list\r\n    const customerApiKeysKey = `customer_${keyData.customerId}_apikeys`;\r\n    const customerKeys = await env.OTP_AUTH_KV.get(customerApiKeysKey, { type: 'json' }) || [];\r\n    const keyIndex = customerKeys.findIndex(k => k.keyId === keyData.keyId);\r\n    if (keyIndex >= 0) {\r\n        customerKeys[keyIndex].lastUsed = keyData.lastUsed;\r\n        await env.OTP_AUTH_KV.put(customerApiKeysKey, JSON.stringify(customerKeys));\r\n    }\r\n    \r\n    // Check if customer exists and is active\r\n    const customer = await getCustomer(keyData.customerId, env);\r\n    if (!customer) {\r\n        return null;\r\n    }\r\n    \r\n    // Only allow active customers\r\n    if (customer.status !== 'active') {\r\n        return null;\r\n    }\r\n    \r\n    return {\r\n        customerId: keyData.customerId,\r\n        keyId: keyData.keyId\r\n    };\r\n}\r\n\r\n", "/**\r\n * Rate limiting service\r\n * OTP request rate limiting with customer-specific configurations\r\n * Includes IP-based rate limiting, dynamic throttling, and free tier hard caps\r\n */\r\n\r\n/**\r\n * Get plan limits for customer\r\n * @param {string} plan - Plan name ('free', 'pro', 'enterprise')\r\n * @returns {object} Plan limits\r\n */\r\nfunction getPlanLimits(plan = 'free') {\r\n    const plans = {\r\n        free: {\r\n            otpRequestsPerHour: 3,\r\n            otpRequestsPerDay: 1000,      // Hard cap for free tier\r\n            otpRequestsPerMonth: 10000,    // Hard cap for free tier\r\n            ipRequestsPerHour: 10,\r\n            ipRequestsPerDay: 50,\r\n            maxUsers: 100\r\n        },\r\n        pro: {\r\n            otpRequestsPerHour: 10,\r\n            otpRequestsPerDay: 10000,\r\n            otpRequestsPerMonth: 100000,\r\n            ipRequestsPerHour: 50,\r\n            ipRequestsPerDay: 500,\r\n            maxUsers: 1000\r\n        },\r\n        enterprise: {\r\n            otpRequestsPerHour: 100,\r\n            otpRequestsPerDay: 100000,\r\n            otpRequestsPerMonth: 1000000,\r\n            ipRequestsPerHour: 500,\r\n            ipRequestsPerDay: 5000,\r\n            maxUsers: 10000\r\n        }\r\n    };\r\n    return plans[plan] || plans.free;\r\n}\r\n\r\n/**\r\n * Calculate dynamic rate limit adjustment based on usage patterns\r\n * @param {object} emailStats - Email usage statistics\r\n * @param {object} ipStats - IP usage statistics\r\n * @returns {number} Adjustment factor (-2 to +2)\r\n */\r\nfunction calculateDynamicAdjustment(emailStats, ipStats) {\r\n    let adjustment = 0;\r\n    \r\n    // New email bonus (< 3 requests in last 24h)\r\n    if (emailStats.requestsLast24h < 3) {\r\n        adjustment += 2;\r\n    }\r\n    \r\n    // Frequent email penalty (> 10 requests in last 24h)\r\n    if (emailStats.requestsLast24h > 10) {\r\n        adjustment -= 1;\r\n    }\r\n    \r\n    // High failure rate penalty (> 50% failure rate)\r\n    if (emailStats.totalRequests > 0 && (emailStats.failedAttempts / emailStats.totalRequests) > 0.5) {\r\n        adjustment -= 2;\r\n    }\r\n    \r\n    // Verified email bonus (successful login in last 7 days)\r\n    if (emailStats.lastSuccessfulLogin && \r\n        (Date.now() - new Date(emailStats.lastSuccessfulLogin).getTime()) < 7 * 24 * 60 * 60 * 1000) {\r\n        adjustment += 1;\r\n    }\r\n    \r\n    // IP-based penalties\r\n    if (ipStats.requestsLast24h > 20) {\r\n        adjustment -= 1;\r\n    }\r\n    \r\n    if (ipStats.failedAttempts > 10) {\r\n        adjustment -= 1;\r\n    }\r\n    \r\n    // Clamp adjustment between -2 and +2\r\n    return Math.max(-2, Math.min(2, adjustment));\r\n}\r\n\r\n/**\r\n * Get usage statistics for email and IP\r\n * @param {string} emailHash - Hashed email\r\n * @param {string} ipHash - Hashed IP address\r\n * @param {string} customerId - Customer ID\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<{emailStats: object, ipStats: object}>}\r\n */\r\nasync function getUsageStats(emailHash, ipHash, customerId, env) {\r\n    const now = Date.now();\r\n    const oneDayAgo = now - (24 * 60 * 60 * 1000);\r\n    \r\n    // Get email stats\r\n    const emailStatsKey = customerId \r\n        ? `cust_${customerId}_stats_email_${emailHash}`\r\n        : `stats_email_${emailHash}`;\r\n    const emailStatsData = await env.OTP_AUTH_KV.get(emailStatsKey, { type: 'json' }) || {\r\n        totalRequests: 0,\r\n        requestsLast24h: 0,\r\n        failedAttempts: 0,\r\n        lastSuccessfulLogin: null,\r\n        requestTimestamps: []\r\n    };\r\n    \r\n    // Filter timestamps to last 24 hours\r\n    emailStatsData.requestTimestamps = (emailStatsData.requestTimestamps || []).filter(ts => ts > oneDayAgo);\r\n    emailStatsData.requestsLast24h = emailStatsData.requestTimestamps.length;\r\n    \r\n    // Get IP stats\r\n    const ipStatsKey = customerId \r\n        ? `cust_${customerId}_stats_ip_${ipHash}`\r\n        : `stats_ip_${ipHash}`;\r\n    const ipStatsData = await env.OTP_AUTH_KV.get(ipStatsKey, { type: 'json' }) || {\r\n        requestsLast24h: 0,\r\n        failedAttempts: 0,\r\n        requestTimestamps: []\r\n    };\r\n    \r\n    // Filter timestamps to last 24 hours\r\n    ipStatsData.requestTimestamps = (ipStatsData.requestTimestamps || []).filter(ts => ts > oneDayAgo);\r\n    ipStatsData.requestsLast24h = ipStatsData.requestTimestamps.length;\r\n    \r\n    return {\r\n        emailStats: emailStatsData,\r\n        ipStats: ipStatsData\r\n    };\r\n}\r\n\r\n/**\r\n * Update usage statistics\r\n * @param {string} emailHash - Hashed email\r\n * @param {string} ipHash - Hashed IP address\r\n * @param {string} customerId - Customer ID\r\n * @param {boolean} success - Whether request was successful\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nasync function updateUsageStats(emailHash, ipHash, customerId, success, env) {\r\n    const now = Date.now();\r\n    \r\n    // Update email stats\r\n    const emailStatsKey = customerId \r\n        ? `cust_${customerId}_stats_email_${emailHash}`\r\n        : `stats_email_${emailHash}`;\r\n    const emailStats = await env.OTP_AUTH_KV.get(emailStatsKey, { type: 'json' }) || {\r\n        totalRequests: 0,\r\n        requestsLast24h: 0,\r\n        failedAttempts: 0,\r\n        lastSuccessfulLogin: null,\r\n        requestTimestamps: []\r\n    };\r\n    \r\n    emailStats.totalRequests = (emailStats.totalRequests || 0) + 1;\r\n    emailStats.requestTimestamps = emailStats.requestTimestamps || [];\r\n    emailStats.requestTimestamps.push(now);\r\n    \r\n    if (!success) {\r\n        emailStats.failedAttempts = (emailStats.failedAttempts || 0) + 1;\r\n    } else {\r\n        emailStats.lastSuccessfulLogin = new Date().toISOString();\r\n    }\r\n    \r\n    // Keep only last 1000 timestamps\r\n    if (emailStats.requestTimestamps.length > 1000) {\r\n        emailStats.requestTimestamps = emailStats.requestTimestamps.slice(-1000);\r\n    }\r\n    \r\n    await env.OTP_AUTH_KV.put(emailStatsKey, JSON.stringify(emailStats), { expirationTtl: 2592000 }); // 30 days\r\n    \r\n    // Update IP stats\r\n    const ipStatsKey = customerId \r\n        ? `cust_${customerId}_stats_ip_${ipHash}`\r\n        : `stats_ip_${ipHash}`;\r\n    const ipStats = await env.OTP_AUTH_KV.get(ipStatsKey, { type: 'json' }) || {\r\n        requestsLast24h: 0,\r\n        failedAttempts: 0,\r\n        requestTimestamps: []\r\n    };\r\n    \r\n    ipStats.requestTimestamps = ipStats.requestTimestamps || [];\r\n    ipStats.requestTimestamps.push(now);\r\n    \r\n    if (!success) {\r\n        ipStats.failedAttempts = (ipStats.failedAttempts || 0) + 1;\r\n    }\r\n    \r\n    // Keep only last 1000 timestamps\r\n    if (ipStats.requestTimestamps.length > 1000) {\r\n        ipStats.requestTimestamps = ipStats.requestTimestamps.slice(-1000);\r\n    }\r\n    \r\n    await env.OTP_AUTH_KV.put(ipStatsKey, JSON.stringify(ipStats), { expirationTtl: 2592000 }); // 30 days\r\n}\r\n\r\n/**\r\n * Hash IP address for storage\r\n * @param {string} ip - IP address\r\n * @returns {Promise<string>} Hashed IP\r\n */\r\nasync function hashIP(ip) {\r\n    const encoder = new TextEncoder();\r\n    const data = encoder.encode(ip);\r\n    const hashBuffer = await crypto.subtle.digest('SHA-256', data);\r\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);\r\n}\r\n\r\n/**\r\n * Check rate limit for OTP requests with IP-based and dynamic throttling\r\n * @param {string} emailHash - Hashed email\r\n * @param {string} customerId - Customer ID (for multi-tenant isolation)\r\n * @param {string} ipAddress - Client IP address\r\n * @param {Function} getCustomerCachedFn - Function to get cached customer\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<{allowed: boolean, remaining: number, resetAt: string, reason?: string}>}\r\n */\r\nexport async function checkOTPRateLimit(emailHash, customerId, ipAddress, getCustomerCachedFn, env) {\r\n    try {\r\n        // Get customer configuration and plan\r\n        let customer = null;\r\n        let plan = 'free';\r\n        let rateLimitPerHour = 3; // Default\r\n        \r\n        if (customerId) {\r\n            customer = await getCustomerCachedFn(customerId);\r\n            if (customer) {\r\n                plan = customer.plan || 'free';\r\n                if (customer.config && customer.config.rateLimits) {\r\n                    rateLimitPerHour = customer.config.rateLimits.otpRequestsPerHour || 3;\r\n                }\r\n            }\r\n        }\r\n        \r\n        const planLimits = getPlanLimits(plan);\r\n        \r\n        // Hash IP address\r\n        const ipHash = await hashIP(ipAddress || 'unknown');\r\n        \r\n        // Get usage statistics for dynamic adjustment\r\n        const { emailStats, ipStats } = await getUsageStats(emailHash, ipHash, customerId, env);\r\n        \r\n        // Calculate dynamic adjustment\r\n        const adjustment = calculateDynamicAdjustment(emailStats, ipStats);\r\n        const adjustedRateLimit = Math.max(1, rateLimitPerHour + adjustment);\r\n        \r\n        // Check IP-based rate limit (hard cap)\r\n        const ipRateLimitKey = customerId \r\n            ? `cust_${customerId}_ratelimit_ip_${ipHash}`\r\n            : `ratelimit_ip_${ipHash}`;\r\n        \r\n        const ipRateLimitData = await env.OTP_AUTH_KV.get(ipRateLimitKey);\r\n        let ipRateLimit = null;\r\n        \r\n        if (ipRateLimitData) {\r\n            try {\r\n                ipRateLimit = typeof ipRateLimitData === 'string' ? JSON.parse(ipRateLimitData) : ipRateLimitData;\r\n            } catch (e) {\r\n                ipRateLimit = null;\r\n            }\r\n        }\r\n        \r\n        const now = Date.now();\r\n        const oneHour = 60 * 60 * 1000;\r\n        \r\n        // Check IP rate limit\r\n        if (ipRateLimit && ipRateLimit.resetAt && now <= new Date(ipRateLimit.resetAt).getTime()) {\r\n            if (ipRateLimit.requests >= planLimits.ipRequestsPerHour) {\r\n                return { \r\n                    allowed: false, \r\n                    remaining: 0, \r\n                    resetAt: ipRateLimit.resetAt,\r\n                    reason: 'ip_rate_limit_exceeded'\r\n                };\r\n            }\r\n            ipRateLimit.requests = (ipRateLimit.requests || 0) + 1;\r\n        } else {\r\n            const resetAt = new Date(now + oneHour).toISOString();\r\n            ipRateLimit = {\r\n                requests: 1,\r\n                resetAt: resetAt\r\n            };\r\n        }\r\n        await env.OTP_AUTH_KV.put(ipRateLimitKey, JSON.stringify(ipRateLimit), { expirationTtl: 3600 });\r\n        \r\n        // Check email-based rate limit (with dynamic adjustment)\r\n        const rateLimitKey = customerId \r\n            ? `cust_${customerId}_ratelimit_otp_${emailHash}`\r\n            : `ratelimit_otp_${emailHash}`;\r\n        \r\n        const rateLimitData = await env.OTP_AUTH_KV.get(rateLimitKey);\r\n        let rateLimit = null;\r\n        \r\n        if (rateLimitData) {\r\n            try {\r\n                rateLimit = typeof rateLimitData === 'string' ? JSON.parse(rateLimitData) : rateLimitData;\r\n            } catch (e) {\r\n                rateLimit = null;\r\n            }\r\n        }\r\n        \r\n        // Check if rate limit exists and is still valid\r\n        if (rateLimit && rateLimit.resetAt && now <= new Date(rateLimit.resetAt).getTime()) {\r\n            // Rate limit exists and is valid\r\n            if (rateLimit.otpRequests >= adjustedRateLimit) {\r\n                return { \r\n                    allowed: false, \r\n                    remaining: 0, \r\n                    resetAt: rateLimit.resetAt,\r\n                    reason: 'email_rate_limit_exceeded'\r\n                };\r\n            }\r\n            \r\n            // Increment counter (this request counts)\r\n            rateLimit.otpRequests = (rateLimit.otpRequests || 0) + 1;\r\n            await env.OTP_AUTH_KV.put(rateLimitKey, JSON.stringify(rateLimit), { expirationTtl: 3600 });\r\n            \r\n            return { \r\n                allowed: true, \r\n                remaining: adjustedRateLimit - rateLimit.otpRequests, \r\n                resetAt: rateLimit.resetAt \r\n            };\r\n        }\r\n        \r\n        // No rate limit or expired - create new one (this request counts as 1)\r\n        const resetAt = new Date(now + oneHour).toISOString();\r\n        const newRateLimit = {\r\n            otpRequests: 1,\r\n            failedAttempts: 0,\r\n            resetAt: resetAt\r\n        };\r\n        await env.OTP_AUTH_KV.put(rateLimitKey, JSON.stringify(newRateLimit), { expirationTtl: 3600 });\r\n        \r\n        return { \r\n            allowed: true, \r\n            remaining: adjustedRateLimit - 1, \r\n            resetAt: resetAt \r\n        };\r\n    } catch (error) {\r\n        console.error('Rate limit check error:', error);\r\n        // Fail closed for security - deny request if rate limiting fails\r\n        // This prevents bypassing rate limits if KV is down\r\n        return { \r\n            allowed: false, \r\n            remaining: 0, \r\n            resetAt: new Date(Date.now() + 3600000).toISOString(),\r\n            reason: 'rate_limit_error'\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Record successful OTP request for statistics\r\n * @param {string} emailHash - Hashed email\r\n * @param {string} ipAddress - Client IP address\r\n * @param {string} customerId - Customer ID\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nexport async function recordOTPRequest(emailHash, ipAddress, customerId, env) {\r\n    try {\r\n        const ipHash = await hashIP(ipAddress || 'unknown');\r\n        await updateUsageStats(emailHash, ipHash, customerId, true, env);\r\n    } catch (error) {\r\n        console.error('Failed to record OTP request:', error);\r\n        // Don't throw - statistics shouldn't break the request\r\n    }\r\n}\r\n\r\n/**\r\n * Record failed OTP attempt for statistics\r\n * @param {string} emailHash - Hashed email\r\n * @param {string} ipAddress - Client IP address\r\n * @param {string} customerId - Customer ID\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nexport async function recordOTPFailure(emailHash, ipAddress, customerId, env) {\r\n    try {\r\n        const ipHash = await hashIP(ipAddress || 'unknown');\r\n        await updateUsageStats(emailHash, ipHash, customerId, false, env);\r\n    } catch (error) {\r\n        console.error('Failed to record OTP failure:', error);\r\n        // Don't throw - statistics shouldn't break the request\r\n    }\r\n}\r\n\r\n", "/**\r\n * Analytics service\r\n * Usage tracking, metrics, and analytics endpoints\r\n */\r\n\r\nimport { getCustomer } from './customer.js';\r\n\r\n/**\r\n * Track response time\r\n * @param {string} customerId - Customer ID\r\n * @param {string} endpoint - Endpoint name\r\n * @param {number} responseTime - Response time in ms\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nexport async function trackResponseTime(customerId, endpoint, responseTime, env) {\r\n    if (!customerId) return;\r\n    \r\n    try {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const metricsKey = `metrics_${customerId}_${today}_${endpoint}`;\r\n        \r\n        const existing = await env.OTP_AUTH_KV.get(metricsKey, { type: 'json' }) || {\r\n            endpoint,\r\n            date: today,\r\n            responseTimes: [],\r\n            count: 0,\r\n            sum: 0\r\n        };\r\n        \r\n        existing.responseTimes.push(responseTime);\r\n        existing.count++;\r\n        existing.sum += responseTime;\r\n        \r\n        // Keep only last 1000 samples\r\n        if (existing.responseTimes.length > 1000) {\r\n            existing.responseTimes = existing.responseTimes.slice(-1000);\r\n        }\r\n        \r\n        // Calculate percentiles\r\n        const sorted = [...existing.responseTimes].sort((a, b) => a - b);\r\n        existing.avgResponseTime = existing.sum / existing.count;\r\n        existing.p50ResponseTime = sorted[Math.floor(sorted.length * 0.5)] || 0;\r\n        existing.p95ResponseTime = sorted[Math.floor(sorted.length * 0.95)] || 0;\r\n        existing.p99ResponseTime = sorted[Math.floor(sorted.length * 0.99)] || 0;\r\n        \r\n        await env.OTP_AUTH_KV.put(metricsKey, JSON.stringify(existing), { expirationTtl: 2592000 });\r\n    } catch (error) {\r\n        console.error('Response time tracking error:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Track error\r\n * @param {string} customerId - Customer ID\r\n * @param {string} category - Error category\r\n * @param {string} message - Error message\r\n * @param {string} endpoint - Endpoint where error occurred\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nexport async function trackError(customerId, category, message, endpoint, env) {\r\n    if (!customerId) return;\r\n    \r\n    try {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const errorKey = `errors_${customerId}_${today}`;\r\n        \r\n        const existing = await env.OTP_AUTH_KV.get(errorKey, { type: 'json' }) || {\r\n            customerId,\r\n            date: today,\r\n            errors: [],\r\n            byCategory: {},\r\n            byEndpoint: {},\r\n            total: 0\r\n        };\r\n        \r\n        existing.errors.push({\r\n            category,\r\n            message,\r\n            endpoint,\r\n            timestamp: new Date().toISOString()\r\n        });\r\n        \r\n        existing.byCategory[category] = (existing.byCategory[category] || 0) + 1;\r\n        existing.byEndpoint[endpoint] = (existing.byEndpoint[endpoint] || 0) + 1;\r\n        existing.total++;\r\n        \r\n        // Keep only last 1000 errors\r\n        if (existing.errors.length > 1000) {\r\n            existing.errors = existing.errors.slice(-1000);\r\n        }\r\n        \r\n        await env.OTP_AUTH_KV.put(errorKey, JSON.stringify(existing), { expirationTtl: 2592000 });\r\n    } catch (error) {\r\n        console.error('Error tracking error:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Track usage metric\r\n * @param {string} customerId - Customer ID\r\n * @param {string} metric - Metric name (otpRequests, otpVerifications, etc.)\r\n * @param {number} increment - Amount to increment (default 1)\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nexport async function trackUsage(customerId, metric, increment = 1, env) {\r\n    if (!customerId) return; // Skip tracking for non-authenticated requests\r\n    \r\n    try {\r\n        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\r\n        const usageKey = `usage_${customerId}_${today}`;\r\n        \r\n        // Get existing usage\r\n        const existingUsage = await env.OTP_AUTH_KV.get(usageKey, { type: 'json' }) || {\r\n            customerId,\r\n            date: today,\r\n            otpRequests: 0,\r\n            otpVerifications: 0,\r\n            successfulLogins: 0,\r\n            failedAttempts: 0,\r\n            emailsSent: 0,\r\n            apiCalls: 0,\r\n            storageUsed: 0,\r\n            lastUpdated: new Date().toISOString()\r\n        };\r\n        \r\n        // Increment metric\r\n        if (existingUsage[metric] !== undefined) {\r\n            existingUsage[metric] = (existingUsage[metric] || 0) + increment;\r\n        } else {\r\n            existingUsage[metric] = increment;\r\n        }\r\n        \r\n        existingUsage.lastUpdated = new Date().toISOString();\r\n        \r\n        // Store with 30-day TTL\r\n        await env.OTP_AUTH_KV.put(usageKey, JSON.stringify(existingUsage), { expirationTtl: 2592000 });\r\n    } catch (error) {\r\n        console.error('Usage tracking error:', error);\r\n        // Don't throw - usage tracking shouldn't break the request\r\n    }\r\n}\r\n\r\n/**\r\n * Get usage for date range\r\n * @param {string} customerId - Customer ID\r\n * @param {string} startDate - Start date (YYYY-MM-DD)\r\n * @param {string} endDate - End date (YYYY-MM-DD)\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<object>} Aggregated usage data\r\n */\r\nexport async function getUsage(customerId, startDate, endDate, env) {\r\n    const usage = {\r\n        customerId,\r\n        period: { start: startDate, end: endDate },\r\n        otpRequests: 0,\r\n        otpVerifications: 0,\r\n        successfulLogins: 0,\r\n        failedAttempts: 0,\r\n        emailsSent: 0,\r\n        apiCalls: 0,\r\n        storageUsed: 0,\r\n        dailyBreakdown: []\r\n    };\r\n    \r\n    // Iterate through date range\r\n    const start = new Date(startDate);\r\n    const end = new Date(endDate);\r\n    \r\n    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {\r\n        const dateStr = d.toISOString().split('T')[0];\r\n        const usageKey = `usage_${customerId}_${dateStr}`;\r\n        const dayUsage = await env.OTP_AUTH_KV.get(usageKey, { type: 'json' });\r\n        \r\n        if (dayUsage) {\r\n            usage.otpRequests += dayUsage.otpRequests || 0;\r\n            usage.otpVerifications += dayUsage.otpVerifications || 0;\r\n            usage.successfulLogins += dayUsage.successfulLogins || 0;\r\n            usage.failedAttempts += dayUsage.failedAttempts || 0;\r\n            usage.emailsSent += dayUsage.emailsSent || 0;\r\n            usage.apiCalls += dayUsage.apiCalls || 0;\r\n            usage.storageUsed += dayUsage.storageUsed || 0;\r\n            \r\n            usage.dailyBreakdown.push({\r\n                date: dateStr,\r\n                otpRequests: dayUsage.otpRequests || 0,\r\n                otpVerifications: dayUsage.otpVerifications || 0,\r\n                successfulLogins: dayUsage.successfulLogins || 0,\r\n                failedAttempts: dayUsage.failedAttempts || 0,\r\n                emailsSent: dayUsage.emailsSent || 0\r\n            });\r\n        }\r\n    }\r\n    \r\n    // Calculate success rate\r\n    usage.successRate = usage.otpRequests > 0 \r\n        ? ((usage.otpVerifications / usage.otpRequests) * 100).toFixed(2)\r\n        : 0;\r\n    \r\n    return usage;\r\n}\r\n\r\n/**\r\n * Get current month usage\r\n * @param {string} customerId - Customer ID\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<object>} Monthly usage\r\n */\r\nexport async function getMonthlyUsage(customerId, env) {\r\n    const now = new Date();\r\n    const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];\r\n    const endDate = now.toISOString().split('T')[0];\r\n    \r\n    return getUsage(customerId, startDate, endDate, env);\r\n}\r\n\r\n/**\r\n * Check quota for customer\r\n * @param {string} customerId - Customer ID\r\n * @param {Function} getCustomerCachedFn - Function to get cached customer\r\n * @param {Function} getPlanLimitsFn - Function to get plan limits\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<{allowed: boolean, reason?: string, quota?: object, usage?: object}>}\r\n */\r\nexport async function checkQuota(customerId, getCustomerCachedFn, getPlanLimitsFn, env) {\r\n    if (!customerId) {\r\n        return { allowed: true }; // No quota check for non-authenticated (backward compat)\r\n    }\r\n    \r\n    try {\r\n        const customer = await getCustomerCachedFn(customerId);\r\n        if (!customer) {\r\n            return { allowed: false, reason: 'customer_not_found' };\r\n        }\r\n        \r\n        const planLimits = getPlanLimitsFn(customer.plan);\r\n        const customerLimits = customer.config?.rateLimits || {};\r\n        \r\n        // Use customer limits if set, otherwise plan limits\r\n        const quota = {\r\n            otpRequestsPerDay: customerLimits.otpRequestsPerDay ?? planLimits.otpRequestsPerDay,\r\n            otpRequestsPerMonth: customerLimits.otpRequestsPerMonth ?? planLimits.otpRequestsPerMonth,\r\n            maxUsers: customerLimits.maxUsers ?? planLimits.maxUsers\r\n        };\r\n        \r\n        // Check daily quota\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const todayUsage = await env.OTP_AUTH_KV.get(`usage_${customerId}_${today}`, { type: 'json' });\r\n        const dailyRequests = todayUsage?.otpRequests || 0;\r\n        \r\n        if (dailyRequests >= quota.otpRequestsPerDay) {\r\n            return {\r\n                allowed: false,\r\n                reason: 'daily_quota_exceeded',\r\n                quota,\r\n                usage: { daily: dailyRequests, monthly: null }\r\n            };\r\n        }\r\n        \r\n        // Check monthly quota\r\n        const monthlyUsage = await getMonthlyUsage(customerId, env);\r\n        if (monthlyUsage.otpRequests >= quota.otpRequestsPerMonth) {\r\n            return {\r\n                allowed: false,\r\n                reason: 'monthly_quota_exceeded',\r\n                quota,\r\n                usage: { daily: dailyRequests, monthly: monthlyUsage.otpRequests }\r\n            };\r\n        }\r\n        \r\n        return {\r\n            allowed: true,\r\n            quota,\r\n            usage: {\r\n                daily: dailyRequests,\r\n                monthly: monthlyUsage.otpRequests,\r\n                remainingDaily: quota.otpRequestsPerDay - dailyRequests,\r\n                remainingMonthly: quota.otpRequestsPerMonth - monthlyUsage.otpRequests\r\n            }\r\n        };\r\n    } catch (error) {\r\n        console.error('Quota check error:', error);\r\n        // Fail open for availability\r\n        return { allowed: true };\r\n    }\r\n}\r\n\r\n", "/**\r\n * Webhook service\r\n * Webhook signing and delivery\r\n */\r\n\r\nimport { getCustomer } from './customer.js';\r\n\r\n/**\r\n * Sign webhook payload\r\n * @param {object} payload - Webhook payload\r\n * @param {string} secret - Webhook secret\r\n * @returns {Promise<string>} HMAC-SHA256 signature\r\n */\r\nexport async function signWebhook(payload, secret) {\r\n    const encoder = new TextEncoder();\r\n    const data = encoder.encode(JSON.stringify(payload));\r\n    const keyData = encoder.encode(secret);\r\n    \r\n    const key = await crypto.subtle.importKey(\r\n        'raw',\r\n        keyData,\r\n        { name: 'HMAC', hash: 'SHA-256' },\r\n        false,\r\n        ['sign']\r\n    );\r\n    \r\n    const signature = await crypto.subtle.sign('HMAC', key, data);\r\n    const hashArray = Array.from(new Uint8Array(signature));\r\n    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\r\n}\r\n\r\n/**\r\n * Send webhook event\r\n * @param {string} customerId - Customer ID\r\n * @param {string} event - Event type\r\n * @param {object} data - Event data\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nexport async function sendWebhook(customerId, event, data, env) {\r\n    try {\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer || !customer.config || !customer.config.webhookConfig) {\r\n            return; // No webhook configured\r\n        }\r\n        \r\n        const webhookConfig = customer.config.webhookConfig;\r\n        if (!webhookConfig.url) {\r\n            return; // No webhook URL\r\n        }\r\n        \r\n        // Check if event is subscribed\r\n        if (webhookConfig.events && webhookConfig.events.length > 0) {\r\n            if (!webhookConfig.events.includes(event) && !webhookConfig.events.includes('*')) {\r\n                return; // Event not subscribed\r\n            }\r\n        }\r\n        \r\n        // Build payload\r\n        const payload = {\r\n            event,\r\n            timestamp: new Date().toISOString(),\r\n            customerId,\r\n            data\r\n        };\r\n        \r\n        // Sign payload\r\n        const signature = webhookConfig.secret \r\n            ? await signWebhook(payload, webhookConfig.secret)\r\n            : null;\r\n        \r\n        // Send webhook\r\n        const response = await fetch(webhookConfig.url, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'X-OTP-Event': event,\r\n                'X-OTP-Timestamp': payload.timestamp,\r\n                ...(signature && { 'X-OTP-Signature': signature })\r\n            },\r\n            body: JSON.stringify(payload)\r\n        });\r\n        \r\n        // Log result\r\n        if (!response.ok) {\r\n            console.error('Webhook delivery failed:', {\r\n                customerId,\r\n                event,\r\n                url: webhookConfig.url,\r\n                status: response.status,\r\n                statusText: response.statusText\r\n            });\r\n            \r\n            // Store failed webhook for retry (simplified - would use queue in production)\r\n            const retryKey = `webhook_retry_${customerId}_${Date.now()}`;\r\n            await env.OTP_AUTH_KV.put(retryKey, JSON.stringify({\r\n                customerId,\r\n                event,\r\n                data,\r\n                url: webhookConfig.url,\r\n                attempts: 1,\r\n                nextRetry: new Date(Date.now() + 60000).toISOString() // 1 minute\r\n            }), { expirationTtl: 86400 }); // 24 hours\r\n        } else {\r\n            console.log('Webhook delivered successfully:', { customerId, event });\r\n        }\r\n    } catch (error) {\r\n        console.error('Webhook error:', error);\r\n        // Don't throw - webhooks shouldn't break the main flow\r\n    }\r\n}\r\n\r\n", "/**\r\n * Security service\r\n * Security logging, IP allowlisting, and audit logging\r\n */\r\n\r\nimport { getCustomer } from './customer.js';\r\n\r\n/**\r\n * Log security event\r\n * @param {string} customerId - Customer ID\r\n * @param {string} eventType - Event type\r\n * @param {object} details - Event details\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nexport async function logSecurityEvent(customerId, eventType, details, env) {\r\n    try {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const auditKey = `audit_${customerId}_${today}`;\r\n        \r\n        const existing = await env.OTP_AUTH_KV.get(auditKey, { type: 'json' }) || {\r\n            customerId,\r\n            date: today,\r\n            events: []\r\n        };\r\n        \r\n        existing.events.push({\r\n            eventType,\r\n            timestamp: new Date().toISOString(),\r\n            ...details\r\n        });\r\n        \r\n        // Keep only last 1000 events\r\n        if (existing.events.length > 1000) {\r\n            existing.events = existing.events.slice(-1000);\r\n        }\r\n        \r\n        await env.OTP_AUTH_KV.put(auditKey, JSON.stringify(existing), { expirationTtl: 7776000 }); // 90 days\r\n    } catch (error) {\r\n        console.error('Security logging error:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Check if IP is in CIDR range (simplified IPv4)\r\n * @param {string} ip - IP address\r\n * @param {string} cidr - CIDR notation (e.g., \"192.168.1.0/24\")\r\n * @returns {boolean} True if IP is in range\r\n */\r\nexport function isIPInCIDR(ip, cidr) {\r\n    try {\r\n        const [network, prefixLength] = cidr.split('/');\r\n        const prefix = parseInt(prefixLength, 10);\r\n        \r\n        const ipParts = ip.split('.').map(Number);\r\n        const networkParts = network.split('.').map(Number);\r\n        \r\n        if (ipParts.length !== 4 || networkParts.length !== 4) {\r\n            return false;\r\n        }\r\n        \r\n        // Convert to 32-bit integers\r\n        const ipNum = (ipParts[0] << 24) + (ipParts[1] << 16) + (ipParts[2] << 8) + ipParts[3];\r\n        const networkNum = (networkParts[0] << 24) + (networkParts[1] << 16) + (networkParts[2] << 8) + networkParts[3];\r\n        const mask = (0xFFFFFFFF << (32 - prefix)) >>> 0;\r\n        \r\n        return (ipNum & mask) === (networkNum & mask);\r\n    } catch (error) {\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * Check IP allowlist\r\n * @param {string} customerId - Customer ID\r\n * @param {string} ip - IP address\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<boolean>} True if IP is allowed\r\n */\r\nexport async function checkIPAllowlist(customerId, ip, env) {\r\n    if (!customerId || !ip) return true; // Allow if no customer or IP\r\n    \r\n    try {\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer || !customer.config || !customer.config.allowedIPs) {\r\n            return true; // No IP restrictions\r\n        }\r\n        \r\n        const allowedIPs = customer.config.allowedIPs;\r\n        \r\n        // Check for wildcard (allow all)\r\n        if (allowedIPs.includes('*')) {\r\n            return true;\r\n        }\r\n        \r\n        // Check exact match\r\n        if (allowedIPs.includes(ip)) {\r\n            return true;\r\n        }\r\n        \r\n        // Check CIDR ranges\r\n        for (const allowed of allowedIPs) {\r\n            if (allowed.includes('/')) {\r\n                // Simple CIDR check (for IPv4)\r\n                if (isIPInCIDR(ip, allowed)) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        \r\n        return false;\r\n    } catch (error) {\r\n        console.error('IP allowlist check error:', error);\r\n        return true; // Fail open\r\n    }\r\n}\r\n\r\n", "/**\r\n * OTP Authentication Service - Standalone Worker\r\n * Cloudflare Worker for multi-tenant OTP authentication\r\n * \r\n * This worker handles:\r\n * - Email OTP Authentication System (secure user authentication)\r\n * - Multi-tenant customer isolation\r\n * - API key management\r\n * - JWT token generation and validation\r\n * \r\n * @version 2.1.0 - Refactored to use modular architecture\r\n */\r\n\r\n// Import landing page HTML\r\nimport landingHtml from './landing-html.js';\r\n\r\n// Import OpenAPI spec\r\nimport openApiSpec from './openapi-json.js';\r\n\r\n// Import utility modules\r\nimport { getCustomerCached as getCustomerCachedUtil, invalidateCustomerCache as invalidateCustomerCacheUtil } from './utils/cache.js';\r\nimport { getCorsHeaders as getCorsHeadersUtil } from './utils/cors.js';\r\nimport { \r\n    generateOTP as generateOTPUtil, \r\n    hashEmail as hashEmailUtil, \r\n    generateUserId as generateUserIdUtil,\r\n    createJWT as createJWTUtil,\r\n    verifyJWT as verifyJWTUtil,\r\n    getJWTSecret as getJWTSecretUtil,\r\n    hashPassword as hashPasswordUtil,\r\n    constantTimeEquals as constantTimeEqualsUtil\r\n} from './utils/crypto.js';\r\nimport {\r\n    escapeHtml as escapeHtmlUtil,\r\n    renderEmailTemplate as renderEmailTemplateUtil,\r\n    getDefaultEmailTemplate as getDefaultEmailTemplateUtil,\r\n    getDefaultTextTemplate as getDefaultTextTemplateUtil,\r\n    getEmailProvider as getEmailProviderUtil\r\n} from './utils/email.js';\r\n\r\n// Import service modules\r\nimport { getCustomerKey, generateCustomerId, getCustomer, storeCustomer } from './services/customer.js';\r\nimport { \r\n    generateApiKey as generateApiKeyService, \r\n    hashApiKey as hashApiKeyService,\r\n    createApiKeyForCustomer,\r\n    verifyApiKey\r\n} from './services/api-key.js';\r\nimport { \r\n    checkOTPRateLimit as checkOTPRateLimitService,\r\n    recordOTPRequest as recordOTPRequestService,\r\n    recordOTPFailure as recordOTPFailureService\r\n} from './services/rate-limit.js';\r\nimport { \r\n    trackResponseTime, \r\n    trackError, \r\n    trackUsage, \r\n    getUsage, \r\n    getMonthlyUsage, \r\n    checkQuota as checkQuotaService\r\n} from './services/analytics.js';\r\nimport { signWebhook, sendWebhook } from './services/webhooks.js';\r\nimport { logSecurityEvent, checkIPAllowlist, isIPInCIDR } from './services/security.js';\r\n\r\n// Wrapper functions for backward compatibility with existing handler code\r\nasync function getCustomerCached(customerId, env) {\r\n    if (!customerId) return null;\r\n    return getCustomerCachedUtil(customerId, async (id) => await getCustomer(id, env));\r\n}\r\n\r\nfunction invalidateCustomerCache(customerId) {\r\n    return invalidateCustomerCacheUtil(customerId);\r\n}\r\n\r\nfunction getCorsHeaders(env, request, customer = null) {\r\n    const origin = request.headers.get('Origin');\r\n    \r\n    // Get customer-specific allowed origins if customer is provided\r\n    let allowedOrigins = [];\r\n    \r\n    if (customer && customer.config && customer.config.allowedOrigins && customer.config.allowedOrigins.length > 0) {\r\n        allowedOrigins = customer.config.allowedOrigins;\r\n    }\r\n    \r\n    // Fallback to environment variable if no customer-specific config\r\n    if (allowedOrigins.length === 0) {\r\n        allowedOrigins = env.ALLOWED_ORIGINS ? env.ALLOWED_ORIGINS.split(',').map(o => o.trim()) : [];\r\n    }\r\n    \r\n    // If no origins configured, allow all (for development only)\r\n    // In production, you MUST set ALLOWED_ORIGINS via: wrangler secret put ALLOWED_ORIGINS\r\n    let allowOrigin = '*'; // Default fallback\r\n    \r\n    if (allowedOrigins.length > 0) {\r\n        // Check for exact match or wildcard patterns\r\n        const matchedOrigin = allowedOrigins.find(allowed => {\r\n            if (allowed === '*') return true;\r\n            if (allowed.endsWith('*')) {\r\n                const prefix = allowed.slice(0, -1);\r\n                return origin && origin.startsWith(prefix);\r\n            }\r\n            return origin === allowed;\r\n        });\r\n        allowOrigin = matchedOrigin === '*' ? '*' : (matchedOrigin || null);\r\n    }\r\n    \r\n    return {\r\n        'Access-Control-Allow-Origin': allowOrigin || 'null',\r\n        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-OTP-API-Key, X-Requested-With, X-CSRF-Token',\r\n        'Access-Control-Allow-Credentials': allowOrigin !== '*' ? 'true' : 'false',\r\n        'Access-Control-Max-Age': '86400',\r\n        // Security headers\r\n        'X-Content-Type-Options': 'nosniff',\r\n        'X-Frame-Options': 'DENY',\r\n        'X-XSS-Protection': '1; mode=block',\r\n        'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',\r\n        'Content-Security-Policy': \"default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'\",\r\n    };\r\n}\r\n\r\n// Crypto utility wrappers\r\nconst generateOTP = generateOTPUtil;\r\nconst hashEmail = hashEmailUtil;\r\nconst generateUserId = generateUserIdUtil;\r\nconst createJWT = createJWTUtil;\r\nconst verifyJWT = verifyJWTUtil;\r\nconst getJWTSecret = getJWTSecretUtil;\r\nconst hashPassword = hashPasswordUtil;\r\nconst constantTimeEquals = constantTimeEqualsUtil;\r\n\r\n// Rate limit wrapper\r\nasync function checkOTPRateLimit(emailHash, customerId, ipAddress, env) {\r\n    return checkOTPRateLimitService(emailHash, customerId, ipAddress, (id) => getCustomerCached(id, env), env);\r\n}\r\n\r\n// Record OTP request for statistics\r\nasync function recordOTPRequest(emailHash, ipAddress, customerId, env) {\r\n    return recordOTPRequestService(emailHash, ipAddress, customerId, env);\r\n}\r\n\r\n// Record OTP failure for statistics\r\nasync function recordOTPFailure(emailHash, ipAddress, customerId, env) {\r\n    return recordOTPFailureService(emailHash, ipAddress, customerId, env);\r\n}\r\n\r\n// Email utility wrappers\r\nconst escapeHtml = escapeHtmlUtil;\r\nconst renderEmailTemplate = renderEmailTemplateUtil;\r\nconst getDefaultEmailTemplate = getDefaultEmailTemplateUtil;\r\nconst getDefaultTextTemplate = getDefaultTextTemplateUtil;\r\n\r\n/**\r\n * Validate required secrets are configured\r\n * @param {*} env - Worker environment\r\n * @returns {object} Validation result with missing secrets\r\n */\r\nfunction validateSecrets(env) {\r\n    const missing = [];\r\n    const warnings = [];\r\n    \r\n    // Required secrets\r\n    if (!env.JWT_SECRET) {\r\n        missing.push('JWT_SECRET');\r\n    }\r\n    if (!env.RESEND_API_KEY) {\r\n        missing.push('RESEND_API_KEY');\r\n    }\r\n    if (!env.RESEND_FROM_EMAIL) {\r\n        missing.push('RESEND_FROM_EMAIL');\r\n    }\r\n    \r\n    // Optional but recommended\r\n    if (!env.ALLOWED_ORIGINS && env.ENVIRONMENT === 'production') {\r\n        warnings.push('ALLOWED_ORIGINS (recommended for production)');\r\n    }\r\n    \r\n    return {\r\n        valid: missing.length === 0,\r\n        missing,\r\n        warnings\r\n    };\r\n}\r\n\r\n/**\r\n * Check for high error rate and alert\r\n * @param {string} customerId - Customer ID\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<void>}\r\n */\r\nasync function checkErrorRateAlert(customerId, env) {\r\n    try {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const usageKey = `usage_${customerId}_${today}`;\r\n        const errorKey = `errors_${customerId}_${today}`;\r\n        \r\n        const usage = await env.OTP_AUTH_KV.get(usageKey, { type: 'json' }) || { otpRequests: 0 };\r\n        const errors = await env.OTP_AUTH_KV.get(errorKey, { type: 'json' }) || { total: 0 };\r\n        \r\n        const totalRequests = usage.otpRequests || 0;\r\n        const totalErrors = errors.total || 0;\r\n        \r\n        if (totalRequests > 0) {\r\n            const errorRate = (totalErrors / totalRequests) * 100;\r\n            \r\n            // Alert if error rate > 5%\r\n            if (errorRate > 5) {\r\n                // Send webhook alert\r\n                await sendWebhook(customerId, 'error_rate_high', {\r\n                    errorRate: errorRate.toFixed(2),\r\n                    totalRequests,\r\n                    totalErrors,\r\n                    threshold: 5\r\n                }, env);\r\n                \r\n                console.warn(`High error rate for customer ${customerId}: ${errorRate.toFixed(2)}%`);\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error('Error rate check failed:', error);\r\n    }\r\n}\r\n\r\n// Email provider wrapper\r\nconst getEmailProvider = getEmailProviderUtil;\r\n\r\n/**\r\n * Send OTP email\r\n * @param {string} email - Recipient email\r\n * @param {string} otp - OTP code\r\n * @param {string} customerId - Customer ID (optional)\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<object>} Email provider response\r\n */\r\nasync function sendOTPEmail(email, otp, customerId, env) {\r\n    if (!env.RESEND_API_KEY) {\r\n        throw new Error('RESEND_API_KEY not configured');\r\n    }\r\n    \r\n        // Get customer configuration if customerId provided\r\n    let customer = null;\r\n    let emailConfig = null;\r\n    let fromEmail = env.RESEND_FROM_EMAIL;\r\n    let fromName = 'OTP Auth Service';\r\n    let subjectTemplate = 'Your Verification Code - {{appName}}';\r\n    let htmlTemplate = null;\r\n    let textTemplate = null;\r\n    let templateVariables = {\r\n        appName: 'OTP Auth Service',\r\n        brandColor: '#007bff',\r\n        footerText: 'This is an automated message, please do not reply.',\r\n        supportUrl: null,\r\n        logoUrl: null\r\n    };\r\n    \r\n    if (customerId) {\r\n        customer = await getCustomerCached(customerId, env);\r\n        if (customer && customer.config && customer.config.emailConfig) {\r\n            emailConfig = customer.config.emailConfig;\r\n            \r\n            // Use customer's email config\r\n            if (emailConfig.fromEmail) {\r\n                fromEmail = emailConfig.fromEmail;\r\n            }\r\n            if (emailConfig.fromName) {\r\n                fromName = emailConfig.fromName;\r\n            }\r\n            if (emailConfig.subjectTemplate) {\r\n                subjectTemplate = emailConfig.subjectTemplate;\r\n            }\r\n            if (emailConfig.htmlTemplate) {\r\n                htmlTemplate = emailConfig.htmlTemplate;\r\n            }\r\n            if (emailConfig.textTemplate) {\r\n                textTemplate = emailConfig.textTemplate;\r\n            }\r\n            if (emailConfig.variables) {\r\n                templateVariables = { ...templateVariables, ...emailConfig.variables };\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Fallback to default if no customer email configured\r\n    if (!fromEmail) {\r\n        throw new Error('RESEND_FROM_EMAIL must be set to your verified domain email (e.g., noreply@yourdomain.com). Set it via: wrangler secret put RESEND_FROM_EMAIL');\r\n    }\r\n    \r\n    // Prepare template variables\r\n    const variables = {\r\n        ...templateVariables,\r\n        otp,\r\n        expiresIn: '10',\r\n        userEmail: email,\r\n        appName: templateVariables.appName || customer?.companyName || 'OTP Auth Service'\r\n    };\r\n    \r\n    // Render templates (HTML template escapes variables for security, text does not)\r\n    const html = renderEmailTemplate(htmlTemplate || getDefaultEmailTemplate(), variables, true);\r\n    const text = renderEmailTemplate(textTemplate || getDefaultTextTemplate(), variables, false);\r\n    const subject = renderEmailTemplate(subjectTemplate, variables, false);\r\n    \r\n    // Build from field\r\n    const from = fromName ? `${fromName} <${fromEmail}>` : fromEmail;\r\n    \r\n    // Get email provider\r\n    const provider = getEmailProvider(customer, env);\r\n    \r\n    try {\r\n        // Send email using provider\r\n        const result = await provider.sendEmail({\r\n            from: from,\r\n            to: email,\r\n            subject: subject,\r\n            html: html,\r\n            text: text\r\n        });\r\n        \r\n        console.log('Email sent successfully:', result);\r\n        return result;\r\n    } catch (error) {\r\n        // Log detailed error for debugging\r\n        console.error('Email sending error:', {\r\n            message: error.message,\r\n            stack: error.stack,\r\n            email: email.toLowerCase().trim(),\r\n            customerId: customerId,\r\n            provider: customer?.config?.emailProvider?.type || 'resend'\r\n        });\r\n        \r\n        throw error;\r\n    }\r\n}\r\n\r\n// Service function wrappers - these are already imported, just use them directly\r\n// getCustomerKey, generateCustomerId, getCustomer, storeCustomer are from services/customer.js\r\n// generateApiKey, hashApiKey, createApiKeyForCustomer, verifyApiKey are from services/api-key.js\r\n// hashPassword is from utils/crypto.js\r\n\r\n/**\r\n * Public signup endpoint\r\n * POST /signup\r\n */\r\nasync function handlePublicSignup(request, env) {\r\n    try {\r\n        const body = await request.json();\r\n        const { email, companyName, password } = body;\r\n        \r\n        // Validate input\r\n        if (!email || !companyName || !password) {\r\n            return new Response(JSON.stringify({ error: 'Email, company name, and password are required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\r\n            return new Response(JSON.stringify({ error: 'Valid email address required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        if (password.length < 8) {\r\n            return new Response(JSON.stringify({ error: 'Password must be at least 8 characters' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const emailLower = email.toLowerCase().trim();\r\n        const emailHash = await hashEmail(emailLower);\r\n        \r\n        // Check if signup already exists\r\n        const signupKey = `signup_${emailHash}`;\r\n        const existingSignup = await env.OTP_AUTH_KV.get(signupKey, { type: 'json' });\r\n        \r\n        if (existingSignup && new Date(existingSignup.expiresAt) > new Date()) {\r\n            return new Response(JSON.stringify({ \r\n                error: 'Signup already in progress. Check your email for verification.',\r\n                expiresAt: existingSignup.expiresAt\r\n            }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Generate verification token\r\n        const verificationToken = generateVerificationToken();\r\n        const verificationCode = generateOTP(); // 6-digit code\r\n        \r\n        // Hash password\r\n        const passwordHash = await hashPassword(password);\r\n        \r\n        // Store signup data\r\n        const signupData = {\r\n            email: emailLower,\r\n            companyName,\r\n            passwordHash,\r\n            verificationToken,\r\n            verificationCode,\r\n            createdAt: new Date().toISOString(),\r\n            expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 24 hours\r\n        };\r\n        \r\n        await env.OTP_AUTH_KV.put(signupKey, JSON.stringify(signupData), { expirationTtl: 86400 });\r\n        \r\n        // Send verification email\r\n        try {\r\n            const emailProvider = getEmailProvider(null, env);\r\n            await emailProvider.sendEmail({\r\n                from: env.RESEND_FROM_EMAIL || 'noreply@otpauth.com',\r\n                to: emailLower,\r\n                subject: 'Verify your OTP Auth Service account',\r\n                html: `\r\n                    <!DOCTYPE html>\r\n                    <html>\r\n                    <head>\r\n                        <meta charset=\"utf-8\">\r\n                        <style>\r\n                            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n                            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n                            .code { font-size: 32px; font-weight: bold; letter-spacing: 8px; text-align: center; background: #f4f4f4; padding: 20px; border-radius: 8px; margin: 20px 0; font-family: monospace; }\r\n                        </style>\r\n                    </head>\r\n                    <body>\r\n                        <div class=\"container\">\r\n                            <h1>Verify Your Account</h1>\r\n                            <p>Your verification code is:</p>\r\n                            <div class=\"code\">${verificationCode}</div>\r\n                            <p>Or click this link to verify: <a href=\"https://otpauth.com/verify?token=${verificationToken}\">Verify Account</a></p>\r\n                            <p>This code expires in 24 hours.</p>\r\n                        </div>\r\n                    </body>\r\n                    </html>\r\n                `,\r\n                text: `Your verification code is: ${verificationCode}\\n\\nOr visit: https://otpauth.com/verify?token=${verificationToken}\\n\\nThis code expires in 24 hours.`\r\n            });\r\n        } catch (error) {\r\n            console.error('Failed to send verification email:', error);\r\n            return new Response(JSON.stringify({ \r\n                error: 'Failed to send verification email',\r\n                message: error.message\r\n            }), {\r\n                status: 500,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            message: 'Signup successful. Check your email for verification code.',\r\n            expiresAt: signupData.expiresAt\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to sign up',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Verify signup\r\n * POST /signup/verify\r\n */\r\nasync function handleVerifySignup(request, env) {\r\n    try {\r\n        const body = await request.json();\r\n        const { email, token, code } = body;\r\n        \r\n        if (!email) {\r\n            return new Response(JSON.stringify({ error: 'Email required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        if (!token && !code) {\r\n            return new Response(JSON.stringify({ error: 'Token or code required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const emailLower = email.toLowerCase().trim();\r\n        const emailHash = await hashEmail(emailLower);\r\n        const signupKey = `signup_${emailHash}`;\r\n        const signupData = await env.OTP_AUTH_KV.get(signupKey, { type: 'json' });\r\n        \r\n        if (!signupData) {\r\n            return new Response(JSON.stringify({ error: 'Signup not found or expired' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Check expiration\r\n        if (new Date(signupData.expiresAt) < new Date()) {\r\n            await env.OTP_AUTH_KV.delete(signupKey);\r\n            return new Response(JSON.stringify({ error: 'Verification expired' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Verify token or code\r\n        const isValid = (token && signupData.verificationToken === token) || \r\n                       (code && signupData.verificationCode === code);\r\n        \r\n        if (!isValid) {\r\n            return new Response(JSON.stringify({ error: 'Invalid verification token or code' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Create customer account\r\n        const customerId = generateCustomerId();\r\n        const customerData = {\r\n            customerId,\r\n            name: signupData.companyName,\r\n            email: emailLower,\r\n            companyName: signupData.companyName,\r\n            plan: 'free',\r\n            status: 'active',\r\n            createdAt: new Date().toISOString(),\r\n            passwordHash: signupData.passwordHash,\r\n            configVersion: 1,\r\n            config: {\r\n                emailConfig: {\r\n                    fromEmail: null,\r\n                    fromName: signupData.companyName,\r\n                    subjectTemplate: 'Your {{appName}} Verification Code',\r\n                    htmlTemplate: null,\r\n                    textTemplate: null,\r\n                    variables: {\r\n                        appName: signupData.companyName,\r\n                        brandColor: '#007bff',\r\n                        footerText: `\u00A9 ${new Date().getFullYear()} ${signupData.companyName}`,\r\n                        supportUrl: null,\r\n                        logoUrl: null\r\n                    }\r\n                },\r\n                rateLimits: {\r\n                    otpRequestsPerHour: 3,\r\n                    otpRequestsPerDay: 50,\r\n                    maxUsers: 100\r\n                },\r\n                webhookConfig: {\r\n                    url: null,\r\n                    secret: null,\r\n                    events: []\r\n                },\r\n                allowedOrigins: []\r\n            },\r\n            features: {\r\n                customEmailTemplates: false,\r\n                webhooks: false,\r\n                analytics: false,\r\n                sso: false\r\n            }\r\n        };\r\n        \r\n        await storeCustomer(customerId, customerData, env);\r\n        \r\n        // Generate initial API key\r\n        const { apiKey, keyId } = await createApiKeyForCustomer(customerId, 'Initial API Key', env);\r\n        \r\n        // Delete signup data\r\n        await env.OTP_AUTH_KV.delete(signupKey);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            customerId,\r\n            apiKey, // Only returned once!\r\n            keyId,\r\n            message: 'Account verified and created successfully. Save your API key - it will not be shown again.',\r\n            customer: {\r\n                customerId,\r\n                name: customerData.name,\r\n                email: customerData.email,\r\n                companyName: customerData.companyName,\r\n                plan: customerData.plan,\r\n                status: customerData.status\r\n            }\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to verify signup',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Register new customer (admin endpoint - kept for backward compatibility)\r\n * POST /admin/customers\r\n */\r\nasync function handleRegisterCustomer(request, env) {\r\n    try {\r\n        const body = await request.json();\r\n        const { name, email, companyName, plan = 'free' } = body;\r\n        \r\n        // Validate input\r\n        if (!name || !email || !companyName) {\r\n            return new Response(JSON.stringify({ error: 'Name, email, and company name are required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\r\n            return new Response(JSON.stringify({ error: 'Valid email address required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Generate customer ID\r\n        const customerId = generateCustomerId();\r\n        \r\n        // Create customer record with default configuration\r\n        const customerData = {\r\n            customerId,\r\n            name,\r\n            email: email.toLowerCase().trim(),\r\n            companyName,\r\n            plan,\r\n            status: 'pending_verification',\r\n            createdAt: new Date().toISOString(),\r\n            configVersion: 1,\r\n            config: {\r\n                emailConfig: {\r\n                    fromEmail: null, // Will be set when domain is verified\r\n                    fromName: companyName,\r\n                    subjectTemplate: 'Your {{appName}} Verification Code',\r\n                    htmlTemplate: null, // Default template used if null\r\n                    textTemplate: null,\r\n                    variables: {\r\n                        appName: companyName,\r\n                        brandColor: '#007bff',\r\n                        footerText: `\u00A9 ${new Date().getFullYear()} ${companyName}`,\r\n                        supportUrl: null,\r\n                        logoUrl: null\r\n                    }\r\n                },\r\n                rateLimits: {\r\n                    otpRequestsPerHour: 10, // Default, will be overridden by plan\r\n                    otpRequestsPerDay: 100,\r\n                    maxUsers: 10000\r\n                },\r\n                webhookConfig: {\r\n                    url: null,\r\n                    secret: null,\r\n                    events: []\r\n                },\r\n                allowedOrigins: [], // Empty = allow all (for development)\r\n                allowedIPs: [] // Empty = allow all IPs\r\n            },\r\n            features: {\r\n                customEmailTemplates: plan !== 'free',\r\n                webhooks: plan !== 'free',\r\n                analytics: plan !== 'free',\r\n                sso: plan === 'enterprise'\r\n            }\r\n        };\r\n        \r\n        // Set plan-based defaults\r\n        if (plan === 'free') {\r\n            customerData.config.rateLimits = {\r\n                otpRequestsPerHour: 3,\r\n                otpRequestsPerDay: 50,\r\n                maxUsers: 100\r\n            };\r\n        } else if (plan === 'starter') {\r\n            customerData.config.rateLimits = {\r\n                otpRequestsPerHour: 10,\r\n                otpRequestsPerDay: 500,\r\n                maxUsers: 1000\r\n            };\r\n        } else if (plan === 'pro') {\r\n            customerData.config.rateLimits = {\r\n                otpRequestsPerHour: 50,\r\n                otpRequestsPerDay: 5000,\r\n                maxUsers: 10000\r\n            };\r\n        } else if (plan === 'enterprise') {\r\n            customerData.config.rateLimits = {\r\n                otpRequestsPerHour: 1000,\r\n                otpRequestsPerDay: 100000,\r\n                maxUsers: 1000000\r\n            };\r\n        }\r\n        \r\n        await storeCustomer(customerId, customerData, env);\r\n        \r\n        // Generate initial API key\r\n        const { apiKey, keyId } = await createApiKeyForCustomer(customerId, 'Initial API Key', env);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            customerId,\r\n            apiKey, // Only returned once!\r\n            keyId,\r\n            message: 'Customer registered successfully. Save your API key - it will not be shown again.',\r\n            customer: {\r\n                customerId,\r\n                name,\r\n                email: customerData.email,\r\n                companyName,\r\n                plan,\r\n                status: customerData.status\r\n            }\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        console.error('Customer registration error:', error);\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to register customer',\r\n            message: error.message,\r\n            details: env.ENVIRONMENT === 'development' ? error.stack : undefined\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * List customer API keys\r\n * GET /admin/customers/{customerId}/api-keys\r\n */\r\nasync function handleListApiKeys(request, env, customerId) {\r\n    try {\r\n        const customerApiKeysKey = `customer_${customerId}_apikeys`;\r\n        const keys = await env.OTP_AUTH_KV.get(customerApiKeysKey, { type: 'json' }) || [];\r\n        \r\n        // Don't expose key hashes, just metadata\r\n        const keysMetadata = keys.map(k => ({\r\n            keyId: k.keyId,\r\n            name: k.name,\r\n            createdAt: k.createdAt,\r\n            lastUsed: k.lastUsed,\r\n            status: k.status\r\n        }));\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            keys: keysMetadata\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to list API keys',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Create new API key for customer\r\n * POST /admin/customers/{customerId}/api-keys\r\n */\r\nasync function handleCreateApiKey(request, env, customerId) {\r\n    try {\r\n        const body = await request.json();\r\n        const { name = 'New API Key' } = body;\r\n        \r\n        // Verify customer exists\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer) {\r\n            return new Response(JSON.stringify({ error: 'Customer not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Create API key\r\n        const { apiKey, keyId } = await createApiKeyForCustomer(customerId, name, env);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            apiKey, // Only returned once!\r\n            keyId,\r\n            name,\r\n            message: 'API key created successfully. Save your API key - it will not be shown again.'\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to create API key',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Validate email template\r\n * @param {string} template - Email template\r\n * @returns {boolean} True if valid\r\n */\r\nfunction validateEmailTemplate(template) {\r\n    if (!template) return true; // Null means use default\r\n    // Must contain {{otp}} variable\r\n    return template.includes('{{otp}}');\r\n}\r\n\r\n/**\r\n * Validate customer configuration\r\n * @param {object} config - Configuration object\r\n * @param {object} customer - Customer data\r\n * @returns {Promise<{valid: boolean, errors: string[]}>}\r\n */\r\nasync function validateCustomerConfig(config, customer) {\r\n    const errors = [];\r\n    \r\n    // Validate email config\r\n    if (config.emailConfig) {\r\n        if (config.emailConfig.fromEmail && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(config.emailConfig.fromEmail)) {\r\n            errors.push('Invalid fromEmail format');\r\n        }\r\n        \r\n        if (config.emailConfig.htmlTemplate && !validateEmailTemplate(config.emailConfig.htmlTemplate)) {\r\n            errors.push('HTML template must contain {{otp}} variable');\r\n        }\r\n        \r\n        if (config.emailConfig.textTemplate && !validateEmailTemplate(config.emailConfig.textTemplate)) {\r\n            errors.push('Text template must contain {{otp}} variable');\r\n        }\r\n    }\r\n    \r\n    // Validate rate limits (must not exceed plan limits)\r\n    if (config.rateLimits) {\r\n        const planLimits = getPlanLimits(customer.plan);\r\n        \r\n        if (config.rateLimits.otpRequestsPerHour > planLimits.otpRequestsPerHour) {\r\n            errors.push(`otpRequestsPerHour cannot exceed plan limit of ${planLimits.otpRequestsPerHour}`);\r\n        }\r\n        \r\n        if (config.rateLimits.otpRequestsPerDay > planLimits.otpRequestsPerDay) {\r\n            errors.push(`otpRequestsPerDay cannot exceed plan limit of ${planLimits.otpRequestsPerDay}`);\r\n        }\r\n        \r\n        if (config.rateLimits.maxUsers > planLimits.maxUsers) {\r\n            errors.push(`maxUsers cannot exceed plan limit of ${planLimits.maxUsers}`);\r\n        }\r\n    }\r\n    \r\n    // Validate webhook URL\r\n    if (config.webhookConfig && config.webhookConfig.url) {\r\n        try {\r\n            new URL(config.webhookConfig.url);\r\n        } catch (e) {\r\n            errors.push('Invalid webhook URL format');\r\n        }\r\n    }\r\n    \r\n    // Validate allowed origins\r\n    if (config.allowedOrigins && !Array.isArray(config.allowedOrigins)) {\r\n        errors.push('allowedOrigins must be an array');\r\n    }\r\n    \r\n    return {\r\n        valid: errors.length === 0,\r\n        errors\r\n    };\r\n}\r\n\r\n/**\r\n * Get plan limits\r\n * @param {string} plan - Plan name\r\n * @returns {object} Plan limits\r\n */\r\nfunction getPlanLimits(plan) {\r\n    const limits = {\r\n        free: {\r\n            otpRequestsPerHour: 3,\r\n            otpRequestsPerDay: 1000,      // Hard cap for free tier\r\n            otpRequestsPerMonth: 10000,    // Hard cap for free tier\r\n            ipRequestsPerHour: 10,\r\n            ipRequestsPerDay: 50,\r\n            maxUsers: 100\r\n        },\r\n        starter: {\r\n            otpRequestsPerHour: 10,\r\n            otpRequestsPerDay: 500,\r\n            otpRequestsPerMonth: 5000,\r\n            ipRequestsPerHour: 20,\r\n            ipRequestsPerDay: 200,\r\n            maxUsers: 1000\r\n        },\r\n        pro: {\r\n            otpRequestsPerHour: 50,\r\n            otpRequestsPerDay: 5000,\r\n            otpRequestsPerMonth: 100000,\r\n            ipRequestsPerHour: 200,\r\n            ipRequestsPerDay: 2000,\r\n            maxUsers: 10000\r\n        },\r\n        enterprise: {\r\n            otpRequestsPerHour: 1000,\r\n            otpRequestsPerDay: 100000,\r\n            otpRequestsPerMonth: 1000000,\r\n            ipRequestsPerHour: 5000,\r\n            ipRequestsPerDay: 50000,\r\n            maxUsers: 1000000\r\n        }\r\n    };\r\n    \r\n    return limits[plan] || limits.free;\r\n}\r\n\r\n/**\r\n * Get customer configuration\r\n * GET /admin/config\r\n */\r\nasync function handleGetConfig(request, env, customerId) {\r\n    try {\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer) {\r\n            return new Response(JSON.stringify({ error: 'Customer not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            config: customer.config || {},\r\n            configVersion: customer.configVersion || 1,\r\n            plan: customer.plan,\r\n            features: customer.features\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to get configuration',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Update customer configuration\r\n * PUT /admin/config\r\n */\r\nasync function handleUpdateConfig(request, env, customerId) {\r\n    try {\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer) {\r\n            return new Response(JSON.stringify({ error: 'Customer not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const body = await request.json();\r\n        const { config } = body;\r\n        \r\n        if (!config) {\r\n            return new Response(JSON.stringify({ error: 'Configuration object required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Merge with existing config (partial updates allowed)\r\n        const existingConfig = customer.config || {};\r\n        const mergedConfig = {\r\n            emailConfig: { ...existingConfig.emailConfig, ...(config.emailConfig || {}) },\r\n            rateLimits: { ...existingConfig.rateLimits, ...(config.rateLimits || {}) },\r\n            webhookConfig: { ...existingConfig.webhookConfig, ...(config.webhookConfig || {}) },\r\n            allowedOrigins: config.allowedOrigins !== undefined ? config.allowedOrigins : existingConfig.allowedOrigins\r\n        };\r\n        \r\n        // Validate configuration\r\n        const validation = await validateCustomerConfig(mergedConfig, customer);\r\n        if (!validation.valid) {\r\n            return new Response(JSON.stringify({\r\n                error: 'Invalid configuration',\r\n                errors: validation.errors\r\n            }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Update customer with new config\r\n        customer.config = mergedConfig;\r\n        customer.configVersion = (customer.configVersion || 1) + 1;\r\n        customer.updatedAt = new Date().toISOString();\r\n        \r\n        await storeCustomer(customerId, customer, env);\r\n        \r\n        // Invalidate cache\r\n        invalidateCustomerCache(customerId);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            config: customer.config,\r\n            configVersion: customer.configVersion,\r\n            message: 'Configuration updated successfully'\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to update configuration',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Update email configuration\r\n * PUT /admin/config/email\r\n */\r\nasync function handleUpdateEmailConfig(request, env, customerId) {\r\n    try {\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer) {\r\n            return new Response(JSON.stringify({ error: 'Customer not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const body = await request.json();\r\n        const emailConfig = body;\r\n        \r\n        // Merge with existing email config\r\n        const existingConfig = customer.config || {};\r\n        const existingEmailConfig = existingConfig.emailConfig || {};\r\n        const mergedEmailConfig = { ...existingEmailConfig, ...emailConfig };\r\n        \r\n        // Validate\r\n        const validation = await validateCustomerConfig({ emailConfig: mergedEmailConfig }, customer);\r\n        if (!validation.valid) {\r\n            return new Response(JSON.stringify({\r\n                error: 'Invalid email configuration',\r\n                errors: validation.errors\r\n            }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Update\r\n        if (!customer.config) customer.config = {};\r\n        customer.config.emailConfig = mergedEmailConfig;\r\n        customer.configVersion = (customer.configVersion || 1) + 1;\r\n        customer.updatedAt = new Date().toISOString();\r\n        \r\n        await storeCustomer(customerId, customer, env);\r\n        \r\n        // Invalidate cache\r\n        invalidateCustomerCache(customerId);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            emailConfig: customer.config.emailConfig,\r\n            message: 'Email configuration updated successfully'\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to update email configuration',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Update customer status\r\n * PUT /admin/customers/{customerId}/status\r\n */\r\nasync function handleUpdateCustomerStatus(request, env, customerId, newStatus) {\r\n    try {\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer) {\r\n            return new Response(JSON.stringify({ error: 'Customer not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Validate status\r\n        const validStatuses = ['active', 'suspended', 'cancelled', 'pending_verification'];\r\n        if (!validStatuses.includes(newStatus)) {\r\n            return new Response(JSON.stringify({ \r\n                error: 'Invalid status',\r\n                validStatuses \r\n            }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Update status\r\n        const oldStatus = customer.status;\r\n        customer.status = newStatus;\r\n        customer.statusChangedAt = new Date().toISOString();\r\n        customer.updatedAt = new Date().toISOString();\r\n        \r\n        await storeCustomer(customerId, customer, env);\r\n        \r\n        // Log status change\r\n        console.log(`Customer ${customerId} status changed from ${oldStatus} to ${newStatus}`);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            customerId,\r\n            oldStatus,\r\n            newStatus,\r\n            statusChangedAt: customer.statusChangedAt,\r\n            message: `Customer status updated to ${newStatus}`\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to update customer status',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Suspend customer\r\n * POST /admin/customers/{customerId}/suspend\r\n */\r\nasync function handleSuspendCustomer(request, env, customerId) {\r\n    return handleUpdateCustomerStatus(request, env, customerId, 'suspended');\r\n}\r\n\r\n/**\r\n * Activate customer\r\n * POST /admin/customers/{customerId}/activate\r\n */\r\nasync function handleActivateCustomer(request, env, customerId) {\r\n    return handleUpdateCustomerStatus(request, env, customerId, 'active');\r\n}\r\n\r\n/**\r\n * Get current customer info\r\n * GET /admin/customers/me\r\n */\r\nasync function handleAdminGetMe(request, env, customerId) {\r\n    try {\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer) {\r\n            return new Response(JSON.stringify({ error: 'Customer not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Don't expose sensitive data\r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            customer: {\r\n                customerId: customer.customerId,\r\n                name: customer.name,\r\n                email: customer.email,\r\n                companyName: customer.companyName,\r\n                plan: customer.plan,\r\n                status: customer.status,\r\n                createdAt: customer.createdAt,\r\n                features: customer.features\r\n            }\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to get customer info',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Update customer info\r\n * PUT /admin/customers/me\r\n */\r\nasync function handleUpdateMe(request, env, customerId) {\r\n    try {\r\n        const customer = await getCustomer(customerId, env);\r\n        if (!customer) {\r\n            return new Response(JSON.stringify({ error: 'Customer not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const body = await request.json();\r\n        const { name, companyName } = body;\r\n        \r\n        // Update allowed fields only\r\n        if (name !== undefined) {\r\n            customer.name = name;\r\n        }\r\n        if (companyName !== undefined) {\r\n            customer.companyName = companyName;\r\n        }\r\n        \r\n        customer.updatedAt = new Date().toISOString();\r\n        await storeCustomer(customerId, customer, env);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            customer: {\r\n                customerId: customer.customerId,\r\n                name: customer.name,\r\n                email: customer.email,\r\n                companyName: customer.companyName,\r\n                plan: customer.plan,\r\n                status: customer.status\r\n            },\r\n            message: 'Customer info updated successfully'\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to update customer info',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Generate domain verification token\r\n * @returns {string} Verification token\r\n */\r\nfunction generateVerificationToken() {\r\n    const array = new Uint8Array(32);\r\n    crypto.getRandomValues(array);\r\n    return Array.from(array)\r\n        .map(b => b.toString(16).padStart(2, '0'))\r\n        .join('');\r\n}\r\n\r\n/**\r\n * Verify domain via DNS lookup\r\n * @param {string} domain - Domain to verify\r\n * @param {string} token - Verification token\r\n * @returns {Promise<boolean>} True if verified\r\n */\r\nasync function verifyDomainDNS(domain, token) {\r\n    try {\r\n        // Use Cloudflare's DNS-over-HTTPS API\r\n        const dnsQuery = `_otpauth-verify.${domain}`;\r\n        const dohUrl = `https://cloudflare-dns.com/dns-query?name=${encodeURIComponent(dnsQuery)}&type=TXT`;\r\n        \r\n        const response = await fetch(dohUrl, {\r\n            headers: {\r\n                'Accept': 'application/dns-json'\r\n            }\r\n        });\r\n        \r\n        if (!response.ok) {\r\n            return false;\r\n        }\r\n        \r\n        const data = await response.json();\r\n        \r\n        // Check if TXT record exists and contains token\r\n        if (data.Answer && Array.isArray(data.Answer)) {\r\n            for (const answer of data.Answer) {\r\n                if (answer.type === 16 && answer.data) {\r\n                    // TXT record data is in quotes, remove them\r\n                    const recordValue = answer.data.replace(/^\"|\"$/g, '');\r\n                    if (recordValue === token) {\r\n                        return true;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        return false;\r\n    } catch (error) {\r\n        console.error('DNS verification error:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * Request domain verification\r\n * POST /admin/domains/verify\r\n */\r\nasync function handleRequestDomainVerification(request, env, customerId) {\r\n    try {\r\n        const body = await request.json();\r\n        const { domain } = body;\r\n        \r\n        if (!domain || !/^[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?)*$/.test(domain)) {\r\n            return new Response(JSON.stringify({ error: 'Valid domain name required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Generate verification token\r\n        const token = generateVerificationToken();\r\n        \r\n        // Store verification record\r\n        const domainKey = `domain_${domain}`;\r\n        const verificationData = {\r\n            domain,\r\n            customerId,\r\n            token,\r\n            status: 'pending',\r\n            createdAt: new Date().toISOString(),\r\n            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days\r\n        };\r\n        \r\n        await env.OTP_AUTH_KV.put(domainKey, JSON.stringify(verificationData), { expirationTtl: 604800 }); // 7 days\r\n        \r\n        // DNS record instructions\r\n        const dnsRecord = {\r\n            type: 'TXT',\r\n            name: `_otpauth-verify.${domain}`,\r\n            value: token,\r\n            ttl: 3600\r\n        };\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            domain,\r\n            status: 'pending',\r\n            dnsRecord,\r\n            instructions: `Add a TXT record to your DNS with name \"_otpauth-verify.${domain}\" and value \"${token}\". Then call POST /admin/domains/${domain}/verify to check verification.`\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to request domain verification',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Check domain verification status\r\n * GET /admin/domains/{domain}/status\r\n */\r\nasync function handleGetDomainStatus(request, env, domain) {\r\n    try {\r\n        const domainKey = `domain_${domain}`;\r\n        const verificationData = await env.OTP_AUTH_KV.get(domainKey, { type: 'json' });\r\n        \r\n        if (!verificationData) {\r\n            return new Response(JSON.stringify({ \r\n                error: 'Domain verification not found',\r\n                domain,\r\n                status: 'not_started'\r\n            }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            domain: verificationData.domain,\r\n            status: verificationData.status,\r\n            createdAt: verificationData.createdAt,\r\n            verifiedAt: verificationData.verifiedAt || null,\r\n            expiresAt: verificationData.expiresAt\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to get domain status',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Verify domain (check DNS and update status)\r\n * POST /admin/domains/{domain}/verify\r\n */\r\nasync function handleVerifyDomain(request, env, customerId, domain) {\r\n    try {\r\n        const domainKey = `domain_${domain}`;\r\n        const verificationData = await env.OTP_AUTH_KV.get(domainKey, { type: 'json' });\r\n        \r\n        if (!verificationData) {\r\n            return new Response(JSON.stringify({ \r\n                error: 'Domain verification not found. Request verification first.',\r\n                domain\r\n            }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Verify customer owns this domain\r\n        if (verificationData.customerId !== customerId) {\r\n            return new Response(JSON.stringify({ error: 'Forbidden' }), {\r\n                status: 403,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Check if already verified\r\n        if (verificationData.status === 'verified') {\r\n            return new Response(JSON.stringify({\r\n                success: true,\r\n                domain,\r\n                status: 'verified',\r\n                verifiedAt: verificationData.verifiedAt,\r\n                message: 'Domain is already verified'\r\n            }), {\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Check expiration\r\n        if (new Date(verificationData.expiresAt) < new Date()) {\r\n            return new Response(JSON.stringify({\r\n                error: 'Verification expired. Please request a new verification.',\r\n                domain\r\n            }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Verify DNS record\r\n        const isVerified = await verifyDomainDNS(domain, verificationData.token);\r\n        \r\n        if (isVerified) {\r\n            // Update verification status\r\n            verificationData.status = 'verified';\r\n            verificationData.verifiedAt = new Date().toISOString();\r\n            await env.OTP_AUTH_KV.put(domainKey, JSON.stringify(verificationData));\r\n            \r\n            // Update customer email config to use verified domain\r\n            const customer = await getCustomer(customerId, env);\r\n            if (customer) {\r\n                if (!customer.config) customer.config = {};\r\n                if (!customer.config.emailConfig) customer.config.emailConfig = {};\r\n                \r\n                // Set fromEmail if not already set\r\n                if (!customer.config.emailConfig.fromEmail) {\r\n                    customer.config.emailConfig.fromEmail = `noreply@${domain}`;\r\n                }\r\n                \r\n                await storeCustomer(customerId, customer, env);\r\n            }\r\n            \r\n            return new Response(JSON.stringify({\r\n                success: true,\r\n                domain,\r\n                status: 'verified',\r\n                verifiedAt: verificationData.verifiedAt,\r\n                message: 'Domain verified successfully'\r\n            }), {\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        } else {\r\n            return new Response(JSON.stringify({\r\n                success: false,\r\n                domain,\r\n                status: 'pending',\r\n                message: 'DNS record not found or token mismatch. Please check your DNS configuration.'\r\n            }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to verify domain',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n// Analytics functions are imported from services/analytics.js\r\n// Wrapper for checkQuota to pass getPlanLimits\r\nasync function checkQuota(customerId, env) {\r\n    return checkQuotaService(customerId, async (id) => await getCustomerCached(id, env), getPlanLimits, env);\r\n}\r\n\r\n/**\r\n * Get analytics\r\n * GET /admin/analytics\r\n */\r\nasync function handleGetAnalytics(request, env, customerId) {\r\n    try {\r\n        const url = new URL(request.url);\r\n        const startDate = url.searchParams.get('startDate') || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\r\n        const endDate = url.searchParams.get('endDate') || new Date().toISOString().split('T')[0];\r\n        const granularity = url.searchParams.get('granularity') || 'day';\r\n        \r\n        const usage = await getUsage(customerId, startDate, endDate, env);\r\n        \r\n        // Calculate metrics\r\n        const metrics = {\r\n            otpRequests: usage.otpRequests,\r\n            otpVerifications: usage.otpVerifications,\r\n            successRate: parseFloat(usage.successRate),\r\n            emailsSent: usage.emailsSent,\r\n            uniqueUsers: 0, // TODO: Track unique users\r\n            newUsers: 0 // TODO: Track new users\r\n        };\r\n        \r\n        // Format response based on granularity\r\n        const response = {\r\n            success: true,\r\n            period: {\r\n                start: startDate,\r\n                end: endDate\r\n            },\r\n            metrics,\r\n            dailyBreakdown: granularity === 'day' ? usage.dailyBreakdown : undefined\r\n        };\r\n        \r\n        return new Response(JSON.stringify(response), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to get analytics',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Get real-time analytics\r\n * GET /admin/analytics/realtime\r\n */\r\nasync function handleGetRealtimeAnalytics(request, env, customerId) {\r\n    try {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const now = new Date();\r\n        \r\n        // Get today's usage\r\n        const todayUsage = await env.OTP_AUTH_KV.get(`usage_${customerId}_${today}`, { type: 'json' }) || {};\r\n        \r\n        // Get last 24 hours (approximate - would need hourly tracking for exact)\r\n        const yesterday = new Date(now);\r\n        yesterday.setDate(yesterday.getDate() - 1);\r\n        const yesterdayStr = yesterday.toISOString().split('T')[0];\r\n        const yesterdayUsage = await env.OTP_AUTH_KV.get(`usage_${customerId}_${yesterdayStr}`, { type: 'json' }) || {};\r\n        \r\n        // Calculate last 24 hours (today + partial yesterday)\r\n        const last24Hours = {\r\n            otpRequests: (todayUsage.otpRequests || 0) + (yesterdayUsage.otpRequests || 0),\r\n            otpVerifications: (todayUsage.otpVerifications || 0) + (yesterdayUsage.otpVerifications || 0)\r\n        };\r\n        \r\n        // Get response time metrics for today\r\n        const responseTimeMetrics = {};\r\n        const endpoints = ['request-otp', 'verify-otp', 'me', 'logout', 'refresh'];\r\n        for (const endpoint of endpoints) {\r\n            const metricsKey = `metrics_${customerId}_${today}_${endpoint}`;\r\n            const metrics = await env.OTP_AUTH_KV.get(metricsKey, { type: 'json' });\r\n            if (metrics) {\r\n                responseTimeMetrics[endpoint] = {\r\n                    avg: metrics.avgResponseTime || 0,\r\n                    p50: metrics.p50ResponseTime || 0,\r\n                    p95: metrics.p95ResponseTime || 0,\r\n                    p99: metrics.p99ResponseTime || 0\r\n                };\r\n            }\r\n        }\r\n        \r\n        // Get error rate for today\r\n        const errorKey = `errors_${customerId}_${today}`;\r\n        const errorData = await env.OTP_AUTH_KV.get(errorKey, { type: 'json' }) || { total: 0 };\r\n        const totalRequests = todayUsage.otpRequests || 0;\r\n        const errorRate = totalRequests > 0 ? ((errorData.total / totalRequests) * 100).toFixed(2) : 0;\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            currentHour: {\r\n                otpRequests: todayUsage.otpRequests || 0,\r\n                otpVerifications: todayUsage.otpVerifications || 0,\r\n                activeUsers: 0 // TODO: Track active users\r\n            },\r\n            last24Hours,\r\n            responseTimeMetrics,\r\n            errorRate: parseFloat(errorRate),\r\n            lastUpdated: new Date().toISOString()\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to get real-time analytics',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Get error analytics\r\n * GET /admin/analytics/errors\r\n */\r\nasync function handleGetErrorAnalytics(request, env, customerId) {\r\n    try {\r\n        const url = new URL(request.url);\r\n        const startDate = url.searchParams.get('startDate') || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\r\n        const endDate = url.searchParams.get('endDate') || new Date().toISOString().split('T')[0];\r\n        const category = url.searchParams.get('category');\r\n        \r\n        const errors = [];\r\n        const byCategory = {};\r\n        const byEndpoint = {};\r\n        let total = 0;\r\n        \r\n        // Iterate through date range\r\n        const start = new Date(startDate);\r\n        const end = new Date(endDate);\r\n        \r\n        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {\r\n            const dateStr = d.toISOString().split('T')[0];\r\n            const errorKey = `errors_${customerId}_${dateStr}`;\r\n            const dayErrors = await env.OTP_AUTH_KV.get(errorKey, { type: 'json' });\r\n            \r\n            if (dayErrors) {\r\n                // Filter by category if specified\r\n                const filteredErrors = category \r\n                    ? dayErrors.errors.filter(e => e.category === category)\r\n                    : dayErrors.errors;\r\n                \r\n                errors.push(...filteredErrors);\r\n                \r\n                // Aggregate by category\r\n                for (const [cat, count] of Object.entries(dayErrors.byCategory || {})) {\r\n                    if (!category || cat === category) {\r\n                        byCategory[cat] = (byCategory[cat] || 0) + count;\r\n                    }\r\n                }\r\n                \r\n                // Aggregate by endpoint\r\n                for (const [ep, count] of Object.entries(dayErrors.byEndpoint || {})) {\r\n                    byEndpoint[ep] = (byEndpoint[ep] || 0) + count;\r\n                }\r\n                \r\n                total += category ? filteredErrors.length : dayErrors.total;\r\n            }\r\n        }\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            period: { start: startDate, end: endDate },\r\n            total,\r\n            byCategory,\r\n            byEndpoint,\r\n            recentErrors: errors.slice(-100) // Last 100 errors\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to get error analytics',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n// Webhook functions are imported from services/webhooks.js\r\n\r\n/**\r\n * Rotate API key\r\n * POST /admin/customers/{customerId}/api-keys/{keyId}/rotate\r\n */\r\nasync function handleRotateApiKey(request, env, customerId, keyId) {\r\n    try {\r\n        // Find the API key in customer's list\r\n        const customerApiKeysKey = `customer_${customerId}_apikeys`;\r\n        const customerKeys = await env.OTP_AUTH_KV.get(customerApiKeysKey, { type: 'json' }) || [];\r\n        const keyIndex = customerKeys.findIndex(k => k.keyId === keyId);\r\n        \r\n        if (keyIndex < 0) {\r\n            return new Response(JSON.stringify({ error: 'API key not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Create new API key\r\n        const { apiKey: newApiKey, keyId: newKeyId } = await createApiKeyForCustomer(\r\n            customerId, \r\n            `${customerKeys[keyIndex].name} (rotated)`, \r\n            env\r\n        );\r\n        \r\n        // Mark old key as rotated (keep for 7 days grace period)\r\n        customerKeys[keyIndex].status = 'rotated';\r\n        customerKeys[keyIndex].rotatedAt = new Date().toISOString();\r\n        customerKeys[keyIndex].replacedBy = newKeyId;\r\n        await env.OTP_AUTH_KV.put(customerApiKeysKey, JSON.stringify(customerKeys));\r\n        \r\n        // Log rotation\r\n        await logSecurityEvent(customerId, 'api_key_rotated', {\r\n            oldKeyId: keyId,\r\n            newKeyId: newKeyId\r\n        }, env);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            apiKey: newApiKey, // Only returned once!\r\n            keyId: newKeyId,\r\n            oldKeyId: keyId,\r\n            message: 'API key rotated successfully. Old key will work for 7 days. Save your new API key - it will not be shown again.'\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to rotate API key',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Get onboarding progress\r\n * GET /admin/onboarding\r\n */\r\nasync function handleGetOnboarding(request, env, customerId) {\r\n    try {\r\n        const onboardingKey = `onboarding_${customerId}`;\r\n        const onboarding = await env.OTP_AUTH_KV.get(onboardingKey, { type: 'json' }) || {\r\n            customerId,\r\n            step: 1,\r\n            completed: false,\r\n            steps: {\r\n                accountCreated: false,\r\n                emailVerified: false,\r\n                apiKeyGenerated: false,\r\n                firstTestCompleted: false,\r\n                webhookConfigured: false,\r\n                emailTemplateConfigured: false\r\n            },\r\n            createdAt: new Date().toISOString()\r\n        };\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            onboarding\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to get onboarding status',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Update onboarding progress\r\n * PUT /admin/onboarding\r\n */\r\nasync function handleUpdateOnboarding(request, env, customerId) {\r\n    try {\r\n        const body = await request.json();\r\n        const { step, completed, steps } = body;\r\n        \r\n        const onboardingKey = `onboarding_${customerId}`;\r\n        const existing = await env.OTP_AUTH_KV.get(onboardingKey, { type: 'json' }) || {\r\n            customerId,\r\n            step: 1,\r\n            completed: false,\r\n            steps: {\r\n                accountCreated: false,\r\n                emailVerified: false,\r\n                apiKeyGenerated: false,\r\n                firstTestCompleted: false,\r\n                webhookConfigured: false,\r\n                emailTemplateConfigured: false\r\n            },\r\n            createdAt: new Date().toISOString()\r\n        };\r\n        \r\n        if (step !== undefined) existing.step = step;\r\n        if (completed !== undefined) existing.completed = completed;\r\n        if (steps) existing.steps = { ...existing.steps, ...steps };\r\n        existing.updatedAt = new Date().toISOString();\r\n        \r\n        await env.OTP_AUTH_KV.put(onboardingKey, JSON.stringify(existing), { expirationTtl: 2592000 });\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            onboarding: existing\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to update onboarding',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Test OTP request (for onboarding)\r\n * POST /admin/onboarding/test-otp\r\n */\r\nasync function handleTestOTP(request, env, customerId) {\r\n    try {\r\n        const body = await request.json();\r\n        const { email } = body;\r\n        \r\n        if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\r\n            return new Response(JSON.stringify({ error: 'Valid email address required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Use the actual OTP request handler\r\n        const testRequest = new Request(request.url, {\r\n            method: 'POST',\r\n            headers: request.headers,\r\n            body: JSON.stringify({ email })\r\n        });\r\n        \r\n        const response = await handleRequestOTP(testRequest, env, customerId);\r\n        \r\n        // If successful, update onboarding\r\n        if (response.ok) {\r\n            const onboardingKey = `onboarding_${customerId}`;\r\n            const onboarding = await env.OTP_AUTH_KV.get(onboardingKey, { type: 'json' }) || {};\r\n            onboarding.steps = onboarding.steps || {};\r\n            onboarding.steps.firstTestCompleted = true;\r\n            onboarding.step = Math.max(onboarding.step || 1, 4);\r\n            await env.OTP_AUTH_KV.put(onboardingKey, JSON.stringify(onboarding), { expirationTtl: 2592000 });\r\n        }\r\n        \r\n        return response;\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to test OTP',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n// Security functions are imported from services/security.js\r\n\r\n/**\r\n * Export user data (GDPR)\r\n * GET /admin/users/{userId}/export\r\n */\r\nasync function handleExportUserData(request, env, customerId, userId) {\r\n    try {\r\n        // Get user data\r\n        const userKey = getCustomerKey(customerId, `user_${userId.replace('user_', '')}`);\r\n        const user = await env.OTP_AUTH_KV.get(userKey, { type: 'json' });\r\n        \r\n        if (!user) {\r\n            return new Response(JSON.stringify({ error: 'User not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Get all related data\r\n        const emailHash = await hashEmail(user.email);\r\n        const exportData = {\r\n            userId: user.userId,\r\n            email: user.email,\r\n            createdAt: user.createdAt,\r\n            lastLogin: user.lastLogin,\r\n            // Note: OTP codes are not stored after use, so no OTP history\r\n            // Sessions are stored but don't contain sensitive data\r\n        };\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            data: exportData,\r\n            exportedAt: new Date().toISOString()\r\n        }), {\r\n            headers: { \r\n                ...getCorsHeaders(env, request), \r\n                'Content-Type': 'application/json',\r\n                'Content-Disposition': `attachment; filename=\"user-data-${userId}.json\"`\r\n            },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to export user data',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Delete user data (GDPR)\r\n * DELETE /admin/users/{userId}\r\n */\r\nasync function handleDeleteUserData(request, env, customerId, userId) {\r\n    try {\r\n        // Get user data first\r\n        const userKey = getCustomerKey(customerId, `user_${userId.replace('user_', '')}`);\r\n        const user = await env.OTP_AUTH_KV.get(userKey, { type: 'json' });\r\n        \r\n        if (!user) {\r\n            return new Response(JSON.stringify({ error: 'User not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const emailHash = await hashEmail(user.email);\r\n        \r\n        // Delete all user-related data\r\n        // Note: We can't easily list all OTP keys, but they expire automatically\r\n        // Delete user record\r\n        await env.OTP_AUTH_KV.delete(userKey);\r\n        \r\n        // Delete session\r\n        const sessionKey = getCustomerKey(customerId, `session_${userId}`);\r\n        await env.OTP_AUTH_KV.delete(sessionKey);\r\n        \r\n        // Delete latest OTP key reference\r\n        const latestOtpKey = getCustomerKey(customerId, `otp_latest_${emailHash}`);\r\n        await env.OTP_AUTH_KV.delete(latestOtpKey);\r\n        \r\n        // Log deletion for audit\r\n        await logSecurityEvent(customerId, 'user_data_deleted', {\r\n            userId,\r\n            email: user.email,\r\n            deletedAt: new Date().toISOString()\r\n        }, env);\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            message: 'User data deleted successfully'\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to delete user data',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Get audit logs\r\n * GET /admin/audit-logs\r\n */\r\nasync function handleGetAuditLogs(request, env, customerId) {\r\n    try {\r\n        const url = new URL(request.url);\r\n        const startDate = url.searchParams.get('startDate') || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\r\n        const endDate = url.searchParams.get('endDate') || new Date().toISOString().split('T')[0];\r\n        const eventType = url.searchParams.get('eventType');\r\n        \r\n        const events = [];\r\n        \r\n        // Iterate through date range\r\n        const start = new Date(startDate);\r\n        const end = new Date(endDate);\r\n        \r\n        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {\r\n            const dateStr = d.toISOString().split('T')[0];\r\n            const auditKey = `audit_${customerId}_${dateStr}`;\r\n            const dayAudit = await env.OTP_AUTH_KV.get(auditKey, { type: 'json' });\r\n            \r\n            if (dayAudit && dayAudit.events) {\r\n                const filteredEvents = eventType \r\n                    ? dayAudit.events.filter(e => e.eventType === eventType)\r\n                    : dayAudit.events;\r\n                \r\n                events.push(...filteredEvents);\r\n            }\r\n        }\r\n        \r\n        // Sort by timestamp (newest first)\r\n        events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            period: { start: startDate, end: endDate },\r\n            total: events.length,\r\n            events: events.slice(0, 1000) // Limit to 1000 most recent\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to get audit logs',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Revoke API key\r\n * DELETE /admin/customers/{customerId}/api-keys/{keyId}\r\n */\r\nasync function handleRevokeApiKey(request, env, customerId, keyId) {\r\n    try {\r\n        // Find the API key in customer's list\r\n        const customerApiKeysKey = `customer_${customerId}_apikeys`;\r\n        const customerKeys = await env.OTP_AUTH_KV.get(customerApiKeysKey, { type: 'json' }) || [];\r\n        const keyIndex = customerKeys.findIndex(k => k.keyId === keyId);\r\n        \r\n        if (keyIndex < 0) {\r\n            return new Response(JSON.stringify({ error: 'API key not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Mark as revoked in customer's list\r\n        customerKeys[keyIndex].status = 'revoked';\r\n        customerKeys[keyIndex].revokedAt = new Date().toISOString();\r\n        await env.OTP_AUTH_KV.put(customerApiKeysKey, JSON.stringify(customerKeys));\r\n        \r\n        // Note: We can't delete the hash->keyId mapping without the original key\r\n        // But we check status in verifyApiKey, so revoked keys won't work\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            message: 'API key revoked successfully'\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({\r\n            error: 'Failed to revoke API key',\r\n            message: error.message\r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Request OTP endpoint\r\n * POST /auth/request-otp\r\n */\r\nasync function handleRequestOTP(request, env, customerId = null) {\r\n    try {\r\n        const body = await request.json();\r\n        const { email } = body;\r\n        \r\n        // Validate email\r\n        if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\r\n            // RFC 7807 Problem Details for HTTP APIs\r\n            return new Response(JSON.stringify({ \r\n                type: 'https://tools.ietf.org/html/rfc7231#section-6.5.1',\r\n                title: 'Bad Request',\r\n                status: 400,\r\n                detail: 'Valid email address required',\r\n                instance: request.url,\r\n            }), {\r\n                status: 400,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        // Check quota first\r\n        const quotaCheck = await checkQuota(customerId, env);\r\n        if (!quotaCheck.allowed) {\r\n            // Send webhook for quota exceeded\r\n            if (customerId) {\r\n                await sendWebhook(customerId, 'quota.exceeded', {\r\n                    reason: quotaCheck.reason,\r\n                    quota: quotaCheck.quota,\r\n                    usage: quotaCheck.usage\r\n                }, env);\r\n            }\r\n            \r\n            // RFC 7807 Problem Details for HTTP APIs\r\n            return new Response(JSON.stringify({ \r\n                type: 'https://tools.ietf.org/html/rfc6585#section-4',\r\n                title: 'Too Many Requests',\r\n                status: 429,\r\n                detail: 'Quota exceeded',\r\n                instance: request.url,\r\n                reason: quotaCheck.reason,\r\n                quota: quotaCheck.quota,\r\n                usage: quotaCheck.usage,\r\n            }), {\r\n                status: 429,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                    'X-Quota-Limit': quotaCheck.quota?.otpRequestsPerDay?.toString() || '',\r\n                    'X-Quota-Remaining': quotaCheck.usage?.remainingDaily?.toString() || '0',\r\n                    'Retry-After': '3600', // Retry after 1 hour\r\n                },\r\n            });\r\n        }\r\n        \r\n        // Check rate limit\r\n        const emailHash = await hashEmail(email);\r\n        const clientIP = request.headers.get('CF-Connecting-IP') || request.headers.get('X-Forwarded-For') || 'unknown';\r\n        const rateLimit = await checkOTPRateLimit(emailHash, customerId, clientIP, env);\r\n        \r\n        if (!rateLimit.allowed) {\r\n            // Record failed rate limit attempt\r\n            await recordOTPFailure(emailHash, clientIP, customerId, env);\r\n            \r\n            // RFC 7807 Problem Details for HTTP APIs\r\n            return new Response(JSON.stringify({ \r\n                type: 'https://tools.ietf.org/html/rfc6585#section-4',\r\n                title: 'Too Many Requests',\r\n                status: 429,\r\n                detail: 'Too many requests. Please try again later.',\r\n                instance: request.url,\r\n                retry_after: Math.ceil((new Date(rateLimit.resetAt).getTime() - Date.now()) / 1000),\r\n                reset_at: rateLimit.resetAt,\r\n                remaining: rateLimit.remaining,\r\n                reason: rateLimit.reason || 'rate_limit_exceeded',\r\n            }), {\r\n                status: 429,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                    'Retry-After': Math.ceil((new Date(rateLimit.resetAt).getTime() - Date.now()) / 1000).toString(),\r\n                },\r\n            });\r\n        }\r\n        \r\n        // Generate OTP\r\n        const otp = generateOTP();\r\n        const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes\r\n        \r\n        // Store OTP in KV with customer isolation\r\n        const otpKey = getCustomerKey(customerId, `otp_${emailHash}_${Date.now()}`);\r\n        await env.OTP_AUTH_KV.put(otpKey, JSON.stringify({\r\n            email: email.toLowerCase().trim(),\r\n            otp,\r\n            expiresAt: expiresAt.toISOString(),\r\n            attempts: 0,\r\n        }), { expirationTtl: 600 }); // 10 minutes TTL\r\n        \r\n        // Also store latest OTP for quick lookup (overwrites previous)\r\n        const latestOtpKey = getCustomerKey(customerId, `otp_latest_${emailHash}`);\r\n        await env.OTP_AUTH_KV.put(latestOtpKey, otpKey, { expirationTtl: 600 });\r\n        \r\n        // Send email\r\n        try {\r\n            const emailResult = await sendOTPEmail(email, otp, customerId, env);\r\n            console.log('OTP email sent successfully:', emailResult);\r\n            \r\n            // Track usage\r\n            if (customerId) {\r\n                await trackUsage(customerId, 'otpRequests', 1, env);\r\n                await trackUsage(customerId, 'emailsSent', 1, env);\r\n                \r\n                // Send webhook\r\n                await sendWebhook(customerId, 'otp.requested', {\r\n                    email: email.toLowerCase().trim(),\r\n                    expiresIn: 600\r\n                }, env);\r\n            }\r\n            \r\n            // Record successful OTP request for statistics\r\n            await recordOTPRequest(emailHash, clientIP, customerId, env);\r\n        } catch (error) {\r\n            // Log the full error for debugging\r\n            console.error('Failed to send OTP email:', {\r\n                message: error.message,\r\n                stack: error.stack,\r\n                email: email.toLowerCase().trim(),\r\n                hasResendKey: !!env.RESEND_API_KEY\r\n            });\r\n            // Return error so user knows email failed\r\n            return new Response(JSON.stringify({ \r\n                error: 'Failed to send email. Please check your email address and try again.',\r\n                details: env.ENVIRONMENT === 'development' ? error.message : undefined\r\n            }), {\r\n                status: 500,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        return new Response(JSON.stringify({ \r\n            success: true,\r\n            message: 'OTP sent to email',\r\n            expiresIn: 600,\r\n            remaining: rateLimit.remaining\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        console.error('OTP request error:', {\r\n            message: error.message,\r\n            stack: error.stack,\r\n            name: error.name\r\n        });\r\n        // RFC 7807 Problem Details for HTTP APIs\r\n        return new Response(JSON.stringify({ \r\n            type: 'https://tools.ietf.org/html/rfc7231#section-6.6.1',\r\n            title: 'Internal Server Error',\r\n            status: 500,\r\n            detail: 'Failed to request OTP',\r\n            instance: request.url,\r\n        }), {\r\n            status: 500,\r\n            headers: { \r\n                ...getCorsHeaders(env, request), \r\n                'Content-Type': 'application/problem+json',\r\n            },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Verify OTP endpoint\r\n * POST /auth/verify-otp\r\n */\r\nasync function handleVerifyOTP(request, env, customerId = null) {\r\n    try {\r\n        const body = await request.json();\r\n        const { email, otp } = body;\r\n        \r\n        // Validate input\r\n        if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\r\n            // RFC 7807 Problem Details for HTTP APIs\r\n            return new Response(JSON.stringify({ \r\n                type: 'https://tools.ietf.org/html/rfc7231#section-6.5.1',\r\n                title: 'Bad Request',\r\n                status: 400,\r\n                detail: 'Valid email address required',\r\n                instance: request.url,\r\n            }), {\r\n                status: 400,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        if (!otp || !/^\\d{6}$/.test(otp)) {\r\n            // RFC 7807 Problem Details for HTTP APIs\r\n            return new Response(JSON.stringify({ \r\n                type: 'https://tools.ietf.org/html/rfc7231#section-6.5.1',\r\n                title: 'Bad Request',\r\n                status: 400,\r\n                detail: 'Valid 6-digit OTP required',\r\n                instance: request.url,\r\n            }), {\r\n                status: 400,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        const emailHash = await hashEmail(email);\r\n        const emailLower = email.toLowerCase().trim();\r\n        \r\n        // Get latest OTP key with customer isolation\r\n        const latestOtpKey = getCustomerKey(customerId, `otp_latest_${emailHash}`);\r\n        const latestOtpKeyValue = await env.OTP_AUTH_KV.get(latestOtpKey);\r\n        \r\n        // Get client IP for statistics\r\n        const clientIP = request.headers.get('CF-Connecting-IP') || request.headers.get('X-Forwarded-For') || 'unknown';\r\n        \r\n        // Generic error message to prevent email enumeration\r\n        const genericOTPError = {\r\n            type: 'https://tools.ietf.org/html/rfc7235#section-3.1',\r\n            title: 'Unauthorized',\r\n            status: 401,\r\n            detail: 'Invalid or expired OTP code. Please request a new OTP code.',\r\n            instance: request.url,\r\n        };\r\n        \r\n        if (!latestOtpKeyValue) {\r\n            // Record failure for statistics\r\n            await recordOTPFailure(emailHash, clientIP, customerId, env);\r\n            \r\n            // Use generic error to prevent email enumeration\r\n            return new Response(JSON.stringify(genericOTPError), {\r\n                status: 401,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        // Get OTP data\r\n        const otpDataStr = await env.OTP_AUTH_KV.get(latestOtpKeyValue);\r\n        if (!otpDataStr) {\r\n            // Record failure for statistics\r\n            await recordOTPFailure(emailHash, clientIP, customerId, env);\r\n            \r\n            // Use generic error to prevent email enumeration\r\n            return new Response(JSON.stringify(genericOTPError), {\r\n                status: 401,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        let otpData;\r\n        try {\r\n            otpData = JSON.parse(otpDataStr);\r\n        } catch (e) {\r\n            // Record failure for statistics\r\n            await recordOTPFailure(emailHash, clientIP, customerId, env);\r\n            \r\n            // Use generic error to prevent email enumeration\r\n            return new Response(JSON.stringify(genericOTPError), {\r\n                status: 401,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        // Verify email matches (use constant-time comparison)\r\n        if (!constantTimeEquals(otpData.email || '', emailLower)) {\r\n            // Record failure for statistics\r\n            await recordOTPFailure(emailHash, clientIP, customerId, env);\r\n            \r\n            // Use generic error to prevent email enumeration\r\n            return new Response(JSON.stringify(genericOTPError), {\r\n                status: 401,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        // Check expiration\r\n        if (new Date(otpData.expiresAt) < new Date()) {\r\n            await env.OTP_AUTH_KV.delete(latestOtpKeyValue);\r\n            await env.OTP_AUTH_KV.delete(latestOtpKey);\r\n            \r\n            // Record failure for statistics\r\n            await recordOTPFailure(emailHash, clientIP, customerId, env);\r\n            \r\n            // Use generic error to prevent email enumeration\r\n            return new Response(JSON.stringify(genericOTPError), {\r\n                status: 401,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        // Check attempts\r\n        if (otpData.attempts >= 5) {\r\n            await env.OTP_AUTH_KV.delete(latestOtpKeyValue);\r\n            await env.OTP_AUTH_KV.delete(latestOtpKey);\r\n            \r\n            // Record failure for statistics\r\n            await recordOTPFailure(emailHash, clientIP, customerId, env);\r\n            \r\n            // RFC 7807 Problem Details for HTTP APIs\r\n            return new Response(JSON.stringify({ \r\n                type: 'https://tools.ietf.org/html/rfc6585#section-4',\r\n                title: 'Too Many Requests',\r\n                status: 429,\r\n                detail: 'Too many attempts. Please request a new OTP.',\r\n                instance: request.url,\r\n                remaining_attempts: 0,\r\n            }), {\r\n                status: 429,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        // Verify OTP using constant-time comparison to prevent timing attacks\r\n        const isValidOTP = constantTimeEquals(otpData.otp || '', otp);\r\n        \r\n        if (!isValidOTP) {\r\n            otpData.attempts++;\r\n            await env.OTP_AUTH_KV.put(latestOtpKeyValue, JSON.stringify(otpData), { expirationTtl: 600 });\r\n            \r\n            // Track failed attempt\r\n            if (customerId) {\r\n                await trackUsage(customerId, 'failedAttempts', 1, env);\r\n                \r\n                // Send webhook for failed attempt\r\n                await sendWebhook(customerId, 'otp.failed', {\r\n                    email: emailLower,\r\n                    remainingAttempts: 5 - otpData.attempts\r\n                }, env);\r\n            }\r\n            \r\n            // Record failure for statistics\r\n            await recordOTPFailure(emailHash, clientIP, customerId, env);\r\n            \r\n            // Use generic error to prevent email enumeration\r\n            return new Response(JSON.stringify({\r\n                ...genericOTPError,\r\n                remaining_attempts: 5 - otpData.attempts,\r\n            }), {\r\n                status: 401,\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/problem+json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        // OTP is valid! Delete it (single-use)\r\n        await env.OTP_AUTH_KV.delete(latestOtpKeyValue);\r\n        await env.OTP_AUTH_KV.delete(latestOtpKey);\r\n        \r\n        // Record successful OTP verification for statistics\r\n        await recordOTPRequest(emailHash, clientIP, customerId, env);\r\n        \r\n        // Track usage\r\n        if (customerId) {\r\n            await trackUsage(customerId, 'otpVerifications', 1, env);\r\n            await trackUsage(customerId, 'successfulLogins', 1, env);\r\n            \r\n            // Send webhooks\r\n            await sendWebhook(customerId, 'otp.verified', {\r\n                userId,\r\n                email: emailLower\r\n            }, env);\r\n            \r\n            // Check if new user\r\n            const wasNewUser = !user || !user.createdAt || \r\n                new Date(user.createdAt).toISOString().split('T')[0] === new Date().toISOString().split('T')[0];\r\n            \r\n            if (wasNewUser) {\r\n                await sendWebhook(customerId, 'user.created', {\r\n                    userId,\r\n                    email: emailLower\r\n                }, env);\r\n            }\r\n            \r\n            await sendWebhook(customerId, 'user.logged_in', {\r\n                userId,\r\n                email: emailLower\r\n            }, env);\r\n        }\r\n        \r\n        // Get or create user with customer isolation\r\n        const userId = await generateUserId(emailLower);\r\n        const userKey = getCustomerKey(customerId, `user_${emailHash}`);\r\n        let user = await env.OTP_AUTH_KV.get(userKey, { type: 'json' });\r\n        \r\n        if (!user) {\r\n            // Create new user\r\n            user = {\r\n                userId,\r\n                email: emailLower,\r\n                createdAt: new Date().toISOString(),\r\n                lastLogin: new Date().toISOString(),\r\n            };\r\n            await env.OTP_AUTH_KV.put(userKey, JSON.stringify(user), { expirationTtl: 31536000 }); // 1 year\r\n        } else {\r\n            // Update last login\r\n            user.lastLogin = new Date().toISOString();\r\n            await env.OTP_AUTH_KV.put(userKey, JSON.stringify(user), { expirationTtl: 31536000 });\r\n        }\r\n        \r\n        // Generate CSRF token for this session\r\n        const csrfToken = crypto.randomUUID ? crypto.randomUUID() : \r\n            Array.from(crypto.getRandomValues(new Uint8Array(16)))\r\n                .map(b => b.toString(16).padStart(2, '0')).join('');\r\n        \r\n        // Generate JWT token (7 hours expiration for security)\r\n        const expiresAt = new Date(Date.now() + 7 * 60 * 60 * 1000); // 7 hours\r\n        const expiresIn = 7 * 60 * 60; // 7 hours in seconds\r\n        const now = Math.floor(Date.now() / 1000);\r\n        \r\n        // JWT Standard Claims (RFC 7519) + OAuth 2.0 + Custom\r\n        const tokenPayload = {\r\n            // Standard JWT Claims\r\n            sub: userId, // Subject (user identifier)\r\n            iss: 'auth.idling.app', // Issuer\r\n            aud: customerId || 'default', // Audience (customer/tenant)\r\n            exp: Math.floor(expiresAt.getTime() / 1000), // Expiration time\r\n            iat: now, // Issued at\r\n            jti: crypto.randomUUID ? crypto.randomUUID() : // JWT ID (unique token identifier)\r\n                Array.from(crypto.getRandomValues(new Uint8Array(16)))\r\n                    .map(b => b.toString(16).padStart(2, '0')).join(''),\r\n            \r\n            // OAuth 2.0 / OpenID Connect Claims\r\n            email: emailLower,\r\n            email_verified: true, // OTP verification confirms email\r\n            \r\n            // Custom Claims\r\n            userId, // Backward compatibility\r\n            customerId: customerId || null, // Multi-tenant customer ID\r\n            csrf: csrfToken, // CSRF token included in JWT\r\n        };\r\n        \r\n        const jwtSecret = getJWTSecret(env);\r\n        const accessToken = await createJWT(tokenPayload, jwtSecret);\r\n        \r\n        // Store session with customer isolation\r\n        const sessionKey = getCustomerKey(customerId, `session_${userId}`);\r\n        await env.OTP_AUTH_KV.put(sessionKey, JSON.stringify({\r\n            userId,\r\n            email: emailLower,\r\n            token: await hashEmail(accessToken), // Store hash of token\r\n            expiresAt: expiresAt.toISOString(),\r\n            createdAt: new Date().toISOString(),\r\n        }), { expirationTtl: 25200 }); // 7 hours (matches token expiration)\r\n        \r\n        // OAuth 2.0 Token Response (RFC 6749 Section 5.1)\r\n        return new Response(JSON.stringify({ \r\n            // OAuth 2.0 Standard Fields\r\n            access_token: accessToken,\r\n            token_type: 'Bearer',\r\n            expires_in: expiresIn,\r\n            \r\n            // Additional Standard Fields\r\n            scope: 'openid email profile', // OIDC scopes\r\n            \r\n            // User Information (OIDC UserInfo)\r\n            sub: userId, // Subject identifier\r\n            email: emailLower,\r\n            email_verified: true,\r\n            \r\n            // Backward Compatibility (deprecated, use access_token)\r\n            token: accessToken,\r\n            userId,\r\n            expiresAt: expiresAt.toISOString(),\r\n        }), {\r\n            headers: { \r\n                ...getCorsHeaders(env, request), \r\n                'Content-Type': 'application/json',\r\n                'Cache-Control': 'no-store', // OAuth 2.0 requirement\r\n                'Pragma': 'no-cache',\r\n            },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({ \r\n            error: 'Failed to verify OTP',\r\n            message: error.message \r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Get current user endpoint\r\n * GET /auth/me\r\n */\r\nasync function handleGetMe(request, env) {\r\n    try {\r\n        const authHeader = request.headers.get('Authorization');\r\n        if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n            return new Response(JSON.stringify({ error: 'Authorization header required' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const token = authHeader.substring(7);\r\n        const jwtSecret = getJWTSecret(env);\r\n        const payload = await verifyJWT(token, jwtSecret);\r\n        \r\n        if (!payload) {\r\n            return new Response(JSON.stringify({ error: 'Invalid or expired token' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Get customer ID from token (for multi-tenant isolation)\r\n        const customerId = payload.customerId || null;\r\n        \r\n        // Get user data with customer isolation\r\n        const emailHash = await hashEmail(payload.email);\r\n        const userKey = getCustomerKey(customerId, `user_${emailHash}`);\r\n        const user = await env.OTP_AUTH_KV.get(userKey, { type: 'json' });\r\n        \r\n        if (!user) {\r\n            return new Response(JSON.stringify({ error: 'User not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // OpenID Connect UserInfo Response (RFC 7662)\r\n        return new Response(JSON.stringify({ \r\n            // Standard OIDC Claims\r\n            sub: user.userId, // Subject identifier (required)\r\n            email: user.email,\r\n            email_verified: true,\r\n            \r\n            // Additional Standard Claims\r\n            iss: 'auth.idling.app', // Issuer\r\n            aud: customerId || 'default', // Audience\r\n            \r\n            // Custom Claims (backward compatibility)\r\n            userId: user.userId,\r\n            createdAt: user.createdAt,\r\n            lastLogin: user.lastLogin,\r\n        }), {\r\n            headers: { \r\n                ...getCorsHeaders(env, request), \r\n                'Content-Type': 'application/json',\r\n                'Cache-Control': 'no-store', // OAuth 2.0 requirement\r\n                'Pragma': 'no-cache',\r\n            },\r\n        });\r\n    } catch (error) {\r\n        // RFC 7807 Problem Details for HTTP APIs\r\n        return new Response(JSON.stringify({ \r\n            type: 'https://tools.ietf.org/html/rfc7231#section-6.6.1',\r\n            title: 'Internal Server Error',\r\n            status: 500,\r\n            detail: 'Failed to get user info',\r\n            instance: request.url,\r\n        }), {\r\n            status: 500,\r\n            headers: { \r\n                ...getCorsHeaders(env, request), \r\n                'Content-Type': 'application/problem+json',\r\n            },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Get quota and usage information\r\n * GET /auth/quota\r\n */\r\nasync function handleGetQuota(request, env) {\r\n    try {\r\n        const authHeader = request.headers.get('Authorization');\r\n        if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n            return new Response(JSON.stringify({ error: 'Authorization header required' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const token = authHeader.substring(7);\r\n        const jwtSecret = getJWTSecret(env);\r\n        const payload = await verifyJWT(token, jwtSecret);\r\n        \r\n        if (!payload) {\r\n            return new Response(JSON.stringify({ error: 'Invalid or expired token' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Get customer ID from token (for multi-tenant isolation)\r\n        const customerId = payload.customerId || null;\r\n        \r\n        // Get quota information\r\n        const quotaInfo = await checkQuota(customerId, env);\r\n        \r\n        if (!quotaInfo.allowed && !quotaInfo.quota) {\r\n            // If quota check failed but no quota info, return basic structure\r\n            return new Response(JSON.stringify({\r\n                success: true,\r\n                quota: {\r\n                    otpRequestsPerDay: 1000,\r\n                    otpRequestsPerMonth: 10000\r\n                },\r\n                usage: {\r\n                    daily: 0,\r\n                    monthly: 0,\r\n                    remainingDaily: 1000,\r\n                    remainingMonthly: 10000\r\n                }\r\n            }), {\r\n                headers: { \r\n                    ...getCorsHeaders(env, request), \r\n                    'Content-Type': 'application/json',\r\n                },\r\n            });\r\n        }\r\n        \r\n        return new Response(JSON.stringify({\r\n            success: true,\r\n            quota: quotaInfo.quota || {\r\n                otpRequestsPerDay: 1000,\r\n                otpRequestsPerMonth: 10000\r\n            },\r\n            usage: quotaInfo.usage || {\r\n                daily: 0,\r\n                monthly: 0,\r\n                remainingDaily: 1000,\r\n                remainingMonthly: 10000\r\n            }\r\n        }), {\r\n            headers: { \r\n                ...getCorsHeaders(env, request), \r\n                'Content-Type': 'application/json',\r\n            },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({ \r\n            error: 'Failed to get quota information',\r\n            message: error.message \r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Logout endpoint\r\n * POST /auth/logout\r\n */\r\nasync function handleLogout(request, env) {\r\n    try {\r\n        const authHeader = request.headers.get('Authorization');\r\n        if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n            return new Response(JSON.stringify({ error: 'Authorization header required' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const token = authHeader.substring(7);\r\n        const jwtSecret = getJWTSecret(env);\r\n        const payload = await verifyJWT(token, jwtSecret);\r\n        \r\n        if (!payload) {\r\n            return new Response(JSON.stringify({ error: 'Invalid or expired token' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Get customer ID from token\r\n        const customerId = payload.customerId || null;\r\n        \r\n        // Add token to blacklist with customer isolation\r\n        const tokenHash = await hashEmail(token);\r\n        const blacklistKey = getCustomerKey(customerId, `blacklist_${tokenHash}`);\r\n        await env.OTP_AUTH_KV.put(blacklistKey, JSON.stringify({\r\n            token: tokenHash,\r\n            revokedAt: new Date().toISOString(),\r\n        }), { expirationTtl: 25200 }); // 7 hours (matches token expiration)\r\n        \r\n        // Delete session with customer isolation\r\n        const sessionKey = getCustomerKey(customerId, `session_${payload.userId}`);\r\n        await env.OTP_AUTH_KV.delete(sessionKey);\r\n        \r\n        return new Response(JSON.stringify({ \r\n            success: true,\r\n            message: 'Logged out successfully'\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({ \r\n            error: 'Failed to logout',\r\n            message: error.message \r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Refresh token endpoint\r\n * POST /auth/refresh\r\n */\r\nasync function handleRefresh(request, env) {\r\n    try {\r\n        const body = await request.json();\r\n        const { token } = body;\r\n        \r\n        if (!token) {\r\n            return new Response(JSON.stringify({ error: 'Token required' }), {\r\n                status: 400,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        const jwtSecret = getJWTSecret(env);\r\n        const payload = await verifyJWT(token, jwtSecret);\r\n        \r\n        if (!payload) {\r\n            return new Response(JSON.stringify({ error: 'Invalid or expired token' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Get customer ID from token\r\n        const customerId = payload.customerId || null;\r\n        \r\n        // Check if token is blacklisted with customer isolation\r\n        const tokenHash = await hashEmail(token);\r\n        const blacklistKey = getCustomerKey(customerId, `blacklist_${tokenHash}`);\r\n        const blacklisted = await env.OTP_AUTH_KV.get(blacklistKey);\r\n        if (blacklisted) {\r\n            return new Response(JSON.stringify({ error: 'Token has been revoked' }), {\r\n                status: 401,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        }\r\n        \r\n        // Generate new CSRF token for refreshed session\r\n        const newCsrfToken = crypto.randomUUID ? crypto.randomUUID() : \r\n            Array.from(crypto.getRandomValues(new Uint8Array(16)))\r\n                .map(b => b.toString(16).padStart(2, '0')).join('');\r\n        \r\n        // Generate new token (7 hours expiration)\r\n        const expiresAt = new Date(Date.now() + 7 * 60 * 60 * 1000); // 7 hours\r\n        const newTokenPayload = {\r\n            userId: payload.userId,\r\n            email: payload.email,\r\n            customerId: customerId, // Preserve customer ID\r\n            csrf: newCsrfToken, // New CSRF token for refreshed session\r\n            exp: Math.floor(expiresAt.getTime() / 1000),\r\n            iat: Math.floor(Date.now() / 1000),\r\n        };\r\n        \r\n        const newToken = await createJWT(newTokenPayload, jwtSecret);\r\n        \r\n        // Update session with customer isolation\r\n        const sessionKey = getCustomerKey(customerId, `session_${payload.userId}`);\r\n        await env.OTP_AUTH_KV.put(sessionKey, JSON.stringify({\r\n            userId: payload.userId,\r\n            email: payload.email,\r\n            token: await hashEmail(newToken),\r\n            expiresAt: expiresAt.toISOString(),\r\n            createdAt: new Date().toISOString(),\r\n        }), { expirationTtl: 25200 }); // 7 hours\r\n        \r\n        return new Response(JSON.stringify({ \r\n            success: true,\r\n            token: newToken,\r\n            expiresAt: expiresAt.toISOString(),\r\n        }), {\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    } catch (error) {\r\n        return new Response(JSON.stringify({ \r\n            error: 'Failed to refresh token',\r\n            message: error.message \r\n        }), {\r\n            status: 500,\r\n            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Authenticate request using API key\r\n * @param {Request} request - HTTP request\r\n * @param {*} env - Worker environment\r\n * @returns {Promise<{customerId: string, keyId: string}|null>} Customer info or null if not authenticated\r\n */\r\nasync function authenticateRequest(request, env) {\r\n    // Try Authorization header first\r\n    const authHeader = request.headers.get('Authorization');\r\n    let apiKey = null;\r\n    \r\n    if (authHeader && authHeader.startsWith('Bearer ')) {\r\n        apiKey = authHeader.substring(7);\r\n    } else {\r\n        // Try X-OTP-API-Key header as alternative\r\n        apiKey = request.headers.get('X-OTP-API-Key');\r\n    }\r\n    \r\n    if (!apiKey) {\r\n        return null;\r\n    }\r\n    \r\n    // Verify API key\r\n    const authResult = await verifyApiKey(apiKey, env);\r\n    return authResult;\r\n}\r\n\r\n// logSecurityEvent is imported from services/security.js\r\n\r\n/**\r\n * Handle landing page request\r\n * Serves the landing page HTML at root path\r\n */\r\nasync function handleLandingPage(request, env) {\r\n    return new Response(landingHtml, {\r\n        headers: {\r\n            'Content-Type': 'text/html; charset=utf-8',\r\n            'Cache-Control': 'public, max-age=3600',\r\n        },\r\n    });\r\n}\r\n\r\n/**\r\n * Main request handler\r\n */\r\nexport default {\r\n    async fetch(request, env, ctx) {\r\n        const startTime = performance.now();\r\n        const url = new URL(request.url);\r\n        const path = url.pathname;\r\n        let customerId = null;\r\n        let endpoint = path.split('/').pop() || 'unknown';\r\n        \r\n        // Handle CORS preflight\r\n        if (request.method === 'OPTIONS') {\r\n            return new Response(null, {\r\n                headers: getCorsHeaders(env, request),\r\n            });\r\n        }\r\n        \r\n        try {\r\n            // Serve landing page at root\r\n            if ((path === '/' || path === '') && request.method === 'GET') {\r\n                return handleLandingPage(request, env);\r\n            }\r\n            \r\n            // Serve OpenAPI spec\r\n            if (path === '/openapi.json' && request.method === 'GET') {\r\n                try {\r\n                    return new Response(JSON.stringify(openApiSpec, null, 2), {\r\n                        headers: {\r\n                            'Content-Type': 'application/json',\r\n                            'Cache-Control': 'public, max-age=3600',\r\n                            ...getCorsHeaders(env, request),\r\n                        },\r\n                    });\r\n                } catch (error) {\r\n                    return new Response(JSON.stringify({ error: 'Failed to load OpenAPI spec' }), {\r\n                        status: 500,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n            }\r\n            \r\n            // Serve dashboard (SPA - all routes serve index.html)\r\n            if (path.startsWith('/dashboard') && request.method === 'GET') {\r\n                // For now, redirect to dashboard setup instructions\r\n                // TODO: After building dashboard (pnpm build in dashboard/), embed the built files here\r\n                if (path === '/dashboard' || path === '/dashboard/') {\r\n                    return new Response(`\r\n                        <!DOCTYPE html>\r\n                        <html>\r\n                        <head>\r\n                            <title>Dashboard - Setup Required</title>\r\n                            <style>\r\n                                body { font-family: system-ui; background: #1a1611; color: #f9f9f9; padding: 2rem; }\r\n                                .container { max-width: 800px; margin: 0 auto; }\r\n                                code { background: #252017; padding: 0.2rem 0.4rem; border-radius: 4px; }\r\n                            </style>\r\n                        </head>\r\n                        <body>\r\n                            <div class=\"container\">\r\n                                <h1>\uD83D\uDD27 Dashboard Setup Required</h1>\r\n                                <p>The developer dashboard needs to be built and integrated.</p>\r\n                                <h2>Steps:</h2>\r\n                                <ol>\r\n                                    <li>Navigate to <code>serverless/otp-auth-service/dashboard</code></li>\r\n                                    <li>Run <code>pnpm build</code> to build the dashboard</li>\r\n                                    <li>The built files will be in <code>dashboard/dist/</code></li>\r\n                                    <li>Update <code>worker.js</code> to serve the built dashboard files</li>\r\n                                </ol>\r\n                                <p><strong>Note:</strong> The dashboard is a Svelte + TypeScript SPA that needs to be built before serving.</p>\r\n                            </div>\r\n                        </body>\r\n                        </html>\r\n                    `, {\r\n                        headers: {\r\n                            'Content-Type': 'text/html; charset=utf-8',\r\n                            ...getCorsHeaders(env, request),\r\n                        },\r\n                    });\r\n                }\r\n                // For other dashboard paths, return 404 for now\r\n                return new Response('Dashboard not yet built. Please build the dashboard first.', {\r\n                    status: 404,\r\n                    headers: getCorsHeaders(env, request),\r\n                });\r\n            }\r\n            \r\n            // Public endpoints (no auth required)\r\n            if (path === '/signup' && request.method === 'POST') {\r\n                return handlePublicSignup(request, env);\r\n            }\r\n            \r\n            if (path === '/signup/verify' && request.method === 'POST') {\r\n                return handleVerifySignup(request, env);\r\n            }\r\n            \r\n            if (path === '/admin/customers' && request.method === 'POST') {\r\n                return handleRegisterCustomer(request, env);\r\n            }\r\n            \r\n            if (path === '/health' && request.method === 'GET') {\r\n                try {\r\n                    // Check KV access\r\n                    await env.OTP_AUTH_KV.get('health_check', { type: 'text' });\r\n                    \r\n                    // Validate secrets (but don't fail health check, just warn)\r\n                    const secretValidation = validateSecrets(env);\r\n                    \r\n                    const healthStatus = {\r\n                        status: secretValidation.valid ? 'healthy' : 'degraded',\r\n                        service: 'otp-auth-service',\r\n                        version: '2.0.0',\r\n                        timestamp: new Date().toISOString()\r\n                    };\r\n                    \r\n                    if (!secretValidation.valid) {\r\n                        healthStatus.warnings = {\r\n                            missing_secrets: secretValidation.missing,\r\n                            message: `Required secrets not configured: ${secretValidation.missing.join(', ')}. Set them via: wrangler secret put <SECRET_NAME>`\r\n                        };\r\n                    }\r\n                    \r\n                    if (secretValidation.warnings.length > 0) {\r\n                        healthStatus.warnings = healthStatus.warnings || {};\r\n                        healthStatus.warnings.recommended = secretValidation.warnings;\r\n                    }\r\n                    \r\n                    return new Response(JSON.stringify(healthStatus), {\r\n                        status: secretValidation.valid ? 200 : 503,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                } catch (error) {\r\n                    return new Response(JSON.stringify({ \r\n                        status: 'unhealthy',\r\n                        service: 'otp-auth-service',\r\n                        error: 'KV check failed',\r\n                        details: env.ENVIRONMENT === 'development' ? error.message : undefined\r\n                    }), {\r\n                        status: 503,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n            }\r\n            \r\n            if (path === '/health/ready' && request.method === 'GET') {\r\n                try {\r\n                    // Check KV access\r\n                    await env.OTP_AUTH_KV.get('health_check', { type: 'text' });\r\n                    \r\n                    // Validate required secrets\r\n                    const secretValidation = validateSecrets(env);\r\n                    \r\n                    if (!secretValidation.valid) {\r\n                        return new Response(JSON.stringify({ \r\n                            status: 'not_ready',\r\n                            reason: 'missing_secrets',\r\n                            missing: secretValidation.missing,\r\n                            warnings: secretValidation.warnings,\r\n                            message: `Required secrets not configured: ${secretValidation.missing.join(', ')}. Set them via: wrangler secret put <SECRET_NAME>`\r\n                        }), {\r\n                            status: 503,\r\n                            headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                        });\r\n                    }\r\n                    \r\n                    return new Response(JSON.stringify({ \r\n                        status: 'ready',\r\n                        warnings: secretValidation.warnings.length > 0 ? secretValidation.warnings : undefined\r\n                    }), {\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                } catch (error) {\r\n                    return new Response(JSON.stringify({ \r\n                        status: 'not_ready',\r\n                        reason: 'kv_check_failed',\r\n                        error: env.ENVIRONMENT === 'development' ? error.message : undefined\r\n                    }), {\r\n                        status: 503,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n            }\r\n            \r\n            if (path === '/health/live' && request.method === 'GET') {\r\n                return new Response(JSON.stringify({ status: 'alive' }), {\r\n                    headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                });\r\n            }\r\n            \r\n            // Customer admin endpoints (require API key auth)\r\n            if (path === '/admin/customers/me' && request.method === 'GET') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleAdminGetMe(request, env, auth.customerId);\r\n            }\r\n            \r\n            if (path === '/admin/customers/me' && request.method === 'PUT') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleUpdateMe(request, env, auth.customerId);\r\n            }\r\n            \r\n            // Domain verification endpoints (require API key auth)\r\n            if (path === '/admin/domains/verify' && request.method === 'POST') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleRequestDomainVerification(request, env, auth.customerId);\r\n            }\r\n            \r\n            const domainStatusMatch = path.match(/^\\/admin\\/domains\\/([^\\/]+)\\/status$/);\r\n            if (domainStatusMatch && request.method === 'GET') {\r\n                const domain = domainStatusMatch[1];\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleGetDomainStatus(request, env, domain);\r\n            }\r\n            \r\n            const domainVerifyMatch = path.match(/^\\/admin\\/domains\\/([^\\/]+)\\/verify$/);\r\n            if (domainVerifyMatch && request.method === 'POST') {\r\n                const domain = domainVerifyMatch[1];\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleVerifyDomain(request, env, auth.customerId, domain);\r\n            }\r\n            \r\n            // Analytics endpoints (require API key auth)\r\n            if (path === '/admin/analytics' && request.method === 'GET') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleGetAnalytics(request, env, auth.customerId);\r\n            }\r\n            \r\n            if (path === '/admin/analytics/realtime' && request.method === 'GET') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleGetRealtimeAnalytics(request, env, auth.customerId);\r\n            }\r\n            \r\n            if (path === '/admin/analytics/errors' && request.method === 'GET') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleGetErrorAnalytics(request, env, auth.customerId);\r\n            }\r\n            \r\n            // Onboarding endpoints (require API key auth)\r\n            if (path === '/admin/onboarding' && request.method === 'GET') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleGetOnboarding(request, env, auth.customerId);\r\n            }\r\n            \r\n            if (path === '/admin/onboarding' && request.method === 'PUT') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleUpdateOnboarding(request, env, auth.customerId);\r\n            }\r\n            \r\n            if (path === '/admin/onboarding/test-otp' && request.method === 'POST') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleTestOTP(request, env, auth.customerId);\r\n            }\r\n            \r\n            // GDPR endpoints (require API key auth)\r\n            const exportUserMatch = path.match(/^\\/admin\\/users\\/([^\\/]+)\\/export$/);\r\n            if (exportUserMatch && request.method === 'GET') {\r\n                const userId = exportUserMatch[1];\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleExportUserData(request, env, auth.customerId, userId);\r\n            }\r\n            \r\n            const deleteUserMatch = path.match(/^\\/admin\\/users\\/([^\\/]+)$/);\r\n            if (deleteUserMatch && request.method === 'DELETE') {\r\n                const userId = deleteUserMatch[1];\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleDeleteUserData(request, env, auth.customerId, userId);\r\n            }\r\n            \r\n            // Audit logs endpoint (require API key auth)\r\n            if (path === '/admin/audit-logs' && request.method === 'GET') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleGetAuditLogs(request, env, auth.customerId);\r\n            }\r\n            \r\n            // Configuration endpoints (require API key auth)\r\n            if (path === '/admin/config' && request.method === 'GET') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleGetConfig(request, env, auth.customerId);\r\n            }\r\n            \r\n            if (path === '/admin/config' && request.method === 'PUT') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleUpdateConfig(request, env, auth.customerId);\r\n            }\r\n            \r\n            if (path === '/admin/config/email' && request.method === 'PUT') {\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleUpdateEmailConfig(request, env, auth.customerId);\r\n            }\r\n            \r\n            // API key management endpoints (require API key auth)\r\n            const customerApiKeysMatch = path.match(/^\\/admin\\/customers\\/([^\\/]+)\\/api-keys$/);\r\n            if (customerApiKeysMatch) {\r\n                const pathCustomerId = customerApiKeysMatch[1];\r\n                \r\n                // Authenticate request\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                \r\n                // Verify customer ID matches (prevent access to other customers' keys)\r\n                if (auth.customerId !== pathCustomerId) {\r\n                    return new Response(JSON.stringify({ error: 'Forbidden' }), {\r\n                        status: 403,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                \r\n                if (request.method === 'GET') {\r\n                    return handleListApiKeys(request, env, auth.customerId);\r\n                }\r\n                if (request.method === 'POST') {\r\n                    return handleCreateApiKey(request, env, auth.customerId);\r\n                }\r\n            }\r\n            \r\n            const revokeApiKeyMatch = path.match(/^\\/admin\\/customers\\/([^\\/]+)\\/api-keys\\/([^\\/]+)$/);\r\n            if (revokeApiKeyMatch && request.method === 'DELETE') {\r\n                const pathCustomerId = revokeApiKeyMatch[1];\r\n                const keyId = revokeApiKeyMatch[2];\r\n                \r\n                // Authenticate request\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                \r\n                // Verify customer ID matches\r\n                if (auth.customerId !== pathCustomerId) {\r\n                    return new Response(JSON.stringify({ error: 'Forbidden' }), {\r\n                        status: 403,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                \r\n                return handleRevokeApiKey(request, env, auth.customerId, keyId);\r\n            }\r\n            \r\n            const rotateApiKeyMatch = path.match(/^\\/admin\\/customers\\/([^\\/]+)\\/api-keys\\/([^\\/]+)\\/rotate$/);\r\n            if (rotateApiKeyMatch && request.method === 'POST') {\r\n                const pathCustomerId = rotateApiKeyMatch[1];\r\n                const keyId = rotateApiKeyMatch[2];\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                if (auth.customerId !== pathCustomerId) {\r\n                    return new Response(JSON.stringify({ error: 'Forbidden' }), {\r\n                        status: 403,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleRotateApiKey(request, env, auth.customerId, keyId);\r\n            }\r\n            \r\n            // Customer status management endpoints (require API key auth)\r\n            const suspendCustomerMatch = path.match(/^\\/admin\\/customers\\/([^\\/]+)\\/suspend$/);\r\n            if (suspendCustomerMatch && request.method === 'POST') {\r\n                const pathCustomerId = suspendCustomerMatch[1];\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                // Note: In production, only admins should be able to suspend customers\r\n                // For now, allow customer to suspend themselves (for testing)\r\n                return handleSuspendCustomer(request, env, pathCustomerId);\r\n            }\r\n            \r\n            const activateCustomerMatch = path.match(/^\\/admin\\/customers\\/([^\\/]+)\\/activate$/);\r\n            if (activateCustomerMatch && request.method === 'POST') {\r\n                const pathCustomerId = activateCustomerMatch[1];\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                // Note: In production, only admins should be able to activate customers\r\n                return handleActivateCustomer(request, env, pathCustomerId);\r\n            }\r\n            \r\n            const updateStatusMatch = path.match(/^\\/admin\\/customers\\/([^\\/]+)\\/status$/);\r\n            if (updateStatusMatch && request.method === 'PUT') {\r\n                const pathCustomerId = updateStatusMatch[1];\r\n                const auth = await authenticateRequest(request, env);\r\n                if (!auth) {\r\n                    return new Response(JSON.stringify({ error: 'Authentication required' }), {\r\n                        status: 401,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                const body = await request.json();\r\n                const { status } = body;\r\n                if (!status) {\r\n                    return new Response(JSON.stringify({ error: 'Status required' }), {\r\n                        status: 400,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                return handleUpdateCustomerStatus(request, env, pathCustomerId, status);\r\n            }\r\n            \r\n            // Authentication endpoints (require API key for multi-tenant)\r\n            // For backward compatibility, allow requests without API key (customerId will be null)\r\n            let customer = null;\r\n            const auth = await authenticateRequest(request, env);\r\n            if (auth) {\r\n                customerId = auth.customerId;\r\n                customer = await getCustomerCached(customerId, env);\r\n                \r\n                // Check IP allowlist\r\n                const clientIP = request.headers.get('CF-Connecting-IP') || request.headers.get('X-Forwarded-For') || 'unknown';\r\n                const ipAllowed = await checkIPAllowlist(customerId, clientIP, env);\r\n                \r\n                if (!ipAllowed) {\r\n                    await logSecurityEvent(customerId, 'ip_blocked', {\r\n                        ip: clientIP,\r\n                        endpoint: path,\r\n                        method: request.method\r\n                    }, env);\r\n                    \r\n                    return new Response(JSON.stringify({ error: 'IP address not allowed' }), {\r\n                        status: 403,\r\n                        headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n                    });\r\n                }\r\n                \r\n                // Log API key authentication\r\n                await logSecurityEvent(customerId, 'api_key_auth', {\r\n                    keyId: auth.keyId,\r\n                    endpoint: path,\r\n                    method: request.method,\r\n                    ip: clientIP\r\n                }, env);\r\n            } else if (path.startsWith('/auth/') || path.startsWith('/admin/')) {\r\n                // Log failed authentication attempt\r\n                const clientIP = request.headers.get('CF-Connecting-IP') || request.headers.get('X-Forwarded-For') || 'unknown';\r\n                await logSecurityEvent(null, 'auth_failed', {\r\n                    endpoint: path,\r\n                    method: request.method,\r\n                    ip: clientIP\r\n                }, env);\r\n            }\r\n            \r\n            // Attach customerId to request context by wrapping handlers\r\n            if (path === '/auth/request-otp' && request.method === 'POST') {\r\n                // Inject customerId into handler\r\n                const originalHandler = handleRequestOTP;\r\n                return originalHandler(request, env, customerId);\r\n            }\r\n            if (path === '/auth/verify-otp' && request.method === 'POST') {\r\n                const originalHandler = handleVerifyOTP;\r\n                return originalHandler(request, env, customerId);\r\n            }\r\n            if (path === '/auth/me' && request.method === 'GET') {\r\n                return handleGetMe(request, env);\r\n            }\r\n            if (path === '/auth/quota' && request.method === 'GET') {\r\n                return handleGetQuota(request, env);\r\n            }\r\n            if (path === '/auth/logout' && request.method === 'POST') {\r\n                return handleLogout(request, env);\r\n            }\r\n            if (path === '/auth/refresh' && request.method === 'POST') {\r\n                return handleRefresh(request, env);\r\n            }\r\n            \r\n            // 404 for unknown routes\r\n            return new Response(JSON.stringify({ error: 'Not found' }), {\r\n                status: 404,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n        } catch (error) {\r\n            console.error('Request handler error:', error);\r\n            \r\n            // Track error\r\n            if (customerId) {\r\n                await trackError(customerId, 'internal', error.message, endpoint, env);\r\n                // Check error rate after tracking\r\n                await checkErrorRateAlert(customerId, env);\r\n            }\r\n            \r\n            const errorResponse = new Response(JSON.stringify({ \r\n                error: 'Internal server error',\r\n                message: env.ENVIRONMENT === 'development' ? error.message : undefined\r\n            }), {\r\n                status: 500,\r\n                headers: { ...getCorsHeaders(env, request), 'Content-Type': 'application/json' },\r\n            });\r\n            \r\n            // Track response time even for errors\r\n            const responseTime = performance.now() - startTime;\r\n            if (customerId) {\r\n                await trackResponseTime(customerId, endpoint, responseTime, env);\r\n            }\r\n            \r\n            return errorResponse;\r\n        } finally {\r\n            // Track response time\r\n            const responseTime = performance.now() - startTime;\r\n            if (customerId && path.startsWith('/auth/')) {\r\n                await trackResponseTime(customerId, endpoint, responseTime, env);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\mamop\\\\Documents\\\\source fade script plugin\\\\serverless\\\\otp-auth-service\\\\worker.js\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\mamop\\\\Documents\\\\source fade script plugin\\\\node_modules\\\\.pnpm\\\\wrangler@4.56.0\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\mamop\\\\Documents\\\\source fade script plugin\\\\node_modules\\\\.pnpm\\\\wrangler@4.56.0\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\mamop\\\\Documents\\\\source fade script plugin\\\\serverless\\\\otp-auth-service\\\\worker.js\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\mamop\\\\Documents\\\\source fade script plugin\\\\serverless\\\\otp-auth-service\\\\.wrangler\\\\tmp\\\\bundle-zPZknG\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\mamop\\\\Documents\\\\source fade script plugin\\\\node_modules\\\\.pnpm\\\\wrangler@4.56.0\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\mamop\\\\Documents\\\\source fade script plugin\\\\serverless\\\\otp-auth-service\\\\.wrangler\\\\tmp\\\\bundle-zPZknG\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"C:\\\\Users\\\\mamop\\\\Documents\\\\source fade script plugin\\\\serverless\\\\otp-auth-service\\\\.wrangler\\\\tmp\\\\bundle-zPZknG\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": ";;;;AAAA,IAAM,OAAO,oBAAI,IAAI;AAErB,SAAS,SAAS,SAAS,MAAM;AAChC,QAAM,MACL,mBAAmB,MAChB,UACA,IAAI;AAAA,KACH,OAAO,YAAY,WACjB,IAAI,QAAQ,SAAS,IAAI,IACzB,SACD;AAAA,EACH;AACH,MAAI,IAAI,QAAQ,IAAI,SAAS,SAAS,IAAI,aAAa,UAAU;AAChE,QAAI,CAAC,KAAK,IAAI,IAAI,SAAS,CAAC,GAAG;AAC9B,WAAK,IAAI,IAAI,SAAS,CAAC;AACvB,cAAQ;AAAA,QACP;AAAA,KACO,IAAI,SAAS,CAAC;AAAA;AAAA,MACtB;AAAA,IACD;AAAA,EACD;AACD;AAnBS;AAqBT,WAAW,QAAQ,IAAI,MAAM,WAAW,OAAO;AAAA,EAC9C,MAAM,QAAQ,SAAS,UAAU;AAChC,UAAM,CAAC,SAAS,IAAI,IAAI;AACxB,aAAS,SAAS,IAAI;AACtB,WAAO,QAAQ,MAAM,QAAQ,SAAS,QAAQ;AAAA,EAC/C;AACD,CAAC;;;ACvBD,IAAO,uBAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACFf,IAAO,uBAAQ,KAAK,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;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",
  "names": ["generateApiKey", "generateApiKey", "resetAt", "getCustomerCached", "invalidateCustomerCache", "getCorsHeaders", "generateOTP", "hashEmail", "generateUserId", "createJWT", "verifyJWT", "getJWTSecret", "hashPassword", "constantTimeEquals", "checkOTPRateLimit", "recordOTPRequest", "recordOTPFailure", "renderEmailTemplate", "getDefaultEmailTemplate", "getDefaultTextTemplate", "getEmailProvider", "getCustomerCached", "getCorsHeaders", "hashEmail", "generateOTP", "hashPassword", "getPlanLimits", "invalidateCustomerCache", "checkQuota", "checkOTPRateLimit", "recordOTPFailure", "recordOTPRequest", "constantTimeEquals", "generateUserId", "getJWTSecret", "createJWT", "verifyJWT", "auth"]
}
