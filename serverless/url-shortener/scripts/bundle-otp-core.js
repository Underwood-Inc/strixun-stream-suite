/**
 * Bundle OTP Login Core for Browser Use
 * 
 * Bundles the shared OtpLoginCore for use in the Svelte app
 * Similar to bundle-decrypt.js but for OTP authentication
 */

import { build } from 'esbuild';
import { readFileSync, writeFileSync, mkdirSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const projectRoot = join(__dirname, '../../..');
const corePath = join(projectRoot, 'shared-components/otp-login/core.ts');
const outputFile = join(__dirname, '../dist/otp-core.js');
const outputTsFile = join(__dirname, '../dist/otp-core-script.ts');

// Ensure dist directory exists
mkdirSync(join(__dirname, '../dist'), { recursive: true });

try {
  await build({
    entryPoints: [corePath],
    bundle: true,
    outfile: outputFile,
    format: 'iife',
    globalName: 'OtpLoginCoreLib',
    platform: 'browser',
    target: 'es2020',
    minify: false, // Keep readable for debugging
    sourcemap: false,
    define: {
      'process.env.NODE_ENV': '"production"',
    },
    banner: {
      js: '// Bundled OtpLoginCore from shared-components/otp-login/core.ts\n// This file is auto-generated - do not edit manually\n',
    },
  });

  // Read the bundled file and wrap it to expose to window
  const bundled = readFileSync(outputFile, 'utf-8');
  const wrapped = `(function() {
  'use strict';
  ${bundled}
  // Expose OtpLoginCore to window
  if (typeof window !== 'undefined' && typeof OtpLoginCoreLib !== 'undefined') {
    window.OtpLoginCore = OtpLoginCoreLib.OtpLoginCore || (() => {
      throw new Error('OtpLoginCore not found in bundle');
    });
  }
})();`;

  writeFileSync(outputFile, wrapped);
  
  // Also create a TypeScript file that exports the bundled script as a string constant
  // This allows the worker to import it at build time
  const tsContent = `/**
 * Bundled OtpLoginCore script
 * 
 * This file is auto-generated by scripts/bundle-otp-core.js
 * Do not edit manually - it will be overwritten on build
 */

export const BUNDLED_OTP_CORE_SCRIPT = ${JSON.stringify(wrapped)};
`;

  writeFileSync(outputTsFile, tsContent);
  console.log(`[SUCCESS] Bundled OtpLoginCore to ${outputFile}`);
  console.log(`[SUCCESS] Created TypeScript export at ${outputTsFile}`);
} catch (error) {
  console.error('[ERROR] Failed to bundle OtpLoginCore:', error);
  process.exit(1);
}
