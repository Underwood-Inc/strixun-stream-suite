/**
 * Bundle OTP Login Svelte Component for Worker
 * 
 * Reads the pre-built Svelte component bundle and creates a TypeScript export
 * that can be imported by the Cloudflare Worker at build time
 */

import { readFileSync, writeFileSync, mkdirSync, existsSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const projectRoot = join(__dirname, '../../..');
const svelteBundlePath = join(projectRoot, 'shared-components/otp-login/dist/otp-login-svelte.js');
const outputTsFile = join(__dirname, '../dist/otp-login-svelte-script.ts');

// Ensure dist directory exists
mkdirSync(join(__dirname, '../dist'), { recursive: true });

try {
  // Check if the Svelte bundle exists
  if (!existsSync(svelteBundlePath)) {
    console.error(`[ERROR] Svelte bundle not found at: ${svelteBundlePath}`);
    console.error('   Please run: pnpm --filter @strixun/otp-login build:svelte');
    process.exit(1);
  }

  // Read the bundled Svelte component
  const bundled = readFileSync(svelteBundlePath, 'utf-8');

  // Create a TypeScript file that exports the bundled script as a string constant
  // This allows the worker to import it at build time
  const tsContent = `/**
 * Bundled OtpLogin Svelte component script
 * 
 * This file is auto-generated by scripts/bundle-otp-login-svelte.js
 * Do not edit manually - it will be overwritten on build
 */

export const BUNDLED_OTP_LOGIN_SVELTE_SCRIPT = ${JSON.stringify(bundled)};
`;

  writeFileSync(outputTsFile, tsContent);
  console.log(`[SUCCESS] Created TypeScript export at ${outputTsFile}`);
} catch (error) {
  console.error('[ERROR] Failed to bundle OtpLogin Svelte component:', error);
  process.exit(1);
}

