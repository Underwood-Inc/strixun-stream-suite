/**
 * Bundle decryptWithJWT for browser use
 * 
 * Bundles the actual shared library code into a browser-compatible script
 */

import { build } from 'esbuild';
import { readFileSync, writeFileSync, mkdirSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const entryPoint = join(__dirname, 'decrypt-entry.ts');
const outputFile = join(__dirname, '../dist/decrypt.js');
const outputTsFile = join(__dirname, '../dist/decrypt-script.ts');

// Ensure dist directory exists
mkdirSync(join(__dirname, '../dist'), { recursive: true });

try {
  await build({
    entryPoints: [entryPoint],
    bundle: true,
    outfile: outputFile,
    format: 'iife',
    globalName: 'DecryptLib',
    platform: 'browser',
    target: 'es2020',
    minify: true,
    sourcemap: false,
    banner: {
      js: '// Bundled decryptWithJWT from @strixun/api-framework\n// This file is auto-generated - do not edit manually\n',
    },
  });

  // Read the bundled file and wrap it to expose to window
  const bundled = readFileSync(outputFile, 'utf-8');
  const wrapped = `(function() {
  'use strict';
  ${bundled}
  // Expose decryptWithJWT to window
  if (typeof window !== 'undefined' && typeof DecryptLib !== 'undefined') {
    window.decryptWithJWT = DecryptLib.decryptWithJWT || (() => {
      throw new Error('decryptWithJWT not found in bundle');
    });
  }
})();`;

  writeFileSync(outputFile, wrapped);
  
  // Also create a TypeScript file that exports the bundled script as a string constant
  // This allows the worker to import it at build time
  const tsContent = `/**
 * Bundled decryptWithJWT script
 * 
 * This file is auto-generated by scripts/bundle-decrypt.js
 * Do not edit manually - it will be overwritten on build
 */

export const BUNDLED_DECRYPT_SCRIPT = ${JSON.stringify(wrapped)};
`;

  writeFileSync(outputTsFile, tsContent);
  console.log(`✓ Bundled decryptWithJWT to ${outputFile}`);
  console.log(`✓ Created TypeScript export at ${outputTsFile}`);
} catch (error) {
  console.error('✗ Failed to bundle decryptWithJWT:', error);
  process.exit(1);
}

